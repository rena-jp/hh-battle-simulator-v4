// ==UserScript==
// @name         Hentai Heroes Battle Simulator v4
// @namespace    https://github.com/rena-jp/hh-battle-simulator-v4
// @version      4.10.4
// @description  Add a battle simulator to Hentai Heroes and related games
// @author       rena
// @match        https://*.hentaiheroes.com/*
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @grant        none
// @run-at       document-body
// @updateURL    https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.meta.js
// @downloadURL  https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.user.js
// ==/UserScript==

(()=>{"use strict";const e=new Promise((e=>{const t=()=>{null!=window.$&&e()};"loading"===document.readyState?window.addEventListener("DOMContentLoaded",t,!0):t()})),t=new Promise((t=>{e.then((()=>{queueMicrotask(t)}))})),n=new Promise((e=>{t.then((()=>{$(e)}))}));function a(){return e}function o(){return t}function s(){return n}function r(e,t){const{team:n}=e,{girls:a}=n,o=Object.fromEntries(n.synergies.map((e=>[e.element.type,e.bonus_multiplier])));let s=.3*e.chance/(e.chance+t.chance);s+=o.stone;const r=["darkness","light","psychic"],l=t.team.theme;n.theme_elements.forEach((e=>{r.includes(e.type)&&l.includes(e.domination)&&(s+=.2)}));const i=e=>a.map((t=>t.skills[e]?.skill.percentage_value??0)).reduce(((e,t)=>e+t),0)/100,c=a[0]?.skills,u=(e,t)=>{const n=e?.[t]?.skill;return null==n?0:(n.percentage_value??parseFloat(n.display_value_text??0))/100},m=e=>u(c,e),d=Math.ceil(e.remaining_ego),p=m(11),h=m(12),f=m(13),g=m(14),b=u(t.team.girls[0]?.skills,14);return{attack:e.damage,defense:e.defense,ego:d,baseHitChance:1-s,critHitChance:s,critMultiplier:2+o.fire,healing:o.water,attackMultiplier:1+i(9),defenseMultiplier:1+i(10),stun:p,shield:h,reflect:f,execute:g,shieldEndurance:Math.ceil(d*h),deathThreshold:d*b}}function l(e,t){return{player:r(e,t),opponent:r(t,e)}}function i(e,t){const n=["fire","nature","stone","sun","water"];let a=1;return e.theme_elements.forEach((e=>{t.theme.includes(e.domination)&&n.includes(e.domination)&&(a+=.1)})),a}function c(e,t,n=1){const a=i(e,t),o=a*n,s=a,l=Object.fromEntries(t.synergies.map((e=>[e.element.type,e.bonus_multiplier]))).sun,c=e.caracs;return r({damage:Math.ceil(c.damage*o),defense:c.defense-Math.ceil(c.defense*l),remaining_ego:Math.ceil(c.ego*s),chance:c.chance,team:e},{chance:t.caracs.chance,team:t})}const u=(()=>{const e={FastChance:function(e,n){const a=t(e,n,(function(e,t){return 1}),(function(e,t){return 0}),(function(e,t,n,a){return e*t+n*a}));return Math.max(0,Math.min(1,a))},FastPoints:function(e,n){const a=t(e,n,(function(e,t){return Math.ceil(10*e/t)+15}),(function(e,t){return Math.ceil(10*(t-e)/t)+3}),(function(e,t,n,a){return e*t+n*a}));return Math.max(3,Math.min(25,a))},Chance:function(e,n){const a=t(e,n,(function(e,t){return{chance:1,alwaysWin:!0,neverWin:!1}}),(function(e,t){return{chance:0,alwaysWin:!1,neverWin:!0}}),(function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin}}));return a.chance=Math.max(0,Math.min(1,a.chance)),a},Points:function(e,n){const a=t(e,n,(function(e,t){return o(Math.ceil(10*e/t)+15)}),(function(e,t){return o(Math.ceil(10*(t-e)/t)+3)}),(function(e,t,n,a){return{avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints)}}));return a.avgPoints=Math.max(a.minPoints,Math.min(25,a.avgPoints)),a;function o(e){return{avgPoints:e,minPoints:e}}},Standard:function(e,n){const a=t(e,n,(function(e,t){return o(1,!0,!1,Math.ceil(10*e/t)+15)}),(function(e,t){return o(0,!1,!0,Math.ceil(10*(t-e)/t)+3)}),(function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin,avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints),maxPoints:Math.max(e.maxPoints,n.maxPoints)}}));return a.chance=Math.max(0,Math.min(1,a.chance)),a.avgPoints=Math.max(a.minPoints,Math.min(a.maxPoints,a.avgPoints)),a;function o(e,t,n,a){return{chance:e,alwaysWin:t,neverWin:n,avgPoints:a,minPoints:a,maxPoints:a}}},Full:function(e,n){const a=t(e,n,(function(e,t){return u(Math.ceil(10*e/t)+12)}),(function(e,t){return u(Math.ceil(10*(t-e)/t))}),(function(e,t,n,a){const o=Math.min(e.minPoints,n.minPoints),s=Math.max(e.maxPoints,n.maxPoints),r=e.pointsTable,l=n.pointsTable,i=Array(23).fill(0);for(let e=o;e<=s;e++)i[e]=r[e]*t+l[e]*a;return{minPoints:o,maxPoints:s,pointsTable:i}})),o=a.pointsTable.reduce(((e,t)=>e+t)),s=[0,0,0,...a.pointsTable.map((e=>e/o))],[r,l]=[[3,14],[15,26]].map((e=>s.slice(...e).reduce(((e,t)=>e+t)))),i=a.minPoints+3,c=a.maxPoints+3;return{chance:l/(l+r),alwaysWin:i>=15,neverWin:c<15,avgPoints:s.reduce(((e,t,n)=>e+t*n),0),minPoints:i,maxPoints:c,pointsTable:s};function u(e){const t=Array(23).fill(0);return t[e]=1,{minPoints:e,maxPoints:e,pointsTable:t}}}};function t(e,t,n,a,o){const s={...e,win:n},r={...t,win:a};return l(s,e.ego,e.attack,e.defense,0,r,t.ego,t.attack,t.defense,0);function l(e,t,n,a,s,r,l,c,u,m){n*=e.attackMultiplier,u*=e.defenseMultiplier;const d=Math.max(0,Math.floor(n-u)),p=i(e,t,n,a,s,r,l,c,u,m,d),h=i(e,t,n,a,s,r,l,c,u,m,d*e.critMultiplier);return o(p,e.baseHitChance,h,e.critHitChance)}function i(e,t,n,a,s,r,i,c,u,m,d){const p=Math.ceil(d);let h=0;if(r.shield&&1<=m&&m<=r.shieldEndurance){const e=r.shieldEndurance-(m-1);h=Math.min(p,e),m+=h}const f=p-h;if(i-=Math.ceil(f),t+=Math.ceil(f*e.healing),t=Math.min(t,e.ego),e.execute&&i<=r.deathThreshold&&(i=0),r.reflect&&1<=m&&m<=2&&(!e.stun||1!=s)){m++;const n=Math.ceil(f*r.reflect);let a=0;if(e.shield&&1<=s&&s<=e.shieldEndurance){const t=e.shieldEndurance-(s-1);a=Math.min(n,t),s+=a}t-=n-a}if(i<=0)return e.win(t,e.ego);if(e.stun&&1===s)return l(e,t,n,a,++s,r,i,c,u,m);e.reflect&&0===s&&(s=1),e.shield&&0===s&&(s=1);const g=l(r,i,c,u,m,e,t,n,a,s);if(e.stun&&0===s){const d=l(e,t,n,a,s=1,r,i,c,u,m);return o(d,e.stun,g,1-e.stun)}return g}}self.addEventListener("message",(t=>{const{id:n,type:a,args:o}=t.data;try{const t=(0,e[a])(o[0],o[1]);self.postMessage({id:n,ret:t})}catch(e){self.postMessage({id:n,error:e})}}))}).toString().match(/{.+}/s)[0],m=new Blob([u],{type:"text/javascript"}),d=URL.createObjectURL(m),p=navigator?.hardwareConcurrency??1,h=[],f=new Map;let g=0,b=0;async function y(e,t,n){return await async function(e,t){const n=b++,a={id:n,type:e,args:t};return function(){let e=h[g];if(null==e){e=new Worker(d);const t=({data:e})=>{const{id:t,ret:n,error:a}=e;null!=n?f.get(t).resolve(n):f.get(t).reject(a),f.delete(t)},n=e=>{throw e};e.addEventListener("message",t),e.addEventListener("messageerror",n),e.addEventListener("error",n),h[g]=e}return g=(g+1)%p,e}().postMessage(a),new Promise(((e,t)=>{f.set(n,{resolve:e,reject:t})}))}(e,[t,n])}async function w(e,t,n,a=1){const o=c(t,n,a),s=c(n,t);return await y(e,o,s)}function _(e,t=0){return(Math.floor(Math.round(e*10**(t+1))/10)/10**t).toLocaleString()}function v(e,t=0){return(Math.round(e*10**t)/10**t).toLocaleString()}function k(e){const t=100*e;return t>=100?"100%":t>=10?`${_(t,1)}%`:t>=.01?`${_(t,2)}%`:t>=0?`${_(t,3)}%`:"0%"}function S(e){const t=100*e;return t>=100?"100%":t>=.01?`${_(t,2)}%`:t>=0?`${_(t,3)}%`:"0%"}function E(e){return e>=25?"25":_(e,e>24.9?3:2)}function M(e,t){return e>=2?`<td colspan="${e}">${t}</td>`:`<td>${t}</td>`}function T(e,t){return t.map((t=>M(e,t))).join("")}function C(...e){return["<tr>",...e,"</tr>"].join("")}function P(e,t){const n=(e,t)=>{let n=e.attack,a=t.defense;const o=[];for(let t=0;t<10;t++){const t=Math.max(0,Math.floor(n-a)),s=[];s.push(t),s.push(Math.ceil(t*e.healing)),s.push(Math.ceil(t*e.critMultiplier)),s.push(Math.ceil(t*e.critMultiplier*e.healing)),o.push(s),n*=e.attackMultiplier,a*=e.defenseMultiplier}return o},a=n(e,t),o=n(t,e),s=[e,t].flatMap((e=>[e.baseHitChance,e.critHitChance]));return $('<table class="sim-table"></table>').append(C(M(1,""),T(4,["Player","Opponent"]))).append(C(M(1,""),T(2,["Normal","Critical"]).repeat(2))).append(C(M(1,"%"),T(2,s.map((e=>k(e)))))).append(C(M(1,""),T(1,["Damage","Healing"]).repeat(4))).append([...Array(9)].map(((e,t)=>t+1)).map((e=>C(M(1,e),...[a,o].map((t=>T(1,t[e].map((e=>e.toLocaleString())))))))).join("")).prop("outerHTML")}function x(e,t,n){return e<=t?t:e>=n?n:e}function L(e){return Math.round(255*Math.sqrt(x(e,0,1)))}function A(e){return`rgb(${L(2-2*e)}, ${L(2*e)}, 0)`}function H(e){return A(x(e,0,1)**3)}function j(e){return A(((x(e,3,25)-3)/22)**3)}window.HHBattleSimulator={simulateFromFighters:async(e,t)=>await async function(e,t,n){const a=r(t,n),o=r(n,t);return await y("Standard",a,o)}(0,e,t),simulateFromTeams:async(e,t,n=1)=>await w("Standard",e,t,n)};class B{element;last;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask((async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"";let a="";t.alwaysWin&&(a='<div class="vCheck_mix_icn sim-mark"></div>'),t.neverWin&&(a='<div class="xUncheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">P[W]:</div>${a}<span class="sim-chance">${k(t.chance)}${n}</span>`).css("color",H(t.chance))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">P[W]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}const I=(async()=>(null!=window.HHPlusPlus||(await a(),null!=window.HHPlusPlus||(await s(),null!=window.HHPlusPlus||await new Promise($))),window.HHPlusPlus))(),G=(async()=>(null!=window.hhPlusPlusConfig||(await a(),null!=window.hhPlusPlusConfig||(await s(),null!=window.hhPlusPlusConfig||await new Promise($))),window.hhPlusPlusConfig))();function O(){return I}const F={addBattleSimulator:!0,doSimulateTroll:!0,doSimulateLeague:!0,doSimulateSeason:!0,doSimulatePantheon:!0,doSimulateTeams:!0,doSimulateEditTeam:!0,doSimulateLeagueTable:!0,doSimulateFoughtOpponents:!0,addBoosterSimulatorToLeagueTable:!0,replaceHHLeaguesPlusPlus:!0,addBoosterSimulator:!0,simulateGinseng:!0,simulateJujubes:!0,simulateChlorella:!0,simulateCordyceps:!0,addSkillSimulator:!0,skillLevelsToBeSimulated:[5,4,3,2,1],calculateLeaguePointsTable:!1,addGirlTraitsToGirlTooltip:!0};function q(){return F}function N(e,t){return null!=e?+e:t}function R(e,t,n){return Array.isArray(t)?e.reduce(((e,a,o)=>(e[a]=N(t[o],n),e)),{}):e.reduce(((e,a)=>(e[a]=N(t[a],n),e)),{})}function W(e,t,n,a){return"number"==typeof n?e.reduce(((e,o)=>(e[o]=a(t[o],n),e)),{}):e.reduce(((e,o)=>(e[o]=a(t[o],n[o]),e)),{})}function U(e,t,n){return W(e,t,n,((e,t)=>e+t))}function z(e,t,n){return W(e,t,n,((e,t)=>e*t))}function J(e,t){return e.reduce(((e,n)=>(e[n]=Math.floor(t[n]),e)),{})}class D{keys;value;constructor(e,t={}){this.keys=e,this.value=R(e,t,0)}add(e){return this.value=U(this.keys,this.value,e),this}subtract(e){return this.value=W(this.keys,this.value,e,((e,t)=>e-t)),this}multiply(e){return this.value=z(this.keys,this.value,e),this}divide(e){return this.value=W(this.keys,this.value,e,((e,t)=>e/t)),this}truncate(){return this.value=J(this.keys,this.value),this}round(){var e,t;return this.value=(e=this.keys,t=this.value,e.reduce(((e,n)=>(e[n]=Math.round(t[n]),e)),{})),this}result(){return this.value}}const K=["damage","defense","ego","chance"];class V extends D{constructor(e={}){super(K,e)}}function Q(e){return R(K,e,0)}function X(e,t){return U(K,e,t)}function Y(e,t){return z(K,e,t)}const Z=["hardcore_stats","charm_stats","know_how_stats","endurance_stats","harmony_stats"],ee=["carac1","carac2","carac3","endurance","chance"];function te(e){return R(ee,e,0)}function ne(e,t){return U(ee,e,t)}class ae extends D{constructor(e={}){super(ee,e)}}class oe{element;last;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask((async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"";let a="";t.minPoints>=25&&(a='<div class="vCheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">E[P]:</div>${a}<span class="sim-points">${E(t.avgPoints)}${n}</span>`).css("color",j(t.avgPoints))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">E[P]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}function se(e,t){const n=localStorage.getItem(e);if(null==n)return t;try{const e=JSON.parse(n);return null!=e&&null!=t&&"object"==typeof e&&"object"==typeof t?{...t,...e}:e}catch(e){return n}}function re(e,t){localStorage.setItem(e,JSON.stringify(t))}function le(e){re("HHBattleSimulator.HeroData",{classBonus:e.classBonus,ginsengCaracs:e.ginsengCaracs})}function ie(){return se("HHBattleSimulator.HeroData",{})}function ce(){return ie().ginsengCaracs??null}function ue(e){re("HHBattleSimulator.TeamData",{opponent:e.opponent,league:e.league,params:e.params})}function me(){return se("HHBattleSimulator.TeamData",{})}function de(e){const t=me();t.opponent=e,ue(t)}function pe(){return me().opponent??null}function he(e){const t=me();t.league=e??void 0,ue(t)}function fe(){return me().league??null}function ge(...e){const{pathname:t}=window.location;return e.some((e=>t.includes(e)))}function be(){const e=location.search.match(/id_opponent=(\d+)/)?.[1];if(null==e)throw new Error("id_opponent is not found from url.");return e}function ye(e){re("HHBattleSimulator.BoosterData",{normals:e.normals,mythic:e.mythic})}function we(){return se("HHBattleSimulator.BoosterData",{})}function _e(e){const t=we();t.mythic=e,ye(t)}function ve(){return we().mythic??{}}function ke(e){const{$:t}=e;if(null==t)throw new Error("jQuery is not found.");const{localStorageGetItem:n,localStorageSetItem:a,get_lang:o,get_dec_and_sep:s}=e;if(null==n)throw new Error("localStorageGetItem is not found.");if(null==a)throw new Error("localStorageSetItem is not found.");if(null==o)throw new Error("get_lang is not found.");if(null==s)throw new Error("get_dec_and_sep is not found.");const{SITE_ROOT:r,IMAGES_URL:l}=e;if(null==r)throw new Error("SITE_ROOT is not found.");if(null==l)throw new Error("IMAGES_URL is not found.");const{Hero:i}=e;if(null==i)throw new Error("Hero is not found.")}async function $e(e){await o(),ke(e),q().addGirlTraitsToGirlTooltip&&async function(e){const{tooltips:t}=e;if(null==t||"object"!=typeof t)return;if(!("[data-new-girl-tooltip]"in t))return;if("function"!=typeof t["[data-new-girl-tooltip]"])return;const n=t["[data-new-girl-tooltip]"],a=new Map;t["[data-new-girl-tooltip]"]=function(...t){const o=n(...t),s=$(t[0]),r=JSON.parse(s.attr("data-new-girl-tooltip")??"").id_girl??(()=>{const e=s.is("[girl-ico-src]")?s:s.find("[girl-ico-src]");return e.attr("girl-ico-src")?.match(/pictures\/girls\/(\d+)\/(?:ico|ava)/)?.[1]})()??(()=>{const e=s.is("img[src]")?s:s.find("img[src]");return e.attr("src")?.match(/pictures\/girls\/(\d+)\/(?:ico|ava)/)?.[1]})();if(null!=r){const t=a.get(+r);if(null!=t){const n={"♈":"aries","♉":"taurus","♊":"gemini","♋":"cancer","♌":"leo","♍":"virgo","♎":"libra","♏":"scorpio","♐":"sagittarius","♑":"capricorn","♒":"aquarius","♓":"pisces"},a=e.IMAGES_URL+"/pictures/design/blessings_icons/",s=e=>`<span class="sim-trait-icon" style="background-image: url('${a}${e}');"></span>`,r=e=>""==e?"":s(`hair_colors/hair_color_${e}.png`),l=e=>""==e?"":s(`eye_colors/eye_color_${e}.png`),i=e=>s(`zodiac_signs/zodiac_sign_${n[e.charAt(0)]}.png`),c=e=>s(`positions/fav_pose_${e}.png`),u=['<div class="sim-traits">',r(t[0]),r(t[1])," ",l(t[2]),l(t[3])," ",i(t[4])," ",c(t[5]),"</div>"],m=o.body;o.body=m+u.join("")}}return o};const o=e=>{const t=[e.hair_color1??e.girl.hair_color1,e.hair_color2??e.girl.hair_color2,e.eye_color1??e.girl.eye_color1,e.eye_color2??e.girl.eye_color2,e.zodiac??e.girl.zodiac,e.figure??e.girl.figure];a.set(+e.id_girl,t)};if(ge("/troll-battle.html","/troll-pre-battle.html","/leagues-pre-battle.html","/pantheon-pre-battle.html")&&(e.hero_data.team.girls.map((e=>o(e))),e.opponent_fighter.player.team.girls.map((e=>o(e)))),ge("/league-battle.html","/pantheon-battle.html","/season-battle.html")&&(e.hero_fighter.girls.map((e=>o(e))),e.opponent_fighter.girls.map((e=>o(e)))),ge("/tower-of-fame.html")&&e.opponents_list.forEach((e=>e.player.team.girls.map((e=>o(e))))),ge("/season-arena.html")&&(e.hero_data.team.girls.map((e=>o(e))),e.opponents.forEach((e=>e.player.team.girls.map((e=>o(e)))))),ge("/teams.html")){const t=e.teams_data;Object.values(t).forEach((e=>{e.girls.map((e=>o(e)))}))}if(ge("/edit-team.html")&&e.availableGirls.forEach((e=>o(e))),ge("/waifu.html")&&e.girlsDataList.forEach((e=>o(e))),ge("/path-of-valor.html","/path-of-glory.html")&&e.path_girls.forEach((e=>o(e))),ge("/activities.html")){const t=e.pop_hero_girls;Object.values(t).forEach((e=>o(e)))}if(ge("pantheon.html")&&Array.isArray(girl_rewards)&&girl_rewards.forEach((e=>o(e.girl_data))),ge("clubs.html")){const t=e.club_champion_data,n=t?.champion?.girl;null!=n&&o(n)}if(ge("/girl/")){const t=e.girl;null!=t&&o(t),$(document).on("ajaxComplete",((e,t,n)=>{if(n.data?.includes("action=get_teams_for_girl")){const e=t.responseJSON;e?.teams?.forEach((e=>e.girls.forEach((e=>o(e)))))}}))}}(e)}function Se(e){const{localStorageGetItem:t}=e,n=t("battle_type"),a=pe();if(null==a||a.battleType!==n)return null;const o={leagues:()=>t("leagues_id"),trolls:()=>t("troll_id"),pantheon:()=>t("pantheon_id"),seasons:()=>a.opponentId},s=o[n]?.();return s===a.opponentId?a.team:null}function Ee(e){return we().mythic?.[e]??null}function Me(e){if("pointsTable"in e){const t=Math.sqrt(e.pointsTable.reduce(((e,t)=>Math.max(e,t)),0)),n=e.pointsTable.map(((e,t)=>({points:t,probability:e}))).filter((e=>e.probability>0)).sort(((e,t)=>t.points-e.points)).flatMap((e=>[`<tr style="color: ${j(e.points)};">`,"<td>",e.points.toFixed(),"</td>",'<td class="sim-bar-container">',`<div class="sim-bar" style="width: ${5*e.probability/t}rem;"></div>`,S(e.probability),"</td>","</tr>"]));return $('<table class="sim-points-table"></table>').append(n.join("")).prop("outerHTML")}return $('<table class="sim-table"></table>').append(C(M(2,"Points"))).append(C(T(1,["Max",e.maxPoints.toFixed()]))).append(C(T(1,["Avg",(t=e.avgPoints,t>=25?"25":t>24.9?(25-parseFloat((25-t).toPrecision(2))).toLocaleString():_(t,2))]))).append(C(T(1,["Min",e.minPoints.toFixed()]))).prop("outerHTML");var t}class Te{mojo;element;last;constructor(e){this.mojo=e,this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask((async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"",a=t.chance,o=1-a,s=this.mojo,r=s-40,l=s*a+r*o;this.element.removeClass("sim-pending").html(`<div class="sim-label">E[M]:</div><span class="sim-mojo">${v(l,2)}${n}</span>`).css("color",function(e){let t=x(e+10,0,40)/40;return t=.5-.5*Math.cos(t**2*Math.PI),A(t)}(l)).attr("tooltip",$('<table class="sim-table"></table>').append(C(M(1,""),T(1,["Win","Loss"]))).append(C(M(1,"Mojo"),T(1,[s,r].map((e=>v(e,2)))))).append(C(M(1,"%"),T(1,[a,o].map((e=>k(e)))))).append(C(M(1,"E[M]"),M(2,v(l,2)))).prop("outerHTML"))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">E[M]:</div>-').css("color","")}getElement(){return this.element}}async function Ce(e){if(!ge("/edit-team.html"))return;await o(),function(e){ke(e);const{hero_data:t,teamGirls:n,theme_resonance_bonuses:a,availableGirls:o}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("teamGirls is not found.");if(null==a)throw new Error("theme_resonance_bonuses is not found.");if(null==o)throw new Error("availableGirls is not found.")}(e);const t=q(),{availableGirls:n}=e,a=Object.fromEntries(n.map((e=>[e.id_girl,e]))),{get_lang:r,get_dec_and_sep:l}=e,i=l(r()).sep,u=e=>parseFloat(e.trim().replaceAll(i,"")),m=()=>{const e=e=>u($(`#stats-${e}`).text());return{damage:e("damage"),defense:e("defense"),ego:e("ego"),chance:e("chance")}},d=()=>{const e=Array(7);return document.querySelectorAll(".team-hexagon [data-girl-id]").forEach((t=>{const n=t.dataset.teamMemberPosition,o=t.dataset.girlId;null!=n&&null!=o&&(e[+n]=a[o])})),e.filter((e=>null!=e))},p=()=>({caracs:m(),total_power:u($(".team-total-power").text()),girls:d(),id_team:e.hero_data.team.id_team});!async function(e){const{Hero:t,hero_data:n,server_now_ts:o}=e,r=n.team;Ae({...r,girls:r.girls.map((e=>a[e.id_girl]))},t,o),await s();const l=document.getElementById("validate-team");null!=l&&l.addEventListener("click",(()=>{Ae(p(),t,o)}),!0)}(e),t.doSimulateEditTeam&&async function(e){const{hero_data:n,teamGirls:a,theme_resonance_bonuses:o,availableGirls:r,localStorageGetItem:l}=e,i=Se(e);if(null==i)return;const u=i,d=n.team;if(null==d)return;const h=new Map(Object.values(r).map((e=>[e.id_girl,e]))),f=l("battle_type"),g=Ee(f);if(null==g)return;const b=Object.fromEntries(d.synergies.map((e=>[e.element.type,e.element])));let w={...d},_=!1;await s();const v=$(".player_team_block.battle_hero .icon-area"),k=new B;v.before(k.getElement().addClass("sim-left"));const S="leagues"===f?new oe:null;null!=S&&v.before(S.getElement().addClass("sim-right"));const E=pe()?.mojo,M="seasons"===f&&null!=E?new Te(E):null;null!=M&&v.before(M.getElement().addClass("sim-right")),x();const T=document.querySelector(".player_stats");null!=T&&new MutationObserver((function(){const e=m(),t=Array.from(document.querySelectorAll(".team-member-container[data-girl-id]")).sort(((e,t)=>Number(e.dataset.teamMemberPosition)-Number(t.dataset.teamMemberPosition))).map((e=>h.get(e.dataset.girlId)));_=!1,w.girls=t.map((e=>{const t=e.id_girl,n=a.find((e=>e.id_girl==t));if(null!=n)return{...e,skills:n.skills};const o={},s=e.skill_tiers_info[4]?.skill_points_used??0;s&&(_=!0,o[9]={skill:{percentage_value:.2*s}},o[10]={skill:{percentage_value:0}});const r=e.skill_tiers_info[5]?.skill_points_used??0;if(r>0){const t=e.element;["darkness","sun"].includes(t)&&(o[11]={skill:{percentage_value:7*r}}),["stone","light"].includes(t)&&(o[12]={skill:{percentage_value:8*r}}),["nature","psychic"].includes(t)&&(o[13]={skill:{percentage_value:20*r}}),["fire","water"].includes(t)&&(o[14]={skill:{percentage_value:6*r}})}return{...e,skills:o}}));const n=Object.fromEntries(Object.keys(b).map((e=>[e,0])));t.forEach((e=>{n[e.element]++})),w.synergies=d.synergies.map((e=>({...e,element:{type:e.element.type},bonus_multiplier:e.harem_bonus_multiplier+e.team_bonus_per_girl*n[e.element.type]})));const s=Object.entries(n).filter((([e,t])=>t>=3)).map((([e,t])=>e));if(w.theme_elements=s.map((e=>b[e])),w.theme=s.join(","),s.length>0){const t=o[""];if(t){const{defense:n,chance:a}=t;n&&(e.defense/=Math.pow(1.02,n/2)),a&&(e.chance/=Math.pow(1.04,a/4))}s.forEach((t=>{const n=o[t];if(n){const{defense:t,chance:a}=n;t&&(e.defense*=Math.pow(1.02,t/2)),a&&(e.chance*=Math.pow(1.04,a/4))}}))}w.caracs=e,x()})).observe(T,{subtree:!0,childList:!0});const C=document.querySelector(".team-hexagon");function x(){const e=_,n=c(w,u,g??1),a=c(u,w),o=y(null==S?"Chance":t.calculateLeaguePointsTable?"Full":"Standard",n,a).then((t=>({...t,hasAssumptions:e})));if(k.updateAsync(o),k.setTooltip(P(n,a)),null!=S){const e=o;S.updateAsync(e),e.then((e=>{S.setTooltip(Me(e))}))}null!=M&&M.updateAsync(o)}null!=C&&new MutationObserver((function(){const e=w.girls,t=+e[0]?.id_girl,n=new Set(e.map((e=>+e.id_girl))),a=p().girls.map((e=>+e.id_girl)),o=a[0];if(a.length==e.length&&a.every((e=>n.has(e))))return o===t?void 0:(w.girls=a.map((t=>e.find((e=>+e.id_girl==+t)))),void x());k.reset(),S?.reset(),M?.reset()})).observe(C,{subtree:!0,attributes:!0,attributeFilter:["src"]})}(e)}let Pe,xe=null;async function Le(e,t,n){if(null!=Pe)return Pe;const a=await async function(e){return xe??=(async()=>{const t=await fetch(`edit-team.html?id_team=${e}`),n=await t.text();return{teamGirls:JSON.parse(n.match(/var\s+teamGirls\s*=\s*(\[.*?\]);/)?.[1]),theme_resonance_bonuses:JSON.parse(n.match(/var\s+theme_resonance_bonuses\s*=\s*((?:\{|\[).*?(?:\}|\]));/)?.[1]),hero_data:Function("return "+n.match(/var\s+hero_data\s*=\s*(\{.*?\});/s)?.[1])(),availableGirls:JSON.parse(n.match(/var\s+availableGirls\s*=\s*(\[.*?\]);/)?.[1])}})(),xe}(e),o=Object.fromEntries(a.availableGirls.map((e=>[e.id_girl,e]))),s={...a.hero_data.team,girls:a.hero_data.team.girls.map((e=>o[e.id_girl]))};return Pe=Ae(s,t,n),Pe}function Ae(e,t,n){const a=ie().classBonus??null;if(null==a)return;const o=function(e){const{normals:t}=we();if(null==t)return null;const n=new V,a=new V;return t.forEach((t=>{t.lifetime<e||(null!=t.multiplier&&n.add(t.multiplier),null!=t.addend&&a.add(t.addend))})),{multiplier:n.divide(100).add(1).result(),addend:a.result()}}(n);if(null==o)return;const s=Y(function(e){const{caracs:t}=e.infos;return{damage:t.primary_carac_amount,defense:.25*t.secondary_caracs_sum,ego:t.endurance,chance:t.chance}}(t),a),r=e.girls.flatMap((e=>e.armor.map((e=>Q(e.caracs))))).reduce(((e,t)=>X(e,t)),Q({})),l=(new V).add((i=e.total_power,{damage:.25*i,defense:.12*i,ego:2*i,chance:0})).multiply(a).add(r).result();var i;const c=(new V).add(e.caracs).divide(o.multiplier).subtract(o.addend).divide(X(l,s)).result(),u=Y(a,c),m=Y(l,c),d={teamId:+e.id_team,multiplier:u,addend:m,caracs:e.caracs};return function(e){const t=me();t.params??=[],t.params=[e,...t.params.filter((t=>t.teamId!==e.teamId))],ue(t)}(d),d}function He(e,t){const n=i(e.team,t.team);return Math.round(100*e.damage/e.team.caracs.damage/n)/100}async function je(e){if(null==e.id_team)return;const t=e.id_team,n=(me().params??[]).find((e=>e.teamId===+t));return null!=n?.caracs&&(a=n.caracs,o=e.caracs,function(e,t,n){return e.every((e=>+t[e]==+n[e]))}(K,a,o))?n:null!=window.Hero?await Le(t,window.Hero,window.server_now_ts):void 0;var a,o}const Be=["ginseng","jujubes","chlorella","cordyceps","mythic"];function Ie(e,t,n,a){const{ginseng:o,jujubes:s,chlorella:r,cordyceps:l}=a,i=n[o];return{...e,caracs:new V(i).multiply(t.multiplier).add(t.addend).multiply((c={damage:1+.1*l,ego:1+.1*r,chance:1+.2*s},R(K,c,1))).round().result()};var c}function Ge(e,t){const n={...e.girls[0].skills};[11,12,13,14].forEach((e=>{delete n[e]})),n[t.skill.id_skill]=t;const a=[...e.girls];return a[0]={...e.girls[0],skills:n},{...e,girls:a}}let Oe=null;function Fe(){if(null==Oe){const{simulateGinseng:e,simulateJujubes:t,simulateChlorella:n,simulateCordyceps:a}=q();Oe=[...Array(2)].flatMap(((o,s)=>[...Array(a?5:1)].flatMap(((a,o)=>[...Array(n?5-o:1)].flatMap(((n,a)=>[...Array(t?5-o-a:1)].flatMap(((t,n)=>{const r=4-o-a-n;return!e&&r>0?[]:{key:`${r}${n}${a}${o}${s}`,counts:{ginseng:r,jujubes:n,chlorella:a,cordyceps:o,mythic:s}}}))))))))}return Oe}async function qe(e){const t=Fe();return Promise.all(t.map((async({counts:t})=>({boosterCounts:t,result:await e(t)}))))}async function Ne(e,t){const n=ce();if(null==n)throw new Error("Market data not found");const a=await je(e);if(null==a)throw new Error("Team data not found");return qe((async o=>{const s=Ie(e,a,n,o),r=1+.15*o.mythic;return w("FastPoints",s,t,r)}))}async function Re(e){const t={11:{skillType:"stun",levelPercentage:7},12:{skillType:"shield",levelPercentage:8},13:{skillType:"reflect",levelPercentage:20},14:{skillType:"execute",levelPercentage:6}},n=q().skillLevelsToBeSimulated;return 0===n.length?[]:Promise.all([11,12,13,14].map((async a=>{const o=await Promise.all(n.map((async n=>{const o=((e,n)=>{const{skillType:a,levelPercentage:o}=t[e],s=n*o;return{id_skill:e.toString(),level:n.toString(),skill:{id_skill:e,level:n,percentage_value:s,display_value_text:`${s}%`,skill_type:a}}})(a,n);return{level:n,results:await qe((async t=>e(t,o)))}})));var s;return{skillName:(s=t[a].skillType).charAt(0).toUpperCase()+s.slice(1).toLowerCase(),results:o}})))}async function We(e,t){const n=ce();if(null==n)throw new Error("Market data not found");const a=await je(e);if(null==a)throw new Error("Team data not found");return Re((async(o,s)=>{const r=Ge(Ie(e,a,n,o),s),l=1+.15*o.mythic;return w("FastPoints",r,t,l)}))}async function Ue(e){if(!ge("/troll-pre-battle.html"))return;await o(),function(e){ke(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e);const t=q();!function(e){const{hero_data:t,opponent_fighter:n}=e,a=He(t,n.player),o=ve();o.trolls=a,_e(o)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,a=be(),o=t.player.team,r=()=>{n("battle_type","trolls"),n("troll_id",a),de({battleType:"trolls",opponentId:a,team:o})};r(),await s();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(e),t.doSimulateTroll&&async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:a,opponent:o}=l(t,n.player),r=y("Chance",a,o);await s();const i=new B;i.updateAsync(r),i.setTooltip(P(a,o)),$(".opponent .icon-area").before(i.getElement().addClass("sim-left"))}(e)}async function ze(e){ge("/league-battle.html")&&(await o(),function(e){ke(e);const{hero_fighter:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_fighter is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e),function(e){const{hero_fighter:t}=e;he(t)}(e))}function Je(e){e.sort(((e,t)=>{const n=n=>((e,t)=>e==t?null:e-t)(n(t),n(e));return n((e=>e.result))??n((e=>e.boosterCounts.mythic))??n((e=>e.boosterCounts.cordyceps))??n((e=>e.boosterCounts.chlorella))??n((e=>e.boosterCounts.jujubes))??n((e=>e.boosterCounts.ginseng))??0}))}function De(e,t){return`<div class="sim-booster-slot slot ${e}"><div class="sim-booster-icon sim-icon-${t}"></div></div>`}const Ke={ginseng:De("legendary","ginseng"),jujubes:De("legendary","jujubes"),chlorella:De("legendary","chlorella"),cordyceps:De("legendary","cordyceps"),headband:De("mythic","headband"),ame:De("mythic","ame")};function Ve(e,t){return Be.map((n=>Ke["mythic"===n?t:n].repeat(e[n]))).join("")}function Qe(e){return e.forEach((e=>{e.results.forEach((e=>{Je(e.results)}))})),function(){const t=[5,4,3,2,1].map((t=>{return n=t,C(T(1,e.map((e=>function(e){const t=e.skillName,a=e.results.find((e=>e.level===n))?.results;return null==a?"":function(e){return["<table>",C(M(2,`Level ${n} ${t}`)),...e.map((e=>C(T(1,[Ve(e.boosterCounts,"headband"),`<span class="sim-chance" style="color: ${H(e.result)}">${S(e.result)}</span>`])))),"</table>"].join("")}(a)}(e)))));var n}));return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}function Xe(e){return e.forEach((e=>{e.results.forEach((e=>{Je(e.results)}))})),function(){const t=[5,4,3,2,1].map((t=>{return n=t,C(T(1,e.map((e=>function(e){const t=e.skillName,a=e.results.find((e=>e.level===n))?.results;return null==a?"":function(e){return["<table>",C(M(2,`Level ${n} ${t}`)),...e.map((e=>C(T(1,[Ve(e.boosterCounts,"ame"),`<span class="sim-chance" style="color: ${H(e.result)}">${S(e.result)}</span>`])))),"</table>"].join("")}(a)}(e)))));var n}));return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}function Ye(e){Je(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=t.map(((e,t)=>C(T(1,[Ve(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${j(e.result)}">${E(e.result)}</span>`,Ve(n[t].boosterCounts,"ame"),`<span class="sim-points" style="color: ${j(n[t].result)}">${E(n[t].result)}</span>`]))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}function Ze(e){return e.forEach((e=>{e.results.forEach((e=>{Je(e.results)}))})),function(){const t=[5,4,3,2,1].map((t=>{return n=t,C(T(1,e.map((e=>function(e){const t=e.skillName,a=e.results.find((e=>e.level===n))?.results;return null==a?"":function(e){return["<table>",C(M(2,`Level ${n} ${t}`)),...e.map((e=>C(T(1,[Ve(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${j(e.result)}">${E(e.result)}</span>`])))),"</table>"].join("")}(a)}(e)))));var n}));return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}class et{element;content;constructor(e){this.element=$('<div class="sim-popup"></div>');const t=$('<div class="close-button xUncheck_mix_icn"></div>');t.on("click",(()=>{this.hide()})),this.element.append(t),"string"==typeof e?this.element.append($('<h1 class="caption"></h1>').text(e)):this.element.append(e);const n=$('<div class="content"></div>');this.content=n,this.element.append(n)}show(){this.element.appendTo("#contains_all")}hide(){this.element.detach()}toggle(){0===this.element.parent().length?this.show():this.hide()}setContent(e){"string"==typeof e?this.content.html(e):this.content.empty().append(e)}}async function tt(e){if(!ge("/leagues-pre-battle.html"))return;await o(),function(e){ke(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e);const t=q();!function(e){const{hero_data:t}=e;he(t.team)}(e),function(e){const{hero_data:t,opponent_fighter:n}=e,a=He(t,n.player),o=ve();o.leagues=a,_e(o)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,a=be(),o=t.player.team,r=()=>{n("battle_type","leagues"),n("leagues_id",a),de({battleType:"leagues",opponentId:a,team:o})};r(),await s();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(e),t.doSimulateLeague&&(async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:a,opponent:o}=l(t,n.player),{calculateLeaguePointsTable:r}=q(),i=y(r?"Full":"Standard",a,o);await s();const c=new B;c.updateAsync(i),c.setTooltip(P(a,o)),$(".opponent .icon-area").before(c.getElement().addClass("sim-left"));const u=new oe;u.updateAsync(i),i.then((e=>{u.setTooltip(Me(e))})),$(".opponent .icon-area").before(u.getElement().addClass("sim-right"))}(e),t.addBoosterSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,o=n.player.team;await s();const r=new et("Booster simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let i=!1;l.on("click",(()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await Ne(a,o);r.setContent(Ye(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),r.toggle()})),$(".battle_hero .icon-area").before(l)}(e),t.addSkillSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,o=n.player.team;await s();const r=new et("Skill simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator");let i=!1;l.on("click",(()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await We(a,o);r.setContent(Ze(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),r.toggle()})),$(".battle_hero .icon-area").before(l)}(e))}async function nt(e){if(!ge("/pantheon-pre-battle.html"))return;await o(),function(e){ke(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e);const t=q();!function(e){const{hero_data:t,opponent_fighter:n}=e,a=He(t,n.player),o=ve();o.pantheon=a,_e(o)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,a=be(),o=t.player.team,r=()=>{n("battle_type","pantheon"),n("pantheon_id",a),de({battleType:"pantheon",opponentId:a,team:o})};r(),await s();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(e),t.doSimulatePantheon&&(async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:a,opponent:o}=l(t,n.player),r=y("Chance",a,o);await s();const i=new B;i.updateAsync(r),i.setTooltip(P(a,o)),$(".opponent .icon-area").before(i.getElement().addClass("sim-left"))}(e),t.addBoosterSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,o=n.player.team;await s();const r=new et("Booster simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-headband"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let i=!1;l.on("click",(()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await async function(e,t){const n=ce();if(null==n)throw new Error("Market data not found");const a=await je(e);if(null==a)throw new Error("Team data not found");return qe((async o=>{const s=Ie(e,a,n,o),r=1+.25*o.mythic;return w("FastChance",s,t,r)}))}(a,o);r.setContent(function(e){Je(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=t.map(((e,t)=>C(T(1,[Ve(e.boosterCounts,"headband"),`<span class="sim-chance" style="color: ${H(e.result)}">${S(e.result)}</span>`,Ve(n[t].boosterCounts,"headband"),`<span class="sim-chance" style="color: ${H(n[t].result)}">${S(n[t].result)}</span>`]))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),r.toggle()})),$(".battle_hero .icon-area").before(l)}(e),t.addSkillSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,o=n.player.team;await s();const r=new et("Skill simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator");let i=!1;l.on("click",(()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await async function(e,t){const n=ce();if(null==n)throw new Error("Market data not found");const a=await je(e);if(null==a)throw new Error("Team data not found");return Re((async(o,s)=>{const r=Ge(Ie(e,a,n,o),s),l=1+.25*o.mythic;return w("FastChance",r,t,l)}))}(a,o);r.setContent(Qe(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),r.toggle()})),$(".battle_hero .icon-area").before(l)}(e))}async function at(e){if(!ge("/season-arena.html"))return;await o(),function(e){ke(e);const{hero_data:t,caracs_per_opponent:n,opponents:a}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("caracs_per_opponent is not found.");if(null==a)throw new Error("opponents is not found.")}(e);const{hero_data:t,caracs_per_opponent:n,opponents:a}=e;!function(){const e=a[0].player,o=n[e.id_fighter],s=i(t.team,e.team),r=Math.round(100*o.damage/t.team.caracs.damage/s),l=ve();l.seasons=r/100,_e(l)}(),async function(e){const{opponents:t,localStorageSetItem:n}=e,a=()=>{n("battle_type","seasons");const e=$(".selected_opponent").attr("data-opponent");if(null==e)return;const a=t.find((t=>t.player.id_fighter===e));if(null==a)return;const o=a.player.team,s=a.rewards.rewards.find((e=>"victory_points"===e.type))?.value;de({battleType:"seasons",opponentId:e,team:o,mojo:+(s??0)})};a(),await s();const o=document.getElementById("change_team");null!=o&&(o.addEventListener("click",a,!0),o.addEventListener("auxclick",a,!0))}(e);const l=q();l.doSimulateSeason&&(async function(){a.forEach((async e=>{const a=e.player,o=a.id_fighter,l={...t,...n[o]},i=r(l,a),c=r(a,l),u=y("Chance",i,c),m=+e.rewards.rewards.find((e=>"victory_points"===e.type)).value;await s();const d=new B;d.updateAsync(u),d.setTooltip(P(i,c));const p=new Te(m);p.updateAsync(u),$(`[data-opponent="${o}"] .icon-area`).before(d.getElement().addClass("sim-left")).before(p.getElement().addClass("sim-right"))}))}(),l.addBoosterSimulator&&async function(e){const{hero_data:t}=e,n=t.team;await s();const a=$('<div class="sim-result"><div class="sim-icon-button sim-icon-headband"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator"),o={};a.on("click",(()=>{const t=ot(e);if(null==t)return;let a=o[+t.player.id_fighter];null==a&&(a=new et(`Booster simulator (${t.player.nickname})`),a.setContent("Now loading..."),o[+t.player.id_fighter]=a,queueMicrotask((async()=>{try{const e=await async function(e,t){const n=ce();if(null==n)throw new Error("Market data not found");const a=await je(e);if(null==a)throw new Error("Team data not found");return qe((async o=>{const s=Ie(e,a,n,o),r=1+.15*o.mythic;return w("FastChance",s,t,r)}))}(n,t.player.team);a.setContent(function(e){Je(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=t.map(((e,t)=>C(T(1,[Ve(e.boosterCounts,"ame"),`<span class="sim-chance" style="color: ${H(e.result)}">${S(e.result)}</span>`,Ve(n[t].boosterCounts,"ame"),`<span class="sim-chance" style="color: ${H(n[t].result)}">${S(n[t].result)}</span>`]))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(e))}catch(e){const t=e instanceof Error?e.message:e;a.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),Object.values(o).filter((e=>e!=a)).forEach((e=>e.hide())),a.toggle()})),$(".battle_hero .icon-area").before(a)}(e),l.addSkillSimulator&&async function(e){const{hero_data:t}=e,n=t.team;await s();const a=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator"),o={};a.on("click",(()=>{const t=ot(e);if(null==t)return;let a=o[+t.player.id_fighter];null==a&&(a=new et(`Booster simulator (${t.player.nickname})`),a.setContent("Now loading..."),o[+t.player.id_fighter]=a,queueMicrotask((async()=>{try{const e=await async function(e,t){const n=ce();if(null==n)throw new Error("Market data not found");const a=await je(e);if(null==a)throw new Error("Team data not found");return Re((async(o,s)=>{const r=Ge(Ie(e,a,n,o),s),l=1+.15*o.mythic;return w("FastChance",r,t,l)}))}(n,t.player.team);a.setContent(Xe(e))}catch(e){const t=e instanceof Error?e.message:e;a.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),Object.values(o).filter((e=>e!=a)).forEach((e=>e.hide())),a.toggle()})),$(".battle_hero .icon-area").before(a)}(e))}function ot(e){const{opponents:t}=e,n=$(".selected_opponent").attr("data-opponent");if(null==n)return;const a=t.find((e=>e.player.id_fighter===n));return null!=a?a:void 0}const st={MB2:{leagues:1.15,seasons:1.15},MB3:{trolls:1.25,pantheon:1.25},MB8:{leagues:1.15,seasons:1},MB9:{leagues:1,seasons:1.15}};function rt(e){const t=[];let n={};return e.forEach((e=>{const{item:a}=e;switch(a.rarity){case"common":case"rare":case"epic":t.push({addend:Q(a),lifetime:+e.lifetime});break;case"legendary":t.push({multiplier:Q(a),lifetime:+e.lifetime});break;case"mythic":const o=st[a.identifier];null!=o&&(n={...n,...o})}})),{normals:t,mythic:n}}async function lt(e){ge("/shop.html")&&(await o(),function(e){ke(e);const{equipped_armor:t,equipped_booster:n}=e;if(null==t)throw new Error("equipped_armor is not found.");if(null==n)throw new Error("equipped_booster is not found.")}(e),function(e){const{equipped_booster:t}=e,n=rt(t.normal.concat(t.mythic));n.mythic={leagues:1,seasons:1,trolls:1,pantheon:1,...n.mythic},ye(n)}(e),function(e){it(e),ct(e);const t=e.Hero,n=t.updates;"function"==typeof n&&(t.updates=function(...t){const a=n(...t);try{it(e),ct(e)}catch(e){}return a})}(e))}function it(e){const{equipped_armor:t}=e,n=function(e,t){const n=e.infos.class,a=e.infos.harem_endurance,o=ee[(n+2)%3],s=ee[(n+1)%3],r=ee[(n+0)%3],l=e=>e[o],i=e=>e[s]+e[r];return[...Array(5)].map(((n,o)=>{const s=function(e){const t=e.club?.upgrades_data;return te(null==t?{}:Z.map((e=>t[e].level/200)))}(e),r=ne(s,te(Array(3).fill(.06*o))),c=function(e){const t=e.infos,n=t.level,a=t.class,o=[5,7,9,5,7];return te([n*o[3-a],n*o[4-a],n*o[5-a]])}(e),u=function(e){return te(e.infos)}(e),m=ne(c,u),d=ne(m,t),p=new ae(d).multiply(r).truncate().result(),h=ne(t,p);let f=(4*l(m)+t.endurance+a)*(1+r.endurance);f+=4*l(h),f=Math.floor(f);let g=(i(m)/2+t.chance)*(1+r.chance);g+=i(h)/2,g=Math.round(g);const b=ne(d,p);b.endurance=f,b.chance=g;const y=J(ee,b);return{damage:l(y),defense:.25*i(y),ego:y.endurance,chance:y.chance}}))}(e.Hero,function(e){return Object.values(e).map((e=>te(e.caracs))).reduce(((e,t)=>ne(e,t)),te({}))}(t));!function(e){const t=ie();t.ginsengCaracs=e,le(t)}(n)}function ct(e){const{equipped_armor:t,Hero:n}=e,a=n.infos.class,o=Object.values(t).map((e=>e.resonance_bonuses?.class)).filter((e=>null!=e)).filter((e=>+e.identifier===a)).reduce(((e,t)=>(e[t.resonance]+=t.bonus,e)),{damage:0,ego:0});!function(e){const t=ie();t.classBonus=e,le(t)}(new V(o).divide(100).add(1).result())}async function ut(e){ge("/teams.html")&&(await o(),function(e){ke(e);const{teams_data:t}=e;if(null==t)throw new Error("teams_data is not found.")}(e),q().doSimulateTeams&&async function(e){const{teams_data:t,localStorageGetItem:n}=e,a=Se(e);if(null==a)return;const o=pe()?.mojo,r=n("battle_type"),l=Ee(r);if(null==l)return;const i=Object.fromEntries(Object.values(t).filter((e=>null!=e.id_team&&!e.locked)).map((e=>{const t=c(e,a,l),n=c(a,e),{calculateLeaguePointsTable:o}=q(),s=y("leagues"!==r?"Chance":o?"Full":"Standard",t,n);return[e.id_team,{resultPromise:s,player:t,opponent:n}]})));await s(),d();const u=new MutationObserver(d),m=document.querySelector(".teams-grid-container");function d(){const e=$(".selected-team").data("idTeam"),t=i[e];if(null==t)return;const{resultPromise:n,player:a,opponent:s}=t,l=$(".team-right-part-container .icon-area"),c=new B;if(c.updateAsync(n),c.setTooltip(P(a,s)),l.before(c.getElement().addClass("sim-left")),"leagues"===r){const e=new oe;e.updateAsync(n),n.then((t=>{e.setTooltip(Me(t))})),l.before(e.getElement().addClass("sim-right"))}if("seasons"===r&&null!=o){const e=new Te(o);e.updateAsync(n),l.before(e.getElement().addClass("sim-right"))}}null!=m&&u.observe(m,{subtree:!0,attributes:!0,attributeFilter:["class"]})}(e),function(e){const{teams_data:t,localStorageGetItem:n}=e,a=Object.values(t).find((e=>e.selected_for_battle_type.includes("leagues")));null!=a&&null!=a.id_team&&null!=a.theme&&he(a);const o=document.getElementById("btn-select-team");o?.addEventListener("click",(()=>{if("leagues"===n("battle_type")){const e=document.querySelector(".selected-team").dataset.teamIndex,n=t[e];null!=n&&null!=n.id_team&&null!=n.theme&&he(n)}}),!0)}(e))}let mt,dt=null,pt=null;async function ht(){return pt??=(async()=>{const{referrer:e}=document;if(["teams.html","leagues-pre-battle.html","league-battle.html"].some((t=>e.includes(t)))){const e=fe();if(null!=e)return e}try{const e=(await async function(){return dt??=(async()=>{const e=await fetch("teams.html"),t=await e.text();return{teams_data:JSON.parse(t.match(/var\s+teams_data\s*=\s*(\{.*?\});/)?.[1])}})(),dt}()).teams_data,t=Object.values(e).find((e=>e.selected_for_battle_type?.includes("leagues")));if(null!=t)return he(t),t}catch(e){}return fe()})(),pt}class ft{element;selectElement;callbacks=[];constructor(e,t,n){const a=$('<div class="form-control"><div class="select-group"></div></div>'),o=$('<label class="head-group"></label>').attr("for",e).text(t),s=n.map((e=>{const t=$("<option></option>").attr("value",e.value).text(e.label);return e.selected&&t.prop("selected",!0),t})),r=$('<select icon="down-arrow"></select>').attr("name",e).attr("id",e).append(s);r.on("change",(()=>{this.callbacks.forEach((e=>{e(String(r.val()))}))})),a.find(".select-group").append(o).append(r),this.element=a,this.selectElement=r,r.selectric()}onChange(e){this.callbacks.push(e)}getValue(){return String(this.selectElement.val())}getElement(){return this.element}}class gt extends et{fights;booster;output;playerTeam;opponents;currentScore;foughtCounts;cache=new Map;constructor(e,t,n,a){const o=$('<div class="sim-selectors form-wrapper"></div>'),s=new ft("sim-selector-fights","Fights",[{label:"All",value:"all"},{label:"Unfought",value:"unfought",selected:!0}]),r=new ft("sim-selector-booster","Booster",[{label:"All",value:"all",selected:!0},{label:"Boosted",value:"boosted"},{label:"Unboosted",value:"unboosted"}]),l=new ft("sim-selector-output","Output",[{label:"All",value:"all",selected:!0},{label:"Best",value:"best"}]),i=()=>{this.update()};s.onChange(i),r.onChange(i),l.onChange(i),super(o.append(s.getElement(),r.getElement(),l.getElement())),this.fights=s,this.booster=r,this.output=l,this.playerTeam=e,this.opponents=t,this.currentScore=n,this.foughtCounts=a}update(){this.setContent("Now loading..."),queueMicrotask((async()=>{const e=this.fights.getValue(),t=this.booster.getValue(),n=this.output.getValue(),a="unfought"===e;try{let o=this.opponents;a&&(o=o.filter((e=>e.numChallenges>0))),"boosted"===t&&(o=o.filter((e=>e.isBoosted))),"unboosted"===t&&(o=o.filter((e=>!e.isBoosted)));const s=await async function(e,t,n){const a=ce();if(null==a)throw new Error("Market data not found");const o=await je(e);if(null==o)throw new Error("Team data not found");const s=Fe();return await Promise.all(s.flatMap((s=>{const r=Ie(e,o,a,s.counts),l=1+.15*s.counts.mythic;return t.map((async e=>{const t=`${e.id}-${s.key}`;let a=n.get(t);null==a&&(a={boosterKey:s.key,boosterCounts:s.counts,opponentId:e.id,challenges:e.numChallenges,result:w("FastPoints",r,e.team,l)},n.set(t,a));const o=await a.result;return{...a,result:o}}))})))}(this.playerTeam,o,this.cache),r=(e,t,n)=>{let a=e.get(t);null==a&&(a=[],e.set(t,a)),a.push(n)};if("all"===n){const n=new Map;s.forEach((e=>{r(n,e.boosterKey,e)}));const o=[...n.values()].map((e=>{const t=e[0].boosterCounts,n=a?e.reduce(((e,t)=>e+t.result*t.challenges),0):3*e.reduce(((e,t)=>e+t.result),0),o=a?e.reduce(((e,t)=>e+t.challenges),0):3*e.length;return{boosterCounts:t,sum:n,challenges:o,average:n/o,result:n}}));"unfought"===e&&"all"===t?this.setContent(function(e,t,n){Je(e);const a=e.filter((e=>e.boosterCounts.mythic<=0)),o=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=[...Array(Math.max(a.length,o.length))].map(((e,s)=>C(T(1,[a[s],o[s]].flatMap((e=>{const a=j(e.average),o=e.sum+t,s=o/(e.challenges+n),r=j(s);return[Ve(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${a}">${E(e.average)}</span>`,"*",`<span>${e.challenges.toFixed()}</span>`,"=",`<span style="color: ${a}">${e.sum.toFixed()}</span>`,"=>",`<span style="color: ${r}">${o.toFixed()}</span>`,`<span style="color: ${r}">(${E(s)})</span>`]}))))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(o,this.currentScore,this.foughtCounts)):this.setContent(function(e){Je(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=[...Array(Math.max(t.length,n.length))].map(((e,a)=>C(T(1,[t[a],n[a]].flatMap((e=>{const t=j(e.average);return[Ve(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(o))}if("best"===n){const n=new Map;s.forEach((e=>{r(n,e.opponentId,e)}));const[o,l]=[[...n.values()].map((e=>e.filter((e=>0==e.boosterCounts.mythic)))),[...n.values()]].map((e=>{const t=new Map;e.forEach((e=>{const n=e.reduce(((e,t)=>Math.max(e,t.result)),0);e.filter((e=>e.result>=n)).forEach((e=>{r(t,e.boosterKey,e)}))}));const n=new Set,o=[];let s=[...t.values()];for(;0!==s.length;){const e=s.sort(((e,t)=>e.length-t.length)).pop();if(0===e.length)break;o.push(e),e.forEach((e=>{n.add(e.opponentId)})),s=s.map((e=>e.filter((e=>!n.has(e.opponentId)))))}return o.map((e=>{const t=e[0].boosterCounts,n=a?e.reduce(((e,t)=>e+t.result*t.challenges),0):3*e.reduce(((e,t)=>e+t.result),0),o=a?e.reduce(((e,t)=>e+t.challenges),0):3*e.length;return{boosterCounts:t,sum:n,challenges:o,average:n/o,result:o}}))}));"unfought"===e&&"all"===t?this.setContent(function(e,t,n,a){Je(e),Je(t);const o=0===a?NaN:n/a,s=0===a?"#FFF":j(o),r=[e,t].map((e=>{const t=e.reduce(((e,t)=>e+t.sum),0),o=e.reduce(((e,t)=>e+t.challenges),0),s=t/o,r=j(s),l=t+n,i=l/(o+a);return{sum:t,challenges:o,average:s,color:r,total:l,avgTotal:i,color3:j(i)}}));return function(){const l=[...Array(Math.max(e.length,t.length))].map(((n,a)=>C(T(1,[e[a],t[a]].flatMap((e=>{if(null==e)return Array(6).fill("");const t=j(e.average);return[Ve(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))))));return $('<table class="sim-booster-table"></table>').append(C(T(6,["No AME","All"])),l.join(""),C(T(1,r.flatMap((e=>["Sum",`<span class="sim-points" style="color: ${e.color}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${e.color}">${e.sum.toFixed()}</span>`])))),C(T(1,r.flatMap((e=>["Current score",`<span style="color: ${s}">${Number.isNaN(o)?"?":E(o)}</span>`,"*",`<span>${a}</span>`,"=",`<span style="color: ${s}">${n}</span>`])))),C(T(1,r.flatMap((e=>["Total",`<span style="color: ${e.color3}">${E(e.avgTotal)}</span>`,"*",`<span>${e.challenges+a}</span>`,"=",`<span style="color: ${e.color3}">${e.total.toFixed()}</span>`]))))).prop("outerHTML")}()}(o,l,this.currentScore,this.foughtCounts)):this.setContent(function(e,t){Je(e),Je(t);const n=[e,t].map((e=>{const t=e.reduce(((e,t)=>e+t.sum),0),n=e.reduce(((e,t)=>e+t.challenges),0),a=t/n;return{sum:t,challenges:n,average:a,color:j(a)}}));return function(){const a=[...Array(Math.max(e.length,t.length))].map(((n,a)=>C(T(1,[e[a],t[a]].flatMap((e=>{if(null==e)return Array(6).fill("");const t=j(e.average);return[Ve(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))))));return $('<table class="sim-booster-table"></table>').append(C(T(6,["No AME","All"])),a.join(""),C(T(1,n.flatMap((e=>["Sum:",`<span class="sim-points" style="color: ${e.color}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${e.color}">${e.sum.toFixed()}</span>`]))))).prop("outerHTML")}()}(o,l))}}catch(e){const t=e instanceof Error?e.message:e;this.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))}show(){this.update(),super.show()}}async function bt(e){if(!ge("/tower-of-fame.html"))return;await o(),function(e){ke(e);const{opponents_list:t}=e;if(null==t)throw new Error("opponents_list is not found.")}(e);const{opponents_list:t,Hero:n}=e,a=function(e){const{Hero:t,opponents_list:n,server_now_ts:a}=e,o=t.infos.id,s=n.find((e=>+e.player.id_fighter===o));if(null==s)return;const r=s.boosters.filter((e=>+e.lifetime>a||+e.usages_remaining>0)),l=we(),i=rt(r);return i.mythic={...l.mythic,leagues:1,...i.mythic},ye(i),i}(e);!async function(e){const o=q();if(!o.doSimulateLeagueTable)return;const r=n.infos.id,l=t.find((e=>+e.player.id_fighter===r));if(null==l)return;const i=a?.mythic.leagues;if(null==i)return;const c=await ht();if(null==c)return;const u=t.filter((e=>+e.player.id_fighter!==r)),m=u.filter((e=>Object.values(e.match_history)[0].filter((e=>null!=e)).length<3)),d=(o.doSimulateFoughtOpponents?u:m).map((e=>w("Points",c,e.player.team,i).then((t=>[e.player.id_fighter,t])))),p=await Promise.all(d),h=Object.fromEntries(p),f=()=>{t.forEach((e=>{e.power=h[e.player.id_fighter]?.avgPoints??0})),o.replaceHHLeaguesPlusPlus&&t.forEach((e=>{e.sim={...e.sim,forSim:{...e.sim?.forSim,playerTeam:c,opponentTeam:e.player.team,mythicBoosterMultiplier:i}}}))};f();const g=t.reduce(((e,t)=>{const n=Object.values(t.match_history)[0];if(!Array.isArray(n))return e;const a=n.filter((e=>null!=e)),o=a.reduce(((e,t)=>e+parseInt(t.match_points)),0),s=3-a.length;return e+o+t.power*s}),0),b=g/(t.length-1)/3,y=3*p.reduce(((e,t)=>e+t[1].avgPoints),0),v=y/p.length/3;await s(),$('.league_table .head-column[column="match_history_sorting"] > span').attr("tooltip",`Score expected: <em>${_(g,1)}</em><br>Average: <em>${E(b)}</em>`);const k=$('.league_table .head-column[column="power"] > span');k.html(k.html().replace("Power","Sim")),k.attr("tooltip",`Sum: <em>${_(y,1)}</em><br>Average: <em>${E(v)}</em>`);const S=u.map((t=>({id:t.player.id_fighter,team:t.player.team,numChallenges:3-Object.values(t.match_history)[0].filter((e=>null!=e)).length,isBoosted:t.boosters.filter((t=>+t.lifetime>e.server_now_ts)).length>0}))),M=+l.player_league_points,T=S.reduce(((e,t)=>e+(3-t.numChallenges)),0),C=new gt(c,S,M,T),P=()=>{const e={};document.querySelectorAll(".data-row.body-row").forEach((t=>{const n=t.querySelector("[id-member]")?.getAttribute("id-member"),a=t.querySelector(".data-column[column=power]");null!=n&&null!=a&&(e[n]??=[],e[n].push(a))})),t.forEach((t=>{let n=$("<div></div>").addClass("sim-column");const a=t.player.id_fighter,s=h[a];if(null!=s){let e="";s.minPoints>=25&&(e='<div class="vCheck_mix_icn sim-mark"></div>'),n.html(`${e}${_(s.avgPoints,2)}`).css("color",j(s.avgPoints))}else if(+a===r&&o.addBoosterSimulator&&o.addBoosterSimulatorToLeagueTable){const e=$('<div class="sim-icon-button sim-icon-ame"></div>').attr("tooltip","Booster simulator");e.on("click",(()=>{C.toggle()})),n.append(e)}else n.text("-");$(e[a]).empty().append(n)}))};function x(){O().then((t=>{if(null==t)return;const n=e.opponent_fighter;null!=n?.sim&&(new t.League).display(n.sim)}))}P(),o.replaceHHLeaguesPlusPlus&&x();const L=k[0];null!=L&&new MutationObserver((()=>{f(),P(),o.replaceHHLeaguesPlusPlus&&x()})).observe(L,{childList:!0,subtree:!0});const A=document.querySelector(".league_table .data-list");null!=A&&new MutationObserver((()=>{f(),P()})).observe(A,{childList:!0})}(e),async function(){await s();const e=document.getElementById("change_team");if(null!=e){const t=()=>{q().replaceHHLeaguesPlusPlus&&null!=mt?de({battleType:"leagues",opponentId:"",team:mt}):de(null)};e.addEventListener("click",t,!0),e.addEventListener("auxclick",t,!0)}}()}!async function(e){await o();const{IMAGES_URL:t,SITE_ROOT:n}=window;"string"==typeof t&&(e=e.replaceAll("${IMAGES_URL}",t)),"string"==typeof n&&(e=e.replaceAll("${SITE_ROOT}",n)),$(document.head).append(`<style>${e}</style>`)}(".sim-result{width:max-content;height:0;position:relative;bottom:1.25rem;line-height:1.25rem;text-align:center;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000;z-index:1}.sim-result .sim-label{font-size:.75rem}.sim-result.sim-left{margin-right:60%}.sim-result.sim-right{margin-left:60%}.opponent .sim-result.sim-top{bottom:12rem}#season-arena .opponent .sim-result.sim-top{bottom:11.5rem;line-height:1rem}.sim-result.sim-pending{color:#999}.sim-mark{display:inline-block;width:1em;height:1em;margin:-.125em .25em .125em -1.25em;background-size:1em;vertical-align:bottom}table.sim-table{border-collapse:collapse;color:#fff;background-color:#000;font-size:.75rem;line-height:1rem}table.sim-table td{padding:.25rem;border:1px solid #999}table.sim-points-table{border-collapse:collapse;color:#fff;background-color:#000;font-size:.75rem;line-height:1.25rem;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000}table.sim-points-table td{padding:1px .25rem}.sim-points-table .sim-bar-container{width:5rem}.sim-points-table .sim-bar{height:1.25rem;margin-bottom:-1.25rem;background-color:#ccf9}.sim-column{text-align:center;text-wrap:nowrap}.sim-column .sim-mark{margin:.25em 0}.player_team_block{min-width:15rem}.sim-popup{position:absolute;left:0;right:0;top:5rem;z-index:36;margin:auto;width:min-content;height:min-content;color:#fff;background-color:#000;border:.75rem solid #000;border-radius:.5rem;text-align:left}.sim-popup .close-button{position:absolute;right:-.25rem;top:-.25rem;cursor:pointer}.sim-popup .caption{font-size:1rem;line-height:1.5rem;width:max-content;margin:0 3rem .75rem 0}.sim-popup .content{font-size:.75rem;line-height:1.5rem;width:max-content;max-height:27rem;overflow-y:auto}table.sim-booster-table{border-collapse:separate;font-size:.75rem;line-height:1.5rem;width:max-content}table.sim-booster-table td span.sim-chance{margin:0 .5rem}table.sim-booster-table .sim-booster-slot{width:1.5rem;height:1.5rem;border:1px solid #fff}table.sim-booster-table .sim-booster-icon{width:100%;height:100%;background-size:contain}.sim-icon-button{display:block;width:2.5rem;height:2.5rem;background-size:contain;cursor:pointer}.sim-icon-ginseng{background-image:url('${IMAGES_URL}/pictures/items/B1.png')}.sim-icon-jujubes{background-image:url('${IMAGES_URL}/pictures/items/B2.png')}.sim-icon-chlorella{background-image:url('${IMAGES_URL}/pictures/items/B3.png')}.sim-icon-cordyceps{background-image:url('${IMAGES_URL}/pictures/items/B4.png')}.sim-icon-ame{background-image:url('${IMAGES_URL}/pictures/items/MB2.png')}.sim-icon-headband{background-image:url('${IMAGES_URL}/pictures/items/MB3.png')}.sim-icon-girl-skills{background-image:url('${IMAGES_URL}/pictures/design/girl_skills/active_skills_icon.png')}.sim-column .sim-icon-button{margin:-1rem auto}.sim-selectors.form-wrapper{display:flex;margin:-.5rem 3rem 0 0;gap:.5rem;width:min-content}.sim-selectors.form-wrapper>.form-control{width:9rem}.sim-selectors.form-wrapper>.form-control>.select-group .selectric-items{height:auto}.sim-selectors.form-wrapper>.form-control>.select-group .selectric-items li:first-of-type{padding-left:5px}.sim-traits{margin:.5rem .5rem 0 .5rem}.sim-trait-icon{display:inline-block;width:1.75rem;height:1.75rem;background-size:contain;background-position:center}"),async function(){(async function(){const e=await G;null!=e&&(e.registerGroup({key:"sim-v4",name:"Sim v4"}),F.addBattleSimulator=!1,F.doSimulateTroll=!1,F.doSimulateLeague=!1,F.doSimulateSeason=!1,F.doSimulatePantheon=!1,F.doSimulateTeams=!1,F.doSimulateEditTeam=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"BattleSimulator",label:"Battle Sim",default:!0,subSettings:[{key:"troll",default:!0,label:"Villain"},{key:"league",default:!0,label:"League"},{key:"season",default:!0,label:"Season"},{key:"pantheon",default:!0,label:"Pantheon"},{key:"teams",default:!0,label:"Team Selecting"},{key:"editTeam",default:!0,label:"Team Editing"}]},run(e){F.addBattleSimulator=!0,F.doSimulateTroll=e.troll,F.doSimulateLeague=e.league,F.doSimulateSeason=e.season,F.doSimulatePantheon=e.pantheon,F.doSimulateTeams=e.teams,F.doSimulateEditTeam=e.editTeam}}),F.doSimulateLeagueTable=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"DoSimulateLeagueTable",label:"Run simulations in the league table (maybe slow)",default:!0,subSettings:[{key:"skip",default:!0,label:"Skip fought opponents"},{key:"booster",default:!1,label:"Add booster simulator to league table"}]},run(e){F.doSimulateLeagueTable=!0,F.doSimulateFoughtOpponents=!e.skip,F.addBoosterSimulatorToLeagueTable=e.booster}}),F.calculateLeaguePointsTable=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"CalculateLeaguePointsTable",label:"Calculate each probability of league score (maybe slow)",default:!1},run(){F.calculateLeaguePointsTable=!0}}),F.addBoosterSimulator=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"BoosterSimulator",label:"Booster Sim",default:!0,subSettings:[{key:"ginseng",default:!0,label:"Ginseng"},{key:"jujubes",default:!1,label:"Jujubes"},{key:"chlorella",default:!0,label:"Chlorella"},{key:"cordyceps",default:!0,label:"Cordyceps"}]},run(e){F.addBoosterSimulator=!0,F.simulateGinseng=e.ginseng,F.simulateJujubes=e.jujubes,F.simulateChlorella=e.chlorella,F.simulateCordyceps=e.cordyceps}}),F.addSkillSimulator=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"SkillSimulator",label:"Skill Sim",default:!1,subSettings:[{key:"level5",default:!0,label:"Level 5"},{key:"level4",default:!0,label:"Level 4"},{key:"level3",default:!1,label:"Level 3"},{key:"level2",default:!1,label:"Level 2"},{key:"level1",default:!1,label:"Level 1"}]},run(e){F.addSkillSimulator=!0,F.skillLevelsToBeSimulated=[5,4,3,2,1].filter((t=>e["level"+t]))}}),F.replaceHHLeaguesPlusPlus=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"ReplaceHHLeaguesPlusPlus",label:"Replace HH Leagues++ sim",default:!0},run(){F.replaceHHLeaguesPlusPlus=!0}}),F.addGirlTraitsToGirlTooltip=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"AddGirlTraitsToGirlTooltip",label:"Add girl's traits to girl's tooltip",default:!0},run(){F.addGirlTraitsToGirlTooltip=!0}}),e.loadConfig(),e.runModules())})(),async function(){if(!ge("/tower-of-fame.html"))return;await o();const e=await O();if(null==e)return;const t=q();if(!t.replaceHHLeaguesPlusPlus)return;let n,a,s,r=t.doSimulateLeagueTable;const l=e.League;e.League=class{original;constructor(...e){this.original=new l(...e)}extract(){return this.original.extract()}display(e){s=e;let{forSim:o}=e;if(null==o){r||(r=!0,(async()=>{n=await ht(),a=ve().leagues??1;const e=s?.forSim;null!=e&&!0===e.hasAssumptions&&(e.playerTeam=n,e.mythicBoosterMultiplier=a,this.display(s))})());const t=window.hero_data,l=window.opponent_fighter;if(null!=t&&null!=l){const s=n??t.team,r=l.player.team,i=a??1,c=null==s.id_team;o={playerTeam:s,opponentTeam:r,mythicBoosterMultiplier:i,hasAssumptions:c},e.forSim=o}}if(null==o)return this.original.display(e);{let e=o.playerTeam;const s=o.opponentTeam;if(mt=s,null==o.result||o.hasAssumptions&&null!=e.id_team){e=n??e;const t=a??o.mythicBoosterMultiplier??1,{player:r,opponent:l}=function(e,t,n=1){return{player:c(e,t,n),opponent:c(t,e)}}(e,s,t);o.battleTable=P(r,l);const i=null==e.id_team;o.hasAssumptions=i;const{calculateLeaguePointsTable:u}=q(),m=u?"Full":"Standard";o.result=y(m,r,l).then((e=>({...e,hasAssumptions:i})))}const r=o.result;$(".opponent .icon-area").parent().find(".sim-result").remove();const l=new B;l.updateAsync(r),l.setTooltip(o.battleTable),$(".opponent .icon-area").before(l.getElement().addClass("sim-left"));const i=new oe;if(i.updateAsync(r),r.then((e=>{i.setTooltip(Me(e))})),$(".opponent .icon-area").before(i.getElement().addClass("sim-right")),null!=e.id_team){if(t.addBoosterSimulator){const t=new et("Booster simulator"),n=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-left").addClass("sim-top").attr("tooltip","Booster simulator");n.on("click",(async()=>{if(t.toggle(),null==o.boosterTable){t.setContent("Now loading..."),null==o.boosterResults&&(o.boosterResults=Ne(e,s));try{const e=await o.boosterResults;o.boosterTable=Ye(e)}catch(e){const t=e instanceof Error?e.message:e;o.boosterTable=`Error: ${t}<br>1. Go to the market page<br>2. Try again`}}t.setContent(o.boosterTable)})),$(".opponent .icon-area").before(n)}if(t.addSkillSimulator){const t=new et("Skill simulator"),n=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-right").addClass("sim-top").attr("tooltip","Skill simulator");n.on("click",(async()=>{if(t.toggle(),null==o.skillTable){t.setContent("Now loading..."),null==o.skillResults&&(o.skillResults=We(e,s));try{const e=await o.skillResults;o.skillTable=Ze(e)}catch(e){const t=e instanceof Error?e.message:e;o.skillTable=`Error: ${t}<br>1. Go to the market page<br>2. Try again`}}t.setContent(o.skillTable)})),$(".opponent .icon-area").before(n)}}}}}}(),[$e,Ce,ze,tt,nt,at,lt,ut,bt,Ue].forEach((e=>{queueMicrotask((()=>{e(window)}))})),async function(){await s();const e=()=>{$(".matchRating").length>0&&$(".sim-result").addClass("sim-top")};e();const t=new MutationObserver(e);document.querySelectorAll(".player_team_block.opponent, .season_arena_opponent_container").forEach((e=>{t.observe(e,{childList:!0,subtree:!0})}))}(),localStorage.removeItem("HHBattleSimulatorLastOpponentId"),localStorage.removeItem("HHBattleSimulatorLastOpponentTeam"),localStorage.removeItem("HHBattleSimulatorPlayerLeaguesTeam"),localStorage.removeItem("HHBattleSimulatorPlayerBoosterBonus")}()})();