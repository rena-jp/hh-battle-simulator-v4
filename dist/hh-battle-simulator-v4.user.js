// ==UserScript==
// @name         Hentai Heroes Battle Simulator v4
// @namespace    https://github.com/rena-jp/hh-battle-simulator-v4
// @version      4.0.1
// @description  Add a battle simulator to Hentai Heroes and related games
// @author       rena
// @match        https://*.hentaiheroes.com/*
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @grant        none
// @run-at       document-body
// @updateURL    https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.meta.js
// @downloadURL  https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.user.js
// ==/UserScript==

(()=>{"use strict";const e=new Promise((e=>{"loading"===document.readyState?window.addEventListener("DOMContentLoaded",(()=>e()),!0):e()})),t=new Promise((t=>{e.then((()=>{$((()=>t()))}))}));function n(){return e}function a(){return t}function o(e,t){const{team:n}=e,{girls:a}=n,o=Object.fromEntries(n.synergies.map((e=>[e.element.type,e.bonus_multiplier])));let r=.3*e.chance/(e.chance+t.chance);r+=o.stone;const s=["darkness","light","psychic"],i=t.team.theme;n.theme_elements.forEach((e=>{s.includes(e.type)&&i.includes(e.domination)&&(r+=.2)}));const l=e=>a.map((t=>t.skills[e]?.skill.percentage_value??0)).reduce(((e,t)=>e+t),0)/100,c=a[0]?.skills,u=(e,t)=>{const n=e?.[t]?.skill;return null==n?0:(n.percentage_value??parseFloat(n.display_value_text??0))/100},m=e=>u(c,e),d=Math.ceil(e.remaining_ego),p=m(11),h=m(12),f=m(13),g=m(14),y=u(t.team.girls[0]?.skills,14);return{attack:e.damage,defense:e.defense,ego:d,baseHitChance:1-r,critHitChance:r,critMultiplier:2+o.fire,healing:o.water,attackMultiplier:1+l(9),defenseMultiplier:1+l(10),stun:p,shield:h,reflect:f,execute:g,shieldEndurance:Math.ceil(d*h),deathThreshold:d*y}}function r(e,t){return{player:o(e,t),opponent:o(t,e)}}function s(e,t){const n=["fire","nature","stone","sun","water"];let a=1;return e.theme_elements.forEach((e=>{t.theme.includes(e.domination)&&n.includes(e.domination)&&(a+=.1)})),a}function i(e,t,n=1){const a=s(e,t),r=a*n,i=a,l=Object.fromEntries(t.synergies.map((e=>[e.element.type,e.bonus_multiplier]))).sun,c=e.caracs;return o({damage:Math.ceil(c.damage*r),defense:c.defense-Math.ceil(c.defense*l),remaining_ego:Math.ceil(c.ego*i),chance:c.chance,team:e},{chance:t.caracs.chance,team:t})}const l=(()=>{const e={FastChance:function(e,n){const a=t(e,n,(function(e,t){return 1}),(function(e,t){return 0}),(function(e,t,n,a){return e*t+n*a}));return Math.max(0,Math.min(1,a))},FastPoints:function(e,n){const a=t(e,n,(function(e,t){return Math.ceil(10*e/t)+15}),(function(e,t){return Math.ceil(10*(t-e)/t)+3}),(function(e,t,n,a){return e*t+n*a}));return Math.max(3,Math.min(25,a))},Chance:function(e,n){const a=t(e,n,(function(e,t){return{chance:1,alwaysWin:!0,neverWin:!1}}),(function(e,t){return{chance:0,alwaysWin:!1,neverWin:!0}}),(function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin}}));return a.chance=Math.max(0,Math.min(1,a.chance)),a},Points:function(e,n){const a=t(e,n,(function(e,t){return o(Math.ceil(10*e/t)+15)}),(function(e,t){return o(Math.ceil(10*(t-e)/t)+3)}),(function(e,t,n,a){return{avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints)}}));return a.avgPoints=Math.max(a.minPoints,Math.min(25,a.avgPoints)),a;function o(e){return{avgPoints:e,minPoints:e}}},Standard:function(e,n){const a=t(e,n,(function(e,t){return o(1,!0,!1,Math.ceil(10*e/t)+15)}),(function(e,t){return o(0,!1,!0,Math.ceil(10*(t-e)/t)+3)}),(function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin,avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints),maxPoints:Math.max(e.maxPoints,n.maxPoints)}}));return a.chance=Math.max(0,Math.min(1,a.chance)),a.avgPoints=Math.max(a.minPoints,Math.min(a.maxPoints,a.avgPoints)),a;function o(e,t,n,a){return{chance:e,alwaysWin:t,neverWin:n,avgPoints:a,minPoints:a,maxPoints:a}}},Full:function(e,n){const a=t(e,n,(function(e,t){return l(Math.ceil(10*e/t)+12)}),(function(e,t){return l(Math.ceil(10*(t-e)/t))}),(function(e,t,n,a){return e.map(((e,o)=>e*t+n[o]*a))})),o=a.reduce(((e,t)=>e+t)),r=[0,0,0,...a.map((e=>e/o))],[s,i]=[[3,14],[15,26]].map((e=>r.slice(...e).reduce(((e,t)=>e+t))));return{chance:i/(i+s),alwaysWin:s<=0,neverWin:i<=0,avgPoints:r.reduce(((e,t,n)=>e+t*n),0),minPoints:r.findIndex((e=>e>0)),maxPoints:r.findLastIndex((e=>e>0)),pointsTable:r};function l(e){const t=Array(23).fill(0);return t[e]=1,t}}};function t(e,t,n,a,o){const r={...e,win:n},s={...t,win:a};return i(r,e.ego,e.attack,e.defense,0,s,t.ego,t.attack,t.defense,0);function i(e,t,n,a,r,s,i,c,u,m){n*=e.attackMultiplier,u*=e.defenseMultiplier;const d=Math.max(0,Math.floor(n-u)),p=l(e,t,n,a,r,s,i,c,u,m,d),h=l(e,t,n,a,r,s,i,c,u,m,d*e.critMultiplier);return o(p,e.baseHitChance,h,e.critHitChance)}function l(e,t,n,a,r,s,l,c,u,m,d){const p=Math.ceil(d);let h=0;if(s.shield&&1<=m&&m<=s.shieldEndurance){const e=s.shieldEndurance-(m-1);h=Math.min(p,e),m+=h}const f=p-h;if(l-=Math.ceil(f),t+=Math.ceil(f*e.healing),t=Math.min(t,e.ego),e.execute&&l<=s.deathThreshold&&(l=0),s.reflect&&1<=m&&m<=2&&(!e.stun||1!=r)){m++;const n=Math.ceil(f*s.reflect);let a=0;if(e.shield&&1<=r&&r<=e.shieldEndurance){const t=e.shieldEndurance-(r-1);a=Math.min(n,t),r+=a}t-=n-a}if(l<=0)return e.win(t,e.ego);if(e.stun&&1===r)return i(e,t,n,a,++r,s,l,c,u,m);e.reflect&&0===r&&(r=1),e.shield&&0===r&&(r=1);const g=i(s,l,c,u,m,e,t,n,a,r);if(e.stun&&0===r){const d=i(e,t,n,a,r=1,s,l,c,u,m);return o(d,e.stun,g,1-e.stun)}return g}}self.addEventListener("message",(t=>{const{id:n,type:a,args:o}=t.data;try{const t=(0,e[a])(o[0],o[1]);self.postMessage({id:n,ret:t})}catch(e){self.postMessage({id:n,error:e})}}))}).toString().match(/{.+}/s)[0],c=new Blob([l],{type:"text/javascript"}),u=URL.createObjectURL(c),m=navigator?.hardwareConcurrency??1,d=[],p=new Map;let h=0,f=0;async function g(e,t,n){return await async function(e,t){const n=f++,a={id:n,type:e,args:t};return function(){let e=d[h];if(null==e){e=new Worker(u);const t=({data:e})=>{const{id:t,ret:n,error:a}=e;null!=n?p.get(t).resolve(n):p.get(t).reject(a),p.delete(t)},n=e=>{throw e};e.addEventListener("message",t),e.addEventListener("messageerror",n),e.addEventListener("error",n),d[h]=e}return h=(h+1)%m,e}().postMessage(a),new Promise(((e,t)=>{p.set(n,{resolve:e,reject:t})}))}(e,[t,n])}async function y(e,t,n,a=1){const o=i(t,n,a),r=i(n,t);return await g(e,o,r)}function _(e,t=0){return(Math.floor(Math.round(e*10**(t+1))/10)/10**t).toLocaleString()}function b(e,t=0){return(Math.round(e*10**t)/10**t).toLocaleString()}function w(e){const t=100*e;return t>=100?"100%":t>=10?`${_(t,1)}%`:t>=.01?`${_(t,2)}%`:t>=0?`${_(t,3)}%`:"0%"}function v(e){return e>=25?"25":_(e,e>24.9?3:2)}function M(e,t){return e>=2?`<td colspan="${e}">${t}</td>`:`<td>${t}</td>`}function E(e,t){return t.map((t=>M(e,t))).join("")}function k(...e){return["<tr>",...e,"</tr>"].join("")}function S(e,t){const n=(e,t)=>{let n=e.attack,a=t.defense;const o=[];for(let t=0;t<10;t++){const t=Math.max(0,Math.floor(n-a)),r=[];r.push(t),r.push(Math.ceil(t*e.healing)),r.push(Math.ceil(t*e.critMultiplier)),r.push(Math.ceil(t*e.critMultiplier*e.healing)),o.push(r),n*=e.attackMultiplier,a*=e.defenseMultiplier}return o},a=n(e,t),o=n(t,e),r=[e,t].flatMap((e=>[e.baseHitChance,e.critHitChance]));return $('<table class="sim-table"></table>').append(k(M(1,""),E(4,["Player","Opponent"]))).append(k(M(1,""),E(2,["Normal","Critical"]).repeat(2))).append(k(M(1,"%"),E(2,r.map((e=>w(e)))))).append(k(M(1,""),E(1,["Damage","Healing"]).repeat(4))).append([...Array(9)].map(((e,t)=>t+1)).map((e=>k(M(1,e),...[a,o].map((t=>E(1,t[e].map((e=>e.toLocaleString())))))))).join("")).prop("outerHTML")}function P(e,t,n){return e<=t?t:e>=n?n:e}function x(e){return Math.round(255*Math.sqrt(P(e,0,1)))}function C(e){return`rgb(${x(2-2*e)}, ${x(2*e)}, 0)`}function I(e){return C(P(e,0,1)**3)}function L(e){return C(((P(e,3,25)-3)/22)**3)}window.HHBattleSimulator={simulateFromFighters:async(e,t)=>await async function(e,t,n){const a=o(t,n),r=o(n,t);return await g("Standard",a,r)}(0,e,t),simulateFromTeams:async(e,t,n=1)=>await y("Standard",e,t,n)};class A{element;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),queueMicrotask((async()=>{const t=await e,n=t.hasAssumptions?"?":"";let a="";t.alwaysWin&&(a='<div class="vCheck_mix_icn sim-mark"></div>'),t.neverWin&&(a='<div class="xUncheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">P[W]:</div>${a}<span class="sim-chance">${w(t.chance)}${n}</span>`).css("color",I(t.chance))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">P[W]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}function T(e,t){return null!=e?+e:t}function H(e,t,n){return Array.isArray(t)?e.reduce(((e,a,o)=>(e[a]=T(t[o],n),e)),{}):e.reduce(((e,a)=>(e[a]=T(t[a],n),e)),{})}function O(e,t,n,a){return"number"==typeof n?e.reduce(((e,o)=>(e[o]=a(t[o],n),e)),{}):e.reduce(((e,o)=>(e[o]=a(t[o],n[o]),e)),{})}function B(e,t,n){return O(e,t,n,((e,t)=>e+t))}function j(e,t,n){return O(e,t,n,((e,t)=>e*t))}function G(e,t){return e.reduce(((e,n)=>(e[n]=Math.floor(t[n]),e)),{})}class W{keys;value;constructor(e,t={}){this.keys=e,this.value=H(e,t,0)}add(e){return this.value=B(this.keys,this.value,e),this}subtract(e){return this.value=O(this.keys,this.value,e,((e,t)=>e-t)),this}multiply(e){return this.value=j(this.keys,this.value,e),this}divide(e){return this.value=O(this.keys,this.value,e,((e,t)=>e/t)),this}truncate(){return this.value=G(this.keys,this.value),this}round(){var e,t;return this.value=(e=this.keys,t=this.value,e.reduce(((e,n)=>(e[n]=Math.round(t[n]),e)),{})),this}result(){return this.value}}const q=["damage","defense","ego","chance"];class F extends W{constructor(e={}){super(q,e)}}function R(e){return H(q,e,0)}function U(e){return H(q,e,1)}function z(e,t){return B(q,e,t)}function D(e,t){return j(q,e,t)}const N=["hardcore_stats","charm_stats","know_how_stats","endurance_stats","harmony_stats"],J=["carac1","carac2","carac3","endurance","chance"];function K(e){return H(J,e,0)}function Q(e,t){return B(J,e,t)}class V extends W{constructor(e={}){super(J,e)}}function X(e,t){const n=localStorage.getItem(e);if(null==n)return t;try{const e=JSON.parse(n);return null!=e&&null!=t&&"object"==typeof e&&"object"==typeof t?{...t,...e}:e}catch(e){return n}}function Y(e,t){localStorage.setItem(e,JSON.stringify(t))}function Z(e){Y("HHBattleSimulator.HeroData",{classBonus:e.classBonus,ginsengCaracs:e.ginsengCaracs})}function ee(){return X("HHBattleSimulator.HeroData",{})}function te(){return ee().ginsengCaracs??null}function ne(e){Y("HHBattleSimulator.TeamData",{opponent:e.opponent,league:e.league,params:e.params})}function ae(){return X("HHBattleSimulator.TeamData",{})}function oe(e){const t=ae();t.opponent=e,ne(t)}function re(e){const t=ae();t.league=e??void 0,ne(t)}function se(){return ae().params??[]}function ie(e,t){const n=s(e.team,t.team);return Math.round(100*e.damage/e.team.caracs.damage/n)/100}function le(e){return Promise.all([...Array(2)].flatMap(((t,n)=>[...Array(5)].flatMap(((t,a)=>[...Array(5-a)].map(((t,o)=>{const r={ginseng:4-a-o,chlorella:o,cordyceps:a,mythic:n};return e(r).then((e=>({boosterCounts:r,result:e})))})))))))}function ce(e){Y("HHBattleSimulator.BoosterData",{normal:e.normal,mythic:e.mythic})}function ue(){return X("HHBattleSimulator.BoosterData",{})}function me(e){const t=ue();t.mythic=e,ce(t)}function de(){return ue().mythic??{}}function pe(...e){const{pathname:t}=window.location;return e.some((e=>t.includes(e)))}function he(){const e=location.search.match(/id_opponent=(\d+)/)?.[1];if(null==e)throw new Error("id_opponent is not found from url.");return e}function fe(e){const{$:t}=e;if(null==t)throw new Error("jQuery is not found.");const{localStorageGetItem:n,localStorageSetItem:a,get_lang:o,get_dec_and_sep:r}=e;if(null==n)throw new Error("localStorageGetItem is not found.");if(null==a)throw new Error("localStorageSetItem is not found.");if(null==o)throw new Error("get_lang is not found.");if(null==r)throw new Error("get_dec_and_sep is not found.");const{SITE_ROOT:s,IMAGES_URL:i}=e;if(null==s)throw new Error("SITE_ROOT is not found.");if(null==i)throw new Error("IMAGES_URL is not found.");const{Hero:l}=e;if(null==l)throw new Error("Hero is not found.")}function ge(e){const{localStorageGetItem:t}=e,n=t("battle_type"),a=ae().opponent??null;if(null==a||a.battleType!==n)return null;const o={leagues:()=>t("leagues_id"),trolls:()=>t("troll_id"),pantheon:()=>t("pantheon_id")},r=o[n]?.();return r===a.opponentId?a.team:null}function ye(e){return ue().mythic?.[e]??null}async function _e(e){pe("/troll-pre-battle.html")&&(await n(),function(e){fe(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e),function(e){const{hero_data:t,opponent_fighter:n}=e,a=ie(t,n.player),o=de();o.trolls=a,me(o)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,o=he(),r=t.player.team,s=()=>{n("battle_type","trolls"),n("troll_id",o),oe({battleType:"trolls",opponentId:o,team:r})};s(),await a();const i=document.getElementById("change_team");null!=i&&(i.addEventListener("click",s,!0),i.addEventListener("auxclick",s,!0))}(e),async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:o,opponent:s}=r(t,n.player),i=g("Chance",o,s);await a();const l=new A;l.updateAsync(i),l.setTooltip(S(o,s)),$(".opponent .icon-area").before(l.getElement().addClass("sim-left"))}(e))}class be{element;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),queueMicrotask((async()=>{const t=await e,n=t.hasAssumptions?"?":"";let a="";t.minPoints>=25&&(a='<div class="vCheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">E[P]:</div>${a}<span class="sim-points">${v(t.avgPoints)}${n}</span>`).css("color",L(t.avgPoints))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">E[P]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}function we(e){return $('<table class="sim-table"></table>').append(k(M(2,"Points"))).append(k(E(1,["Max",e.maxPoints.toFixed()]))).append(k(E(1,["Avg",(t=e.avgPoints,t>=25?"25":t>24.9?(25-parseFloat((25-t).toPrecision(2))).toLocaleString():_(t,2))]))).append(k(E(1,["Min",e.minPoints.toFixed()]))).prop("outerHTML");var t}async function ve(e){if(!pe("/edit-team.html"))return;await n(),function(e){fe(e);const{hero_data:t,teamGirls:n,theme_resonance_bonuses:a,availableGirls:o}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("teamGirls is not found.");if(null==a)throw new Error("theme_resonance_bonuses is not found.");if(null==o)throw new Error("availableGirls is not found.")}(e);const{availableGirls:t}=e,o=Object.fromEntries(t.map((e=>[e.id_girl,e]))),{get_lang:r,get_dec_and_sep:s}=e,l=s(r()).sep,c=e=>parseFloat(e.trim().replaceAll(l,"")),u=()=>{const e=e=>c($(`#stats-${e}`).text());return{damage:e("damage"),defense:e("defense"),ego:e("ego"),chance:e("chance")}},m=()=>{const e=Array(7);return document.querySelectorAll(".team-hexagon [data-girl-id]").forEach((t=>{const n=t.dataset.teamMemberPosition,a=t.dataset.girlId;null!=n&&null!=a&&(e[+n]=o[a])})),e.filter((e=>null!=e))},d=()=>({caracs:u(),total_power:c($(".team-total-power").text()),girls:m(),id_team:e.hero_data.team.id_team});!async function(e){const{hero_data:t,teamGirls:n,theme_resonance_bonuses:o,availableGirls:r,localStorageGetItem:s}=e,l=ge(e);if(null==l)return;const c=l,m=t.team;if(null==m)return;const p=new Map(Object.values(r).map((e=>[e.id_girl,e]))),h=s("battle_type"),f=ye(h);if(null==f)return;const y=Object.fromEntries(m.synergies.map((e=>[e.element.type,e.element])));let _={...m},b=!1;await a();const w=$(".player_team_block.battle_hero .icon-area"),v=new A;w.before(v.getElement().addClass("sim-left"));const M="leagues"===h?new be:null;null!=M&&w.before(M.getElement().addClass("sim-right")),P();const E=document.querySelector(".player_stats");null!=E&&new MutationObserver((function(){const e=u(),t=Array.from(document.querySelectorAll(".team-member-container[data-girl-id]")).sort(((e,t)=>Number(e.dataset.teamMemberPosition)-Number(t.dataset.teamMemberPosition))).map((e=>p.get(e.dataset.girlId)));b=!1,_.girls=t.map((e=>{const t=e.id_girl,a=n.find((e=>e.id_girl==t));if(null!=a)return{...e,skills:a.skills};const o={},r=e.skill_tiers_info[4]?.skill_points_used??0;r&&(b=!0,o[9]={skill:{percentage_value:.2*r}},o[10]={skill:{percentage_value:0}});const s=e.skill_tiers_info[5]?.skill_points_used??0;if(s>0){const t=e.element;["darkness","sun"].includes(t)&&(o[11]={skill:{percentage_value:7*s}}),["stone","light"].includes(t)&&(o[12]={skill:{percentage_value:8*s}}),["nature","psychic"].includes(t)&&(o[13]={skill:{percentage_value:20*s}}),["fire","water"].includes(t)&&(o[14]={skill:{percentage_value:6*s}})}return{...e,skills:o}}));const a=Object.fromEntries(Object.keys(y).map((e=>[e,0])));t.forEach((e=>{a[e.element]++})),_.synergies=m.synergies.map((e=>({...e,element:{type:e.element.type},bonus_multiplier:e.harem_bonus_multiplier+e.team_bonus_per_girl*a[e.element.type]})));const r=Object.entries(a).filter((([e,t])=>t>=3)).map((([e,t])=>e));if(_.theme_elements=r.map((e=>y[e])),_.theme=r.join(","),r.length>0){const t=o[""];if(t){const{defense:n,chance:a}=t;n&&(e.defense/=Math.pow(1.02,n/2)),a&&(e.chance/=Math.pow(1.04,a/4))}r.forEach((t=>{const n=o[t];if(n){const{defense:t,chance:a}=n;t&&(e.defense*=Math.pow(1.02,t/2)),a&&(e.chance*=Math.pow(1.04,a/4))}}))}_.caracs=e,P()})).observe(E,{subtree:!0,childList:!0});const k=document.querySelector(".team-hexagon");function P(){const e=b,t=i(_,c,f??1),n=i(c,_),a=g("Standard",t,n).then((t=>({...t,hasAssumptions:e})));v.updateAsync(a),v.setTooltip(S(t,n)),null!=M&&(M.updateAsync(a),a.then((e=>{M.setTooltip(we(e))})))}null!=k&&new MutationObserver((function(){const e=_.girls,t=+e[0]?.id_girl,n=new Set(e.map((e=>+e.id_girl))),a=d().girls.map((e=>+e.id_girl)),o=a[0];if(a.length==e.length&&a.every((e=>n.has(e))))return o===t?void 0:(_.girls=a.map((t=>e.find((e=>+e.id_girl==+t)))),void P());v.reset(),M?.reset()})).observe(k,{subtree:!0,attributes:!0,attributeFilter:["src"]})}(e),async function(e){const{Hero:t,hero_data:n}=e,r=ee().classBonus??null;if(null==r)return;const s=ue().normal??null;if(null==s)return;const i=D(function(e){const{caracs:t}=e.infos;return{damage:t.primary_carac_amount,defense:.25*t.secondary_caracs_sum,ego:t.endurance,chance:t.chance}}(t),r),l=e=>{const t=e.girls.flatMap((e=>e.armor.map((e=>R(e))))).reduce(((e,t)=>z(e,t)),R({})),n=(new F).add((a=e.total_power,{damage:.25*a,defense:.12*a,ego:2*a,chance:0})).multiply(r).add(t).result();var a;const o=(new F).add(e.caracs).divide(s.multiplier).subtract(s.addend).divide(z(n,i)).result(),l=D(r,o),c=D(n,o);!function(e){const t=ae();t.params??=[],t.params=[e,...t.params.filter((t=>t.teamId!==e.teamId))],ne(t)}({teamId:+e.id_team,multiplier:l,addend:c})},c=n.team,u={...c,girls:c.girls.map((e=>o[e.id_girl]))};l(u),await a();const m=document.getElementById("validate-team");null!=m&&m.parentNode?.addEventListener("click",(()=>{l(d())}),!0)}(e)}async function Me(e){pe("/league-battle.html")&&(await n(),function(e){fe(e);const{hero_fighter:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_fighter is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e),function(e){const{hero_fighter:t}=e;re(t)}(e))}function Ee(e){e.sort(((e,t)=>{const n=n=>((e,t)=>e==t?null:e-t)(n(t),n(e));return n((e=>e.result))??n((e=>e.boosterCounts.mythic))??n((e=>e.boosterCounts.cordyceps))??n((e=>e.boosterCounts.chlorella))??n((e=>e.boosterCounts.ginseng))??0}))}function ke(e,t){return`<div class="sim-booster-slot slot ${e}"><div class="sim-booster-icon sim-icon-${t}"></div></div>`}const Se=["ginseng","chlorella","cordyceps","mythic"],$e={ginseng:ke("legendary","ginseng"),chlorella:ke("legendary","chlorella"),cordyceps:ke("legendary","cordyceps"),headband:ke("mythic","headband"),ame:ke("mythic","ame")};function Pe(e,t){return Se.map((n=>$e["mythic"===n?t:n].repeat(e[n]))).join("")}class xe{element;content;constructor(e){this.element=$('<div class="sim-popup"></div>');const t=$('<div class="close-button xUncheck_mix_icn"></div>');t.on("click",(()=>{this.hide()})),this.element.append(t),this.element.append($('<h1 class="caption"></h1>').text(e));const n=$('<div class="content"></div>');this.content=n,this.element.append(n)}show(){this.element.appendTo("#contains_all")}hide(){this.element.detach()}toggle(){0===this.element.parent().length?this.element.appendTo("#contains_all"):this.element.detach()}setContent(e){this.content.html(e)}}async function Ce(e){pe("/leagues-pre-battle.html")&&(await n(),function(e){fe(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e),function(e){const{hero_data:t}=e;re(t.team)}(e),function(e){const{hero_data:t,opponent_fighter:n}=e,a=ie(t,n.player),o=de();o.leagues=a,me(o)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,o=he(),r=t.player.team,s=()=>{n("battle_type","leagues"),n("leagues_id",o),oe({battleType:"leagues",opponentId:o,team:r})};s(),await a();const i=document.getElementById("change_team");null!=i&&(i.addEventListener("click",s,!0),i.addEventListener("auxclick",s,!0))}(e),async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:o,opponent:s}=r(t,n.player),i=g("Standard",o,s);await a();const l=new A;l.updateAsync(i),l.setTooltip(S(o,s)),$(".opponent .icon-area").before(l.getElement().addClass("sim-left"));const c=new be;c.updateAsync(i),i.then((e=>{c.setTooltip(we(e))})),$(".opponent .icon-area").before(c.getElement().addClass("sim-right"))}(e),async function(e){const{hero_data:t,opponent_fighter:n}=e,o=t.team,r=n.player.team;await a();const s=new xe("Booster simulator"),i=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let l=!1;i.on("click",(()=>{l||(l=!0,s.setContent("Now calculating..."),queueMicrotask((async()=>{const e=await function(e,t){const n=te();if(null==n)return[];const a=se().find((t=>null!=e.id_team&&t.teamId===+e.id_team));return null==a?[]:le((async o=>{const{ginseng:r,chlorella:s,cordyceps:i,mythic:l}=o,c=n[r],u=new F(c).multiply(a.multiplier).add(a.addend).multiply(U({damage:1+.1*i,ego:1+.1*s})).round().result();return y("FastPoints",{...e,caracs:u},t,1+.15*l)}))}(o,r);null==e||0===e.length?s.setContent("Error<br>1. Go to the market page<br>2. Go to every team editing page (not team selecting page)<br>3. Try again"):s.setContent(function(e){Ee(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=t.map(((e,t)=>k(E(1,[Pe(e.boosterCounts,"ame"),`<span class="sim-chance" style="color: ${L(e.result)}">${v(e.result)}</span>`,Pe(n[t].boosterCounts,"ame"),`<span class="sim-chance" style="color: ${L(n[t].result)}">${v(n[t].result)}</span>`]))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(e))}))),s.toggle()})),$(".battle_hero .icon-area").before(i)}(e))}async function Ie(e){pe("/pantheon-pre-battle.html")&&(await n(),function(e){fe(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e),function(e){const{hero_data:t,opponent_fighter:n}=e,a=ie(t,n.player),o=de();o.pantheon=a,me(o)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,o=he(),r=t.player.team,s=()=>{n("battle_type","pantheon"),n("pantheon_id",o),oe({battleType:"pantheon",opponentId:o,team:r})};s(),await a();const i=document.getElementById("change_team");null!=i&&(i.addEventListener("click",s,!0),i.addEventListener("auxclick",s,!0))}(e),async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:o,opponent:s}=r(t,n.player),i=g("Chance",o,s);await a();const l=new A;l.updateAsync(i),l.setTooltip(S(o,s)),$(".opponent .icon-area").before(l.getElement().addClass("sim-left"))}(e),async function(e){const{hero_data:t,opponent_fighter:n}=e,o=t.team,r=n.player.team;await a();const s=new xe("Booster simulator"),i=$('<div class="sim-result"><div class="sim-icon-button sim-icon-headband"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let l=!1;i.on("click",(()=>{l||(l=!0,s.setContent("Now calculating..."),queueMicrotask((async()=>{const e=await async function(e,t){const n=te();if(null==n)return[];const a=se().find((t=>null!=e.id_team&&t.teamId===+e.id_team));return null==a?[]:le((async o=>{const{ginseng:r,chlorella:s,cordyceps:i,mythic:l}=o,c=n[r],u=new F(c).multiply(a.multiplier).add(a.addend).multiply(U({damage:1+.1*i,ego:1+.1*s})).round().result();return y("FastChance",{...e,caracs:u},t,1+.25*l)}))}(o,r);null==e||0===e.length?s.setContent("Error<br>1. Go to the market page<br>2. Go to every team editing page (not team selecting page)<br>3. Try again"):s.setContent(function(e){Ee(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=t.map(((e,t)=>k(E(1,[Pe(e.boosterCounts,"headband"),`<span class="sim-chance" style="color: ${I(e.result)}">${w(e.result)}</span>`,Pe(n[t].boosterCounts,"headband"),`<span class="sim-chance" style="color: ${I(n[t].result)}">${w(n[t].result)}</span>`]))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(e))}))),s.toggle()})),$(".battle_hero .icon-area").before(i)}(e))}async function Le(e){if(!pe("/season-arena.html"))return;await n(),function(e){fe(e);const{hero_data:t,caracs_per_opponent:n,opponents:a}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("caracs_per_opponent is not found.");if(null==a)throw new Error("opponents is not found.")}(e);const{hero_data:t,caracs_per_opponent:r,opponents:i}=e;!function(){const e=i[0].player,n=r[e.id_fighter],a=s(t.team,e.team),o=Math.round(100*n.damage/t.team.caracs.damage/a),l=de();l.seasons=o/100,me(l)}(),async function(){i.forEach((async e=>{const n=e.player,s=n.id_fighter,i={...t,...r[s]},l=o(i,n),c=o(n,i),u=g("Chance",l,c),m=+e.rewards.rewards.find((e=>"victory_points"===e.type)).value;await a();const d=new A;d.updateAsync(u),d.setTooltip(S(l,c));const p=function(e,t){const n=$('<div class="sim-result"></div>').addClass("sim-pending").html('<div class="sim-label">E[M]:</div>-');return queueMicrotask((async function(){const a=await e,o=a.hasAssumptions?"?":"",r=a.chance,s=1-r,i=t-40,l=t*r+i*s;n.removeClass("sim-pending").html(`<div class="sim-label">E[M]:</div><span class="sim-mojo">${b(l,2)}${o}</span>`).css("color",function(e){let t=P(e+10,0,40)/40;return t=.5-.5*Math.cos(t**2*Math.PI),C(t)}(l)).attr("tooltip",$('<table class="sim-table"></table>').append(k(M(1,""),E(1,["Win","Loss"]))).append(k(M(1,"Mojo"),E(1,[t,i].map((e=>b(e,2)))))).append(k(M(1,"%"),E(1,[r,s].map((e=>w(e)))))).append(k(M(1,"E[M]"),M(2,b(l,2)))).prop("outerHTML"))})),n}(u,m).addClass("sim-right");$(`[data-opponent="${s}"] .icon-area`).before(d.getElement().addClass("sim-left")).before(p)}))}()}const Ae={MB2:{leagues:1.15,seasons:1.15},MB3:{trolls:1.25,pantheon:1.25},MB8:{leagues:1.15,seasons:1},MB9:{leagues:1,seasons:1.15}};function Te(e){const t=new F,n=new F;let a={};return e.map((e=>e.item)).forEach((e=>{switch(e.rarity){case"common":case"rare":case"epic":n.add(R(e));break;case"legendary":t.add(R(e));break;case"mythic":const o=Ae[e.identifier];null!=o&&(a={...a,...o})}})),{normal:{multiplier:t.divide(100).add(1).result(),addend:n.result()},mythic:a}}async function He(e){pe("/shop.html")&&(await n(),function(e){fe(e);const{equipped_armor:t,equipped_booster:n}=e;if(null==t)throw new Error("equipped_armor is not found.");if(null==n)throw new Error("equipped_booster is not found.")}(e),function(e){const{equipped_booster:t}=e,n=Te(t.normal.concat(t.mythic));n.mythic={leagues:1,seasons:1,trolls:1,pantheon:1,...n.mythic},ce(n)}(e),function(e){Oe(e),Be(e);const t=e.Hero,n=t.updates;"function"==typeof n&&(t.updates=function(...t){const a=n(...t);try{Oe(e),Be(e)}catch(e){}return a})}(e))}function Oe(e){const{equipped_armor:t}=e,n=function(e,t){const n=e.infos.class,a=e.infos.harem_endurance,o=J[(n+2)%3],r=J[(n+1)%3],s=J[(n+0)%3],i=e=>e[o],l=e=>e[r]+e[s];return[...Array(5)].map(((n,o)=>{const r=function(e){const t=e.club.upgrades_data;return K(N.map((e=>t[e].level/200)))}(e),s=Q(r,K(Array(3).fill(.06*o))),c=function(e){const t=e.infos,n=t.level,a=t.class,o=[5,7,9,5,7];return K([n*o[3-a],n*o[4-a],n*o[5-a]])}(e),u=function(e){return K(e.infos)}(e),m=Q(c,u),d=Q(m,t),p=new V(d).multiply(s).truncate().result(),h=Q(t,p);let f=(4*i(m)+t.endurance+a)*(1+s.endurance);f+=4*i(h),f=Math.floor(f);let g=(l(m)/2+t.chance)*(1+s.chance);g+=l(h)/2,g=Math.round(g);const y=Q(d,p);y.endurance=f,y.chance=g;const _=G(J,y);return{damage:i(_),defense:.25*l(_),ego:_.endurance,chance:_.chance}}))}(e.Hero,function(e){return Object.values(e).map((e=>K(e.caracs))).reduce(((e,t)=>Q(e,t)),K({}))}(t));!function(e){const t=ee();t.ginsengCaracs=e,Z(t)}(n)}function Be(e){const{equipped_armor:t,Hero:n}=e,a=n.infos.class,o=Object.values(t).map((e=>e.resonance_bonuses?.class)).filter((e=>null!=e)).filter((e=>+e.identifier===a)).reduce(((e,t)=>(e[t.resonance]+=t.bonus,e)),{damage:0,ego:0});!function(e){const t=ee();t.classBonus=e,Z(t)}(new F(o).divide(100).add(1).result())}async function je(e){pe("/teams.html")&&(await n(),function(e){fe(e);const{teams_data:t}=e;if(null==t)throw new Error("teams_data is not found.")}(e),async function(e){const{teams_data:t,localStorageGetItem:n}=e,o=ge(e);if(null==o)return;const r=n("battle_type"),s=ye(r);if(null==s)return;const l=Object.fromEntries(Object.values(t).filter((e=>null!=e.id_team&&!e.locked)).map((e=>{const t=i(e,o,s),n=i(o,e),a=g("Standard",t,n);return[e.id_team,{resultPromise:a,player:t,opponent:n}]})));await a(),m();const c=new MutationObserver(m),u=document.querySelector(".teams-grid-container");function m(){const e=$(".selected-team").data("idTeam"),t=l[e];if(null==t)return;const{resultPromise:n,player:a,opponent:o}=t,s=$(".team-right-part-container .icon-area"),i=new A;if(i.updateAsync(n),i.setTooltip(S(a,o)),s.before(i.getElement().addClass("sim-left")),"leagues"===r){const e=new be;e.updateAsync(n),n.then((t=>{e.setTooltip(we(t))})),s.before(e.getElement().addClass("sim-right"))}}null!=u&&c.observe(u,{subtree:!0,attributes:!0,attributeFilter:["class"]})}(e),function(e){const{teams_data:t,localStorageGetItem:n}=e,a=Object.values(t).find((e=>e.selected_for_battle_type.includes("leagues")));null!=a&&null!=a.id_team&&null!=a.theme&&re(a);const o=document.getElementById("btn-select-team");o?.addEventListener("click",(()=>{if("leagues"===n("battle_type")){const e=document.querySelector(".selected-team").dataset.teamIndex,n=t[e];null!=n&&null!=n.id_team&&null!=n.theme&&re(n)}}),!0)}(e))}const Ge={doSimulateLeagueTable:!0,doSimulateFoughtOpponents:!0};function We(){return Ge}async function qe(e){if(!pe("/tower-of-fame.html"))return;await n(),function(e){fe(e);const{opponents_list:t}=e;if(null==t)throw new Error("opponents_list is not found.")}(e);const{opponents_list:t,Hero:o}=e,r=function(e){const{Hero:t,opponents_list:n,server_now_ts:a}=e,o=t.infos.id,r=n.find((e=>+e.player.id_fighter===o));if(null==r)return;const s=r.boosters.filter((e=>+e.lifetime>a||+e.usages_remaining>0)),i=ue(),l=Te(s);return l.mythic={...i.mythic,leagues:1,...l.mythic},ce(l),l}(e);!async function(e){const n=We();if(!n.doSimulateLeagueTable)return;const s=o.infos.id;if(null==t.find((e=>+e.player.id_fighter===s)))return;const i=r?.mythic.leagues;if(null==i)return;const l=await async function(){const{referrer:e}=document;if(["teams.html","leagues-pre-battle.html","league-battle.html"].every((t=>!e.includes(t))))try{const e=await fetch("teams.html"),t=(await e.text()).match(/var\s+teams_data\s+=\s+(\{.*\});/);if(t){const e=JSON.parse(t[1]),n=Object.values(e).find((e=>e.selected_for_battle_type?.includes("leagues")));if(null!=n)return re(n),n}}catch(e){}return ae().league??null}();if(null==l)return;let c=t.filter((e=>+e.player.id_fighter!==s));n.doSimulateFoughtOpponents||(c=c.filter((e=>Object.values(e.match_history)[0].filter((e=>null!=e)).length<3)));const u=c.map((e=>y("Points",l,e.player.team,i).then((t=>[e.player.id_fighter,t])))),m=await Promise.all(u),d=Object.fromEntries(m),p=()=>{t.forEach((e=>{e.power=d[e.player.id_fighter]?.avgPoints??0}))};p();const h=t.reduce(((e,t)=>{const n=Object.values(t.match_history)[0];if(!Array.isArray(n))return e;const a=n.filter((e=>null!=e)),o=a.reduce(((e,t)=>e+parseInt(t.match_points)),0),r=3-a.length;return e+o+t.power*r}),0),f=h/(t.length-1)/3,g=3*m.reduce(((e,t)=>e+t[1].avgPoints),0),b=g/m.length/3;await a(),$('.league_table .head-column[column="match_history_sorting"] > span').attr("tooltip",`Score expected: <em>${_(h,1)}</em><br>Average: <em>${v(f)}</em>`);const w=$('.league_table .head-column[column="power"] > span');w.html(w.html().replace("Power","Sim")),w.attr("tooltip",`Sum: <em>${_(g,1)}</em><br>Average: <em>${v(b)}</em>`);const M=()=>{const e={};document.querySelectorAll(".data-row.body-row").forEach((t=>{const n=t.querySelector("[id-member]")?.getAttribute("id-member"),a=t.querySelector(".data-column[column=power]");null!=n&&null!=a&&(e[n]??=[],e[n].push(a))})),t.forEach((t=>{let n=$("<div></div>").addClass("sim-column");const a=t.player.id_fighter,o=d[a];if(null!=o){let e="";o.minPoints>=25&&(e='<div class="vCheck_mix_icn sim-mark"></div>'),n.html(`${e}${_(o.avgPoints,2)}`).css("color",L(o.avgPoints))}else n.text("-");$(e[a]).empty().append(n)}))};M();const E=w[0];null!=E&&new MutationObserver((()=>{p(),M()})).observe(E,{childList:!0,subtree:!0});const k=document.querySelector(".league_table .data-list");null!=k&&new MutationObserver((()=>{p(),M()})).observe(k,{childList:!0})}(),async function(){await a();const e=document.getElementById("change_team");if(null!=e){const t=()=>{oe(null)};e.addEventListener("click",t,!0),e.addEventListener("auxclick",t,!0)}}()}!async function(){const e=await async function(){return null!=window.hhPlusPlusConfig||(await n(),null!=window.hhPlusPlusConfig||(await a(),null!=window.hhPlusPlusConfig||await new Promise($))),window.hhPlusPlusConfig}();null!=e&&(e.registerGroup({key:"sim_v4",name:"Sim v4"}),e.registerModule({group:"sim_v4",configSchema:{baseKey:"DoSimulateLeagueTable",label:"Run simulations in the league table (maybe slow)",default:!0,subSettings:[{key:"skip",default:!1,label:"Skip fought opponents"}]},run(e){Ge.doSimulateLeagueTable=!0,Ge.doSimulateFoughtOpponents=!e.skip}}),Ge.doSimulateLeagueTable=!1,e.loadConfig(),e.runModules())}(),async function(e){await n();const{IMAGES_URL:t,SITE_ROOT:a}=window;"string"==typeof t&&(e=e.replaceAll("${IMAGES_URL}",t)),"string"==typeof a&&(e=e.replaceAll("${SITE_ROOT}",a)),$(document.head).append(`<style>${e}</style>`)}(".sim-result{width:max-content;height:0;position:relative;bottom:1.25rem;line-height:1.25rem;text-align:center;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000;z-index:1}.sim-result .sim-label{font-size:.75rem}.sim-result.sim-left{margin-right:60%}.sim-result.sim-right{margin-left:60%}.sim-result.sim-top{bottom:12rem}#season-arena .sim-result.sim-top{bottom:11.5rem;line-height:1rem}.sim-result.sim-pending{color:#999}.sim-mark{display:inline-block;width:1em;height:1em;margin:-.125em .25em .125em -1.25em;background-size:1em;vertical-align:bottom}table.sim-table{border-collapse:collapse;color:#fff;background-color:#000;font-size:.75rem;line-height:1rem}table.sim-table td{padding:.25rem;border:1px solid #999}.sim-column{text-align:center;text-wrap:nowrap}.sim-column .sim-mark{margin:.25em 0}.player_team_block{min-width:15rem}.sim-popup{position:absolute;left:0;right:0;top:5rem;z-index:8;margin:auto;width:min-content;height:min-content;color:#fff;background-color:#000;border:.75rem solid #000;border-radius:.5rem;text-align:left}.sim-popup .close-button{position:absolute;right:-.25rem;top:-.25rem;cursor:pointer}.sim-popup .caption{font-size:1rem;line-height:1.5rem;width:max-content;margin:0 3rem .75rem 0}.sim-popup .content{font-size:.75rem;line-height:1.5rem;width:max-content}table.sim-booster-table{border-collapse:separate;font-size:.75rem;line-height:1.5rem;width:max-content}table.sim-booster-table td span.sim-chance{margin:0 .5rem}table.sim-booster-table .sim-booster-slot{width:1.5rem;height:1.5rem;border:1px solid #fff}table.sim-booster-table .sim-booster-icon{width:100%;height:100%;background-size:contain}.sim-icon-button{display:block;width:2.5rem;height:2.5rem;background-size:contain;cursor:pointer}.sim-icon-ginseng{background-image:url('${IMAGES_URL}/pictures/items/B1.png')}.sim-icon-jujubes{background-image:url('${IMAGES_URL}/pictures/items/B2.png')}.sim-icon-chlorella{background-image:url('${IMAGES_URL}/pictures/items/B3.png')}.sim-icon-cordyceps{background-image:url('${IMAGES_URL}/pictures/items/B4.png')}.sim-icon-ame{background-image:url('${IMAGES_URL}/pictures/items/MB2.png')}.sim-icon-headband{background-image:url('${IMAGES_URL}/pictures/items/MB3.png')}"),async function(){[ve,Me,Ce,Ie,Le,He,je,qe,_e].forEach((e=>{queueMicrotask((()=>{e(window)}))})),async function(){await a();const e=()=>{$(".matchRating").length>0&&$(".sim-result").addClass("sim-top")};e();const t=new MutationObserver(e);document.querySelectorAll(".player_team_block.opponent, .season_arena_opponent_container").forEach((e=>{t.observe(e,{childList:!0,subtree:!0})}))}(),localStorage.removeItem("HHBattleSimulatorLastOpponentId"),localStorage.removeItem("HHBattleSimulatorLastOpponentTeam"),localStorage.removeItem("HHBattleSimulatorPlayerLeaguesTeam")}()})();