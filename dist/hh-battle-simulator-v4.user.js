// ==UserScript==
// @name         Hentai Heroes Battle Simulator v4
// @namespace    https://github.com/rena-jp/hh-battle-simulator-v4
// @version      4.9.0
// @description  Add a battle simulator to Hentai Heroes and related games
// @author       rena
// @match        https://*.hentaiheroes.com/*
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @grant        none
// @run-at       document-body
// @updateURL    https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.meta.js
// @downloadURL  https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.user.js
// ==/UserScript==

(()=>{"use strict";var __webpack_modules__={81:(e,t,n)=>{function a(e,t){return null!=e?+e:t}function s(e,t,n){return Array.isArray(t)?e.reduce(((e,s,o)=>(e[s]=a(t[o],n),e)),{}):e.reduce(((e,s)=>(e[s]=a(t[s],n),e)),{})}function o(e,t,n,a){return"number"==typeof n?e.reduce(((e,s)=>(e[s]=a(t[s],n),e)),{}):e.reduce(((e,s)=>(e[s]=a(t[s],n[s]),e)),{})}function r(e,t,n){return o(e,t,n,((e,t)=>e+t))}function l(e,t,n){return o(e,t,n,((e,t)=>e*t))}function i(e,t){return e.reduce(((e,n)=>(e[n]=Math.floor(t[n]),e)),{})}function c(e,t,n){return e.every((e=>+t[e]==+n[e]))}n.d(t,{Af:()=>u,Is:()=>r,cM:()=>i,dd:()=>c,q4:()=>s,sw:()=>l});class u{keys;value;constructor(e,t={}){this.keys=e,this.value=s(e,t,0)}add(e){return this.value=r(this.keys,this.value,e),this}subtract(e){return this.value=o(this.keys,this.value,e,((e,t)=>e-t)),this}multiply(e){return this.value=l(this.keys,this.value,e),this}divide(e){return this.value=o(this.keys,this.value,e,((e,t)=>e/t)),this}truncate(){return this.value=i(this.keys,this.value),this}round(){var e,t;return this.value=(e=this.keys,t=this.value,e.reduce(((e,n)=>(e[n]=Math.round(t[n]),e)),{})),this}result(){return this.value}}},167:(e,t,n)=>{n.d(t,{B_:()=>m,FD:()=>l,Mn:()=>c,TF:()=>o,UV:()=>i,aO:()=>r,i3:()=>d,iH:()=>u});var a=n(81);const s=["damage","defense","ego","chance"];class o extends a.Af{constructor(e={}){super(s,e)}}function r(e){return(0,a.q4)(s,e,0)}function l(e){return(0,a.q4)(s,e,1)}function i(e){const{caracs:t}=e.infos;return{damage:t.primary_carac_amount,defense:.25*t.secondary_caracs_sum,ego:t.endurance,chance:t.chance}}function c(e){return{damage:.25*e,defense:.12*e,ego:2*e,chance:0}}function u(e,t){return(0,a.Is)(s,e,t)}function m(e,t){return(0,a.sw)(s,e,t)}function d(e,t){return(0,a.dd)(s,e,t)}},769:(e,t,n)=>{n.d(t,{n:()=>o});var a=n(275),s=n(910);function o(e,t){const n=(e,t)=>{let n=e.attack,a=t.defense;const s=[];for(let t=0;t<10;t++){const t=Math.max(0,Math.floor(n-a)),o=[];o.push(t),o.push(Math.ceil(t*e.healing)),o.push(Math.ceil(t*e.critMultiplier)),o.push(Math.ceil(t*e.critMultiplier*e.healing)),s.push(o),n*=e.attackMultiplier,a*=e.defenseMultiplier}return s},o=n(e,t),r=n(t,e),l=[e,t].flatMap((e=>[e.baseHitChance,e.critHitChance]));return $('<table class="sim-table"></table>').append((0,s.O7)((0,s.$Q)(1,""),(0,s.zF)(4,["Player","Opponent"]))).append((0,s.O7)((0,s.$Q)(1,""),(0,s.zF)(2,["Normal","Critical"]).repeat(2))).append((0,s.O7)((0,s.$Q)(1,"%"),(0,s.zF)(2,l.map((e=>(0,a.gt)(e)))))).append((0,s.O7)((0,s.$Q)(1,""),(0,s.zF)(1,["Damage","Healing"]).repeat(4))).append([...Array(9)].map(((e,t)=>t+1)).map((e=>(0,s.O7)((0,s.$Q)(1,e),...[o,r].map((t=>(0,s.zF)(1,t[e].map((e=>e.toLocaleString())))))))).join("")).prop("outerHTML")}},193:(e,t,n)=>{n.d(t,{u:()=>o});var a=n(656),s=n(275);class o{element;last;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask((async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"";let o="";t.alwaysWin&&(o='<div class="vCheck_mix_icn sim-mark"></div>'),t.neverWin&&(o='<div class="xUncheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">P[W]:</div>${o}<span class="sim-chance">${(0,s.gt)(t.chance)}${n}</span>`).css("color",(0,a.PB)(t.chance))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">P[W]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}},473:(e,t,n)=>{n.d(t,{$:()=>r});var a=n(656),s=n(275),o=n(910);class r{mojo;element;last;constructor(e){this.mojo=e,this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask((async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"",r=t.chance,l=1-r,i=this.mojo,c=i-40,u=i*r+c*l;this.element.removeClass("sim-pending").html(`<div class="sim-label">E[M]:</div><span class="sim-mojo">${(0,s.dL)(u,2)}${n}</span>`).css("color",(0,a.kG)(u)).attr("tooltip",$('<table class="sim-table"></table>').append((0,o.O7)((0,o.$Q)(1,""),(0,o.zF)(1,["Win","Loss"]))).append((0,o.O7)((0,o.$Q)(1,"Mojo"),(0,o.zF)(1,[i,c].map((e=>(0,s.dL)(e,2)))))).append((0,o.O7)((0,o.$Q)(1,"%"),(0,o.zF)(1,[r,l].map((e=>(0,s.gt)(e)))))).append((0,o.O7)((0,o.$Q)(1,"E[M]"),(0,o.$Q)(2,(0,s.dL)(u,2)))).prop("outerHTML"))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">E[M]:</div>-').css("color","")}getElement(){return this.element}}},872:(e,t,n)=>{n.d(t,{R:()=>r});var a=n(656),s=n(275),o=n(910);function r(e){if("pointsTable"in e){const t=Math.sqrt(e.pointsTable.reduce(((e,t)=>Math.max(e,t)),0)),n=e.pointsTable.map(((e,t)=>({points:t,probability:e}))).filter((e=>e.probability>0)).sort(((e,t)=>t.points-e.points)).flatMap((e=>[`<tr style="color: ${(0,a.sL)(e.points)};">`,"<td>",e.points.toFixed(),"</td>",'<td class="sim-bar-container">',`<div class="sim-bar" style="width: ${5*e.probability/t}rem;"></div>`,(0,s.HC)(e.probability),"</td>","</tr>"]));return $('<table class="sim-points-table"></table>').append(n.join("")).prop("outerHTML")}return $('<table class="sim-table"></table>').append((0,o.O7)((0,o.$Q)(2,"Points"))).append((0,o.O7)((0,o.zF)(1,["Max",e.maxPoints.toFixed()]))).append((0,o.O7)((0,o.zF)(1,["Avg",(0,s.SC)(e.avgPoints)]))).append((0,o.O7)((0,o.zF)(1,["Min",e.minPoints.toFixed()]))).prop("outerHTML")}},414:(e,t,n)=>{n.d(t,{l:()=>o});var a=n(656),s=n(275);class o{element;last;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask((async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"";let o="";t.minPoints>=25&&(o='<div class="vCheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">E[P]:</div>${o}<span class="sim-points">${(0,s.nS)(t.avgPoints)}${n}</span>`).css("color",(0,a.sL)(t.avgPoints))})),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">E[P]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}},492:(e,t,n)=>{n.d(t,{T:()=>o,i:()=>r});var a=n(2);const s={addBattleSimulator:!0,doSimulateTroll:!0,doSimulateLeague:!0,doSimulateSeason:!0,doSimulatePantheon:!0,doSimulateTeams:!0,doSimulateEditTeam:!0,doSimulateLeagueTable:!0,doSimulateFoughtOpponents:!0,addBoosterSimulatorToLeagueTable:!0,replaceHHLeaguesPlusPlus:!0,addBoosterSimulator:!0,simulateGinseng:!0,simulateJujubes:!0,simulateChlorella:!0,simulateCordyceps:!0,addSkillSimulator:!0,skillLevelsToBeSimulated:[5,4,3,2,1],calculateLeaguePointsTable:!1};async function o(){const e=await(0,a.G)();null!=e&&(e.registerGroup({key:"sim-v4",name:"Sim v4"}),s.addBattleSimulator=!1,s.doSimulateTroll=!1,s.doSimulateLeague=!1,s.doSimulateSeason=!1,s.doSimulatePantheon=!1,s.doSimulateTeams=!1,s.doSimulateEditTeam=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"BattleSimulator",label:"Battle Sim",default:!0,subSettings:[{key:"troll",default:!0,label:"Villain"},{key:"league",default:!0,label:"League"},{key:"season",default:!0,label:"Season"},{key:"pantheon",default:!0,label:"Pantheon"},{key:"teams",default:!0,label:"Team Selecting"},{key:"editTeam",default:!0,label:"Team Editing"}]},run(e){s.addBattleSimulator=!0,s.doSimulateTroll=e.troll,s.doSimulateLeague=e.league,s.doSimulateSeason=e.season,s.doSimulatePantheon=e.pantheon,s.doSimulateTeams=e.teams,s.doSimulateEditTeam=e.editTeam}}),s.doSimulateLeagueTable=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"DoSimulateLeagueTable",label:"Run simulations in the league table (maybe slow)",default:!0,subSettings:[{key:"skip",default:!0,label:"Skip fought opponents"},{key:"booster",default:!1,label:"Add booster simulator to league table"}]},run(e){s.doSimulateLeagueTable=!0,s.doSimulateFoughtOpponents=!e.skip,s.addBoosterSimulatorToLeagueTable=e.booster}}),s.calculateLeaguePointsTable=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"CalculateLeaguePointsTable",label:"Calculate each probability of league score (maybe slow)",default:!1},run(){s.calculateLeaguePointsTable=!0}}),s.addBoosterSimulator=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"BoosterSimulator",label:"Booster Sim",default:!0,subSettings:[{key:"ginseng",default:!0,label:"Ginseng"},{key:"jujubes",default:!1,label:"Jujubes"},{key:"chlorella",default:!0,label:"Chlorella"},{key:"cordyceps",default:!0,label:"Cordyceps"}]},run(e){s.addBoosterSimulator=!0,s.simulateGinseng=e.ginseng,s.simulateJujubes=e.jujubes,s.simulateChlorella=e.chlorella,s.simulateCordyceps=e.cordyceps}}),s.addSkillSimulator=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"SkillSimulator",label:"Skill Sim",default:!1,subSettings:[{key:"level5",default:!0,label:"Level 5"},{key:"level4",default:!0,label:"Level 4"},{key:"level3",default:!1,label:"Level 3"},{key:"level2",default:!1,label:"Level 2"},{key:"level1",default:!1,label:"Level 1"}]},run(e){s.addSkillSimulator=!0,s.skillLevelsToBeSimulated=[5,4,3,2,1].filter((t=>e["level"+t]))}}),s.replaceHHLeaguesPlusPlus=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"ReplaceHHLeaguesPlusPlus",label:"Replace HH Leagues++ sim",default:!0},run(){s.replaceHHLeaguesPlusPlus=!0}}),e.loadConfig(),e.runModules())}function r(){return s}},2:(e,t,n)=>{n.d(t,{D:()=>r,G:()=>l});var a=n(497);const s=(async()=>(null!=window.HHPlusPlus||(await(0,a.fl)(),null!=window.HHPlusPlus||(await(0,a.LX)(),null!=window.HHPlusPlus||await new Promise($))),window.HHPlusPlus))(),o=(async()=>(null!=window.hhPlusPlusConfig||(await(0,a.fl)(),null!=window.hhPlusPlusConfig||(await(0,a.LX)(),null!=window.hhPlusPlusConfig||await new Promise($))),window.hhPlusPlusConfig))();function r(){return s}function l(){return o}},716:(e,t,n)=>{n.d(t,{RF:()=>c,UO:()=>u,iQ:()=>i,rV:()=>l});var a=n(602),s=n(897),o=n(497),r=n(25);function l(e){const{$:t}=e;if(null==t)throw new Error("jQuery is not found.");const{localStorageGetItem:n,localStorageSetItem:a,get_lang:s,get_dec_and_sep:o}=e;if(null==n)throw new Error("localStorageGetItem is not found.");if(null==a)throw new Error("localStorageSetItem is not found.");if(null==s)throw new Error("get_lang is not found.");if(null==o)throw new Error("get_dec_and_sep is not found.");const{SITE_ROOT:r,IMAGES_URL:l}=e;if(null==r)throw new Error("SITE_ROOT is not found.");if(null==l)throw new Error("IMAGES_URL is not found.");const{Hero:i}=e;if(null==i)throw new Error("Hero is not found.")}async function i(e){await(0,o.Zp)(),l(e),async function(e){const{tooltips:t}=e;if(null==t||"object"!=typeof t)return;if(!("[data-new-girl-tooltip]"in t))return;if("function"!=typeof t["[data-new-girl-tooltip]"])return;const n=t["[data-new-girl-tooltip]"],a=new Map;t["[data-new-girl-tooltip]"]=function(...t){const s=n(...t),o=$(t[0]),r=JSON.parse(o.attr("data-new-girl-tooltip")??"").id_girl??(()=>{const e=o.is("[girl-ico-src]")?o:o.find("[girl-ico-src]");return e.attr("girl-ico-src")?.match(/pictures\/girls\/(\d+)\/ico/)?.[1]})()??(()=>{const e=o.is("img[src]")?o:o.find("img[src]");return e.attr("src")?.match(/pictures\/girls\/(\d+)\/ico/)?.[1]})();if(null!=r){const t=a.get(+r);if(null!=t){const n={"♈":"aries","♉":"taurus","♊":"gemini","♋":"cancer","♌":"leo","♍":"virgo","♎":"libra","♏":"scorpio","♐":"sagittarius","♑":"capricorn","♒":"aquarius","♓":"pisces"},a=e.IMAGES_URL+"/pictures/design/blessings_icons/",o=e=>`<span class="sim-trait-icon" style="background-image: url('${a}${e}');"></span>`,r=e=>""==e?"":o(`hair_colors/hair_color_${e}.png`),l=e=>""==e?"":o(`eye_colors/eye_color_${e}.png`),i=e=>o(`zodiac_signs/zodiac_sign_${n[e.charAt(0)]}.png`),c=e=>o(`positions/fav_pose_${e}.png`),u=['<div class="sim-traits">',r(t[0]),r(t[1])," ",l(t[2]),l(t[3])," ",i(t[4])," ",c(t[5]),"</div>"],m=s.body;s.body=m+u.join("")}}return s};const s=e=>{const t=[e.hair_color1??e.girl.hair_color1,e.hair_color2??e.girl.hair_color2,e.eye_color1??e.girl.eye_color1,e.eye_color2??e.girl.eye_color2,e.zodiac??e.girl.zodiac,e.figure??e.girl.figure];a.set(+e.id_girl,t)};if((0,r.L)("/troll-battle.html","/troll-pre-battle.html","/leagues-pre-battle.html","/pantheon-pre-battle.html")&&(e.hero_data.team.girls.map((e=>s(e))),e.opponent_fighter.player.team.girls.map((e=>s(e)))),(0,r.L)("/league-battle.html","/pantheon-battle.html","/season-battle.html")&&(e.hero_fighter.team.girls.map((e=>s(e))),e.opponent_fighter.team.girls.map((e=>s(e)))),(0,r.L)("/tower-of-fame.html")&&e.opponents_list.forEach((e=>e.player.team.girls.map((e=>s(e))))),(0,r.L)("/season-arena.html")&&(e.hero_data.team.girls.map((e=>s(e))),e.opponents.forEach((e=>e.player.team.girls.map((e=>s(e)))))),(0,r.L)("/teams.html")){const t=e.teams_data;Object.values(t).forEach((e=>{e.girls.map((e=>s(e)))}))}(0,r.L)("/edit-team.html")&&e.availableGirls.forEach((e=>s(e))),(0,r.L)("/waifu.html")&&e.girlsDataList.forEach((e=>s(e))),(0,r.L)("/path-of-valor.html","/path-of-glory.html")&&e.path_girls.forEach((e=>s(e)))}(e)}function c(e){const{localStorageGetItem:t}=e,n=t("battle_type"),a=(0,s.e$)();if(null==a||a.battleType!==n)return null;const o={leagues:()=>t("leagues_id"),trolls:()=>t("troll_id"),pantheon:()=>t("pantheon_id"),seasons:()=>a.opponentId},r=o[n]?.();return r===a.opponentId?a.team:null}function u(e){return(0,a.mw)().mythic?.[e]??null}},89:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{c:()=>fetchTeamParams,r:()=>EditTeamPage});var _dom_points__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(414),_simulator_battle__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(3),_data_fighter__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__(167),_store_hero__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(4),_store_team__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(897),_utils_async__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(497),_utils_page__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(25),_base_common__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(716),_store_booster__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(602),_dom_chance__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(193),_dom_battle_table__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(769),_dom_points_table__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(872),_simulator_team__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(888),_interop_hh_plus_plus_config__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(492),_dom_mojo__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(473);function assertEditTeamWindow(e){(0,_base_common__WEBPACK_IMPORTED_MODULE_2__.rV)(e);const{hero_data:t,teamGirls:n,theme_resonance_bonuses:a,availableGirls:s}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("teamGirls is not found.");if(null==a)throw new Error("theme_resonance_bonuses is not found.");if(null==s)throw new Error("availableGirls is not found.")}async function EditTeamPage(e){if(!(0,_utils_page__WEBPACK_IMPORTED_MODULE_4__.L)("/edit-team.html"))return;await(0,_utils_async__WEBPACK_IMPORTED_MODULE_1__.Zp)(),assertEditTeamWindow(e);const t=(0,_interop_hh_plus_plus_config__WEBPACK_IMPORTED_MODULE_3__.i)(),{availableGirls:n}=e,a=Object.fromEntries(n.map((e=>[e.id_girl,e]))),{get_lang:s,get_dec_and_sep:o}=e,r=o(s()).sep,l=e=>parseFloat(e.trim().replaceAll(r,"")),i=()=>{const e=e=>l($(`#stats-${e}`).text());return{damage:e("damage"),defense:e("defense"),ego:e("ego"),chance:e("chance")}},c=()=>{const e=Array(7);return document.querySelectorAll(".team-hexagon [data-girl-id]").forEach((t=>{const n=t.dataset.teamMemberPosition,s=t.dataset.girlId;null!=n&&null!=s&&(e[+n]=a[s])})),e.filter((e=>null!=e))},u=()=>({caracs:i(),total_power:l($(".team-total-power").text()),girls:c(),id_team:e.hero_data.team.id_team});!async function(e){const{Hero:t,hero_data:n,server_now_ts:s}=e,o=n.team;updateTeamParams({...o,girls:o.girls.map((e=>a[e.id_girl]))},t,s),await(0,_utils_async__WEBPACK_IMPORTED_MODULE_1__.LX)();const r=document.getElementById("validate-team");null!=r&&r.addEventListener("click",(()=>{updateTeamParams(u(),t,s)}),!0)}(e),t.doSimulateEditTeam&&async function(e){const{hero_data:n,teamGirls:a,theme_resonance_bonuses:s,availableGirls:o,localStorageGetItem:r}=e,l=(0,_base_common__WEBPACK_IMPORTED_MODULE_2__.RF)(e);if(null==l)return;const c=l,m=n.team;if(null==m)return;const d=new Map(Object.values(o).map((e=>[e.id_girl,e]))),p=r("battle_type"),_=(0,_base_common__WEBPACK_IMPORTED_MODULE_2__.UO)(p);if(null==_)return;const h=Object.fromEntries(m.synergies.map((e=>[e.element.type,e.element])));let f={...m},g=!1;await(0,_utils_async__WEBPACK_IMPORTED_MODULE_1__.LX)();const b=$(".player_team_block.battle_hero .icon-area"),y=new _dom_chance__WEBPACK_IMPORTED_MODULE_5__.u;b.before(y.getElement().addClass("sim-left"));const w="leagues"===p?new _dom_points__WEBPACK_IMPORTED_MODULE_6__.l:null;null!=w&&b.before(w.getElement().addClass("sim-right"));const v=(0,_store_team__WEBPACK_IMPORTED_MODULE_7__.e$)()?.mojo,E="seasons"===p&&null!=v?new _dom_mojo__WEBPACK_IMPORTED_MODULE_8__.$(v):null;null!=E&&b.before(E.getElement().addClass("sim-right")),P();const M=document.querySelector(".player_stats");null!=M&&new MutationObserver((function(){const e=i(),t=Array.from(document.querySelectorAll(".team-member-container[data-girl-id]")).sort(((e,t)=>Number(e.dataset.teamMemberPosition)-Number(t.dataset.teamMemberPosition))).map((e=>d.get(e.dataset.girlId)));g=!1,f.girls=t.map((e=>{const t=e.id_girl,n=a.find((e=>e.id_girl==t));if(null!=n)return{...e,skills:n.skills};const s={},o=e.skill_tiers_info[4]?.skill_points_used??0;o&&(g=!0,s[9]={skill:{percentage_value:.2*o}},s[10]={skill:{percentage_value:0}});const r=e.skill_tiers_info[5]?.skill_points_used??0;if(r>0){const t=e.element;["darkness","sun"].includes(t)&&(s[11]={skill:{percentage_value:7*r}}),["stone","light"].includes(t)&&(s[12]={skill:{percentage_value:8*r}}),["nature","psychic"].includes(t)&&(s[13]={skill:{percentage_value:20*r}}),["fire","water"].includes(t)&&(s[14]={skill:{percentage_value:6*r}})}return{...e,skills:s}}));const n=Object.fromEntries(Object.keys(h).map((e=>[e,0])));t.forEach((e=>{n[e.element]++})),f.synergies=m.synergies.map((e=>({...e,element:{type:e.element.type},bonus_multiplier:e.harem_bonus_multiplier+e.team_bonus_per_girl*n[e.element.type]})));const o=Object.entries(n).filter((([e,t])=>t>=3)).map((([e,t])=>e));if(f.theme_elements=o.map((e=>h[e])),f.theme=o.join(","),o.length>0){const t=s[""];if(t){const{defense:n,chance:a}=t;n&&(e.defense/=Math.pow(1.02,n/2)),a&&(e.chance/=Math.pow(1.04,a/4))}o.forEach((t=>{const n=s[t];if(n){const{defense:t,chance:a}=n;t&&(e.defense*=Math.pow(1.02,t/2)),a&&(e.chance*=Math.pow(1.04,a/4))}}))}f.caracs=e,P()})).observe(M,{subtree:!0,childList:!0});const k=document.querySelector(".team-hexagon");function P(){const e=g,n=(0,_simulator_team__WEBPACK_IMPORTED_MODULE_9__.fS)(f,c,_??1),a=(0,_simulator_team__WEBPACK_IMPORTED_MODULE_9__.fS)(c,f),s=null==w?"Chance":t.calculateLeaguePointsTable?"Full":"Standard",o=(0,_simulator_battle__WEBPACK_IMPORTED_MODULE_0__.ez)(s,n,a).then((t=>({...t,hasAssumptions:e})));if(y.updateAsync(o),y.setTooltip((0,_dom_battle_table__WEBPACK_IMPORTED_MODULE_10__.n)(n,a)),null!=w){const e=o;w.updateAsync(e),e.then((e=>{w.setTooltip((0,_dom_points_table__WEBPACK_IMPORTED_MODULE_11__.R)(e))}))}null!=E&&E.updateAsync(o)}null!=k&&new MutationObserver((function(){const e=f.girls,t=+e[0]?.id_girl,n=new Set(e.map((e=>+e.id_girl))),a=u().girls.map((e=>+e.id_girl)),s=a[0];if(a.length==e.length&&a.every((e=>n.has(e))))return s===t?void 0:(f.girls=a.map((t=>e.find((e=>+e.id_girl==+t)))),void P());y.reset(),w?.reset(),E?.reset()})).observe(k,{subtree:!0,attributes:!0,attributeFilter:["src"]})}(e)}let fetchedWindow=null,teamParams;async function fetchEditTeamPage(id_team){return fetchedWindow??=(async()=>{const page=await fetch(`edit-team.html?id_team=${id_team}`),html=await page.text(),teamGirls=JSON.parse(html.match(/var\s+teamGirls\s*=\s*(\[.*?\]);/)?.[1]),theme_resonance_bonuses=JSON.parse(html.match(/var\s+theme_resonance_bonuses\s*=\s*((?:\{|\[).*?(?:\}|\]));/)?.[1]),hero_data=eval("("+html.match(/var\s+hero_data\s*=\s*(\{.*?\});/s)?.[1]+")"),availableGirls=JSON.parse(html.match(/var\s+availableGirls\s*=\s*(\[.*?\]);/)?.[1]);return{teamGirls,theme_resonance_bonuses,hero_data,availableGirls}})(),fetchedWindow}async function fetchTeamParams(e,t,n){if(null!=teamParams)return teamParams;const a=await fetchEditTeamPage(e),s=Object.fromEntries(a.availableGirls.map((e=>[e.id_girl,e]))),o={...a.hero_data.team,girls:a.hero_data.team.girls.map((e=>s[e.id_girl]))};return teamParams=updateTeamParams(o,t,n),teamParams}function updateTeamParams(e,t,n){const a=(0,_store_hero__WEBPACK_IMPORTED_MODULE_12__.hO)();if(null==a)return;const s=(0,_store_booster__WEBPACK_IMPORTED_MODULE_13__.FL)(n);if(null==s)return;const o=(0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.B_)((0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.UV)(t),a),r=e.girls.flatMap((e=>e.armor.map((e=>(0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.aO)(e.caracs))))).reduce(((e,t)=>(0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.iH)(e,t)),(0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.aO)({})),l=(new _data_fighter__WEBPACK_IMPORTED_MODULE_14__.TF).add((0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.Mn)(e.total_power)).multiply(a).add(r).result(),i=(new _data_fighter__WEBPACK_IMPORTED_MODULE_14__.TF).add(e.caracs).divide(s.multiplier).subtract(s.addend).divide((0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.iH)(l,o)).result(),c=(0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.B_)(a,i),u=(0,_data_fighter__WEBPACK_IMPORTED_MODULE_14__.B_)(l,i),m={teamId:+e.id_team,multiplier:c,addend:u,caracs:e.caracs};return(0,_store_team__WEBPACK_IMPORTED_MODULE_7__.ZQ)(m),m}},3:(e,t,n)=>{n.d(t,{Fz:()=>_,ez:()=>p,iL:()=>h});var a=n(875),s=n(888);const o=(()=>{const e={FastChance:function(e,n){const a=t(e,n,(function(e,t){return 1}),(function(e,t){return 0}),(function(e,t,n,a){return e*t+n*a}));return Math.max(0,Math.min(1,a))},FastPoints:function(e,n){const a=t(e,n,(function(e,t){return Math.ceil(10*e/t)+15}),(function(e,t){return Math.ceil(10*(t-e)/t)+3}),(function(e,t,n,a){return e*t+n*a}));return Math.max(3,Math.min(25,a))},Chance:function(e,n){const a=t(e,n,(function(e,t){return{chance:1,alwaysWin:!0,neverWin:!1}}),(function(e,t){return{chance:0,alwaysWin:!1,neverWin:!0}}),(function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin}}));return a.chance=Math.max(0,Math.min(1,a.chance)),a},Points:function(e,n){const a=t(e,n,(function(e,t){return s(Math.ceil(10*e/t)+15)}),(function(e,t){return s(Math.ceil(10*(t-e)/t)+3)}),(function(e,t,n,a){return{avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints)}}));return a.avgPoints=Math.max(a.minPoints,Math.min(25,a.avgPoints)),a;function s(e){return{avgPoints:e,minPoints:e}}},Standard:function(e,n){const a=t(e,n,(function(e,t){return s(1,!0,!1,Math.ceil(10*e/t)+15)}),(function(e,t){return s(0,!1,!0,Math.ceil(10*(t-e)/t)+3)}),(function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin,avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints),maxPoints:Math.max(e.maxPoints,n.maxPoints)}}));return a.chance=Math.max(0,Math.min(1,a.chance)),a.avgPoints=Math.max(a.minPoints,Math.min(a.maxPoints,a.avgPoints)),a;function s(e,t,n,a){return{chance:e,alwaysWin:t,neverWin:n,avgPoints:a,minPoints:a,maxPoints:a}}},Full:function(e,n){const a=t(e,n,(function(e,t){return i(Math.ceil(10*e/t)+12)}),(function(e,t){return i(Math.ceil(10*(t-e)/t))}),(function(e,t,n,a){return e.map(((e,s)=>e*t+n[s]*a))})),s=a.reduce(((e,t)=>e+t)),o=[0,0,0,...a.map((e=>e/s))],[r,l]=[[3,14],[15,26]].map((e=>o.slice(...e).reduce(((e,t)=>e+t))));return{chance:l/(l+r),alwaysWin:r<=0,neverWin:l<=0,avgPoints:o.reduce(((e,t,n)=>e+t*n),0),minPoints:o.findIndex((e=>e>0)),maxPoints:o.findLastIndex((e=>e>0)),pointsTable:o};function i(e){const t=Array(23).fill(0);return t[e]=1,t}}};function t(e,t,n,a,s){const o={...e,win:n},r={...t,win:a};return l(o,e.ego,e.attack,e.defense,0,r,t.ego,t.attack,t.defense,0);function l(e,t,n,a,o,r,l,c,u,m){n*=e.attackMultiplier,u*=e.defenseMultiplier;const d=Math.max(0,Math.floor(n-u)),p=i(e,t,n,a,o,r,l,c,u,m,d),_=i(e,t,n,a,o,r,l,c,u,m,d*e.critMultiplier);return s(p,e.baseHitChance,_,e.critHitChance)}function i(e,t,n,a,o,r,i,c,u,m,d){const p=Math.ceil(d);let _=0;if(r.shield&&1<=m&&m<=r.shieldEndurance){const e=r.shieldEndurance-(m-1);_=Math.min(p,e),m+=_}const h=p-_;if(i-=Math.ceil(h),t+=Math.ceil(h*e.healing),t=Math.min(t,e.ego),e.execute&&i<=r.deathThreshold&&(i=0),r.reflect&&1<=m&&m<=2&&(!e.stun||1!=o)){m++;const n=Math.ceil(h*r.reflect);let a=0;if(e.shield&&1<=o&&o<=e.shieldEndurance){const t=e.shieldEndurance-(o-1);a=Math.min(n,t),o+=a}t-=n-a}if(i<=0)return e.win(t,e.ego);if(e.stun&&1===o)return l(e,t,n,a,++o,r,i,c,u,m);e.reflect&&0===o&&(o=1),e.shield&&0===o&&(o=1);const f=l(r,i,c,u,m,e,t,n,a,o);if(e.stun&&0===o){const d=l(e,t,n,a,o=1,r,i,c,u,m);return s(d,e.stun,f,1-e.stun)}return f}}self.addEventListener("message",(t=>{const{id:n,type:a,args:s}=t.data;try{const t=(0,e[a])(s[0],s[1]);self.postMessage({id:n,ret:t})}catch(e){self.postMessage({id:n,error:e})}}))}).toString().match(/{.+}/s)[0],r=new Blob([o],{type:"text/javascript"}),l=URL.createObjectURL(r),i=navigator?.hardwareConcurrency??1,c=[],u=new Map;let m=0,d=0;async function p(e,t,n){return await async function(e,t){const n=d++,a={id:n,type:e,args:t};return function(){let e=c[m];if(null==e){e=new Worker(l);const t=({data:e})=>{const{id:t,ret:n,error:a}=e;null!=n?u.get(t).resolve(n):u.get(t).reject(a),u.delete(t)},n=e=>{throw e};e.addEventListener("message",t),e.addEventListener("messageerror",n),e.addEventListener("error",n),c[m]=e}return m=(m+1)%i,e}().postMessage(a),new Promise(((e,t)=>{u.set(n,{resolve:e,reject:t})}))}(e,[t,n])}async function _(e,t,n){const s=(0,a.S)(t,n),o=(0,a.S)(n,t);return await p(e,s,o)}async function h(e,t,n,a=1){const o=(0,s.fS)(t,n,a),r=(0,s.fS)(n,t);return await p(e,o,r)}},875:(e,t,n)=>{function a(e,t){const{team:n}=e,{girls:a}=n,s=Object.fromEntries(n.synergies.map((e=>[e.element.type,e.bonus_multiplier])));let o=.3*e.chance/(e.chance+t.chance);o+=s.stone;const r=["darkness","light","psychic"],l=t.team.theme;n.theme_elements.forEach((e=>{r.includes(e.type)&&l.includes(e.domination)&&(o+=.2)}));const i=e=>a.map((t=>t.skills[e]?.skill.percentage_value??0)).reduce(((e,t)=>e+t),0)/100,c=a[0]?.skills,u=(e,t)=>{const n=e?.[t]?.skill;return null==n?0:(n.percentage_value??parseFloat(n.display_value_text??0))/100},m=e=>u(c,e),d=Math.ceil(e.remaining_ego),p=m(11),_=m(12),h=m(13),f=m(14),g=u(t.team.girls[0]?.skills,14);return{attack:e.damage,defense:e.defense,ego:d,baseHitChance:1-o,critHitChance:o,critMultiplier:2+s.fire,healing:s.water,attackMultiplier:1+i(9),defenseMultiplier:1+i(10),stun:p,shield:_,reflect:h,execute:f,shieldEndurance:Math.ceil(d*_),deathThreshold:d*g}}function s(e,t){return{player:a(e,t),opponent:a(t,e)}}n.d(t,{P:()=>s,S:()=>a})},888:(e,t,n)=>{n.d(t,{NU:()=>r,fS:()=>o,m8:()=>s});var a=n(875);function s(e,t){const n=["fire","nature","stone","sun","water"];let a=1;return e.theme_elements.forEach((e=>{t.theme.includes(e.domination)&&n.includes(e.domination)&&(a+=.1)})),a}function o(e,t,n=1){const o=s(e,t),r=o*n,l=o,i=Object.fromEntries(t.synergies.map((e=>[e.element.type,e.bonus_multiplier]))).sun,c=e.caracs;return(0,a.S)({damage:Math.ceil(c.damage*r),defense:c.defense-Math.ceil(c.defense*i),remaining_ego:Math.ceil(c.ego*l),chance:c.chance,team:e},{chance:t.caracs.chance,team:t})}function r(e,t,n=1){return{player:o(e,t,n),opponent:o(t,e)}}},602:(e,t,n)=>{n.d(t,{FL:()=>c,Lg:()=>l,R5:()=>i,mw:()=>r,uJ:()=>o});var a=n(167),s=n(53);function o(e){(0,s.t)("HHBattleSimulator.BoosterData",{normals:e.normals,mythic:e.mythic})}function r(){return(0,s.f)("HHBattleSimulator.BoosterData",{})}function l(e){const t=r();t.mythic=e,o(t)}function i(){return r().mythic??{}}function c(e){const{normals:t}=r();if(null==t)return null;const n=new a.TF,s=new a.TF;return t.forEach((t=>{t.lifetime<e||(null!=t.multiplier&&n.add(t.multiplier),null!=t.addend&&s.add(t.addend))})),{multiplier:n.divide(100).add(1).result(),addend:s.result()}}},4:(e,t,n)=>{n.d(t,{TJ:()=>c,hO:()=>l,j4:()=>i,pc:()=>r});var a=n(53);function s(e){(0,a.t)("HHBattleSimulator.HeroData",{classBonus:e.classBonus,ginsengCaracs:e.ginsengCaracs})}function o(){return(0,a.f)("HHBattleSimulator.HeroData",{})}function r(e){const t=o();t.classBonus=e,s(t)}function l(){return o().classBonus??null}function i(e){const t=o();t.ginsengCaracs=e,s(t)}function c(){return o().ginsengCaracs??null}},897:(e,t,n)=>{n.d(t,{EI:()=>r,UH:()=>c,ZQ:()=>u,d6:()=>m,e$:()=>l,p6:()=>i});var a=n(53);function s(e){(0,a.t)("HHBattleSimulator.TeamData",{opponent:e.opponent,league:e.league,params:e.params})}function o(){return(0,a.f)("HHBattleSimulator.TeamData",{})}function r(e){const t=o();t.opponent=e,s(t)}function l(){return o().opponent??null}function i(e){const t=o();t.league=e??void 0,s(t)}function c(){return o().league??null}function u(e){const t=o();t.params??=[],t.params=[e,...t.params.filter((t=>t.teamId!==e.teamId))],s(t)}function m(){return o().params??[]}},497:(e,t,n)=>{n.d(t,{LX:()=>i,Zp:()=>l,fl:()=>r});const a=new Promise((e=>{const t=()=>{null!=window.$&&e()};"loading"===document.readyState?window.addEventListener("DOMContentLoaded",t,!0):t()})),s=new Promise((e=>{a.then((()=>{queueMicrotask(e)}))})),o=new Promise((e=>{s.then((()=>{$(e)}))}));function r(){return a}function l(){return s}function i(){return o}},656:(e,t,n)=>{function a(e,t,n){return e<=t?t:e>=n?n:e}function s(e){return Math.round(255*Math.sqrt(a(e,0,1)))}function o(e){return`rgb(${s(2-2*e)}, ${s(2*e)}, 0)`}function r(e){return o(a(e,0,1)**3)}function l(e){let t=a(e+10,0,40)/40;return t=.5-.5*Math.cos(t**2*Math.PI),o(t)}function i(e){return o(((a(e,3,25)-3)/22)**3)}n.d(t,{PB:()=>r,kG:()=>l,sL:()=>i})},25:(e,t,n)=>{function a(...e){const{pathname:t}=window.location;return e.some((e=>t.includes(e)))}function s(){const e=location.search.match(/id_opponent=(\d+)/)?.[1];if(null==e)throw new Error("id_opponent is not found from url.");return e}n.d(t,{L:()=>a,P:()=>s})},53:(e,t,n)=>{function a(e,t){const n=localStorage.getItem(e);if(null==n)return t;try{const e=JSON.parse(n);return null!=e&&null!=t&&"object"==typeof e&&"object"==typeof t?{...t,...e}:e}catch(e){return n}}function s(e,t){localStorage.setItem(e,JSON.stringify(t))}n.d(t,{f:()=>a,t:()=>s})},275:(e,t,n)=>{function a(e,t=0){return(Math.floor(Math.round(e*10**(t+1))/10)/10**t).toLocaleString()}function s(e,t=0){return(Math.round(e*10**t)/10**t).toLocaleString()}function o(e){const t=100*e;return t>=100?"100%":t>=10?`${a(t,1)}%`:t>=.01?`${a(t,2)}%`:t>=0?`${a(t,3)}%`:"0%"}function r(e){const t=100*e;return t>=100?"100%":t>=.01?`${a(t,2)}%`:t>=0?`${a(t,3)}%`:"0%"}function l(e){return e>=25?"25":a(e,e>24.9?3:2)}function i(e){return e>=25?"25":e>24.9?(25-parseFloat((25-e).toPrecision(2))).toLocaleString():a(e,2)}function c(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}n.d(t,{HC:()=>r,SC:()=>i,dL:()=>s,gt:()=>o,kC:()=>c,nS:()=>l,v8:()=>a})},910:(e,t,n)=>{function a(e,t){return e>=2?`<td colspan="${e}">${t}</td>`:`<td>${t}</td>`}function s(e,t){return t.map((t=>a(e,t))).join("")}function o(...e){return["<tr>",...e,"</tr>"].join("")}n.d(t,{$Q:()=>a,O7:()=>o,zF:()=>s})}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};(()=>{var e=__webpack_require__(497),t=__webpack_require__(3);window.HHBattleSimulator={simulateFromFighters:async(e,n)=>await(0,t.Fz)("Standard",e,n),simulateFromTeams:async(e,n,a=1)=>await(0,t.iL)("Standard",e,n,a)};var n=__webpack_require__(769),a=__webpack_require__(193),s=__webpack_require__(492),o=__webpack_require__(167),r=__webpack_require__(81);const l=["hardcore_stats","charm_stats","know_how_stats","endurance_stats","harmony_stats"],i=["carac1","carac2","carac3","endurance","chance"];function c(e){return(0,r.q4)(i,e,0)}function u(e,t){return(0,r.Is)(i,e,t)}class m extends r.Af{constructor(e={}){super(i,e)}}var d=__webpack_require__(89),p=__webpack_require__(4),_=__webpack_require__(897),h=__webpack_require__(275),f=__webpack_require__(888);function g(e,t){const n=(0,f.m8)(e.team,t.team);return Math.round(100*e.damage/e.team.caracs.damage/n)/100}async function b(e){if(null==e.id_team)return;const t=e.id_team,n=(0,_.d6)().find((e=>e.teamId===+t));return null!=n?.caracs&&(0,o.i3)(n.caracs,e.caracs)?n:null!=window.Hero?await(0,d.c)(t,window.Hero,window.server_now_ts):void 0}const y=["ginseng","jujubes","chlorella","cordyceps","mythic"];function w(e,t,n,a){const{ginseng:s,jujubes:r,chlorella:l,cordyceps:i}=a,c=n[s];return{...e,caracs:new o.TF(c).multiply(t.multiplier).add(t.addend).multiply((0,o.FD)({damage:1+.1*i,ego:1+.1*l,chance:1+.2*r})).round().result()}}function v(e,t){const n={...e.girls[0].skills};[11,12,13,14].forEach((e=>{delete n[e]})),n[t.skill.id_skill]=t;const a=[...e.girls];return a[0]={...e.girls[0],skills:n},{...e,girls:a}}let E=null;function M(){if(null==E){const{simulateGinseng:e,simulateJujubes:t,simulateChlorella:n,simulateCordyceps:a}=(0,s.i)();E=[...Array(2)].flatMap(((s,o)=>[...Array(a?5:1)].flatMap(((a,s)=>[...Array(n?5-s:1)].flatMap(((n,a)=>[...Array(t?5-s-a:1)].flatMap(((t,n)=>{const r=4-s-a-n;return!e&&r>0?[]:{key:`${r}${n}${a}${s}${o}`,counts:{ginseng:r,jujubes:n,chlorella:a,cordyceps:s,mythic:o}}}))))))))}return E}async function k(e){const t=M();return Promise.all(t.map((async({counts:t})=>({boosterCounts:t,result:await e(t)}))))}async function P(e,n){const a=(0,p.TJ)();if(null==a)throw new Error("Market data not found");const s=await b(e);if(null==s)throw new Error("Team data not found");return k((async o=>{const r=w(e,s,a,o),l=1+.15*o.mythic;return(0,t.iL)("FastPoints",r,n,l)}))}async function S(e){const t={11:{skillType:"stun",levelPercentage:7},12:{skillType:"shield",levelPercentage:8},13:{skillType:"reflect",levelPercentage:20},14:{skillType:"execute",levelPercentage:6}},n=(0,s.i)().skillLevelsToBeSimulated;return 0===n.length?[]:Promise.all([11,12,13,14].map((async a=>{const s=await Promise.all(n.map((async n=>{const s=((e,n)=>{const{skillType:a,levelPercentage:s}=t[e],o=n*s;return{id_skill:e.toString(),level:n.toString(),skill:{id_skill:e,level:n,percentage_value:o,display_value_text:`${o}%`,skill_type:a}}})(a,n);return{level:n,results:await k((async t=>e(t,s)))}})));return{skillName:(0,h.kC)(t[a].skillType),results:s}})))}async function L(e,n){const a=(0,p.TJ)();if(null==a)throw new Error("Market data not found");const s=await b(e);if(null==s)throw new Error("Team data not found");return S((async(o,r)=>{const l=v(w(e,s,a,o),r),i=1+.15*o.mythic;return(0,t.iL)("FastPoints",l,n,i)}))}var T=__webpack_require__(875),C=__webpack_require__(602),O=__webpack_require__(25),B=__webpack_require__(716);async function A(o){if(!(0,O.L)("/troll-pre-battle.html"))return;await(0,e.Zp)(),function(e){(0,B.rV)(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(o);const r=(0,s.i)();!function(e){const{hero_data:t,opponent_fighter:n}=e,a=g(t,n.player),s=(0,C.R5)();s.trolls=a,(0,C.Lg)(s)}(o),async function(t){const{opponent_fighter:n,localStorageSetItem:a}=t,s=(0,O.P)(),o=n.player.team,r=()=>{a("battle_type","trolls"),a("troll_id",s),(0,_.EI)({battleType:"trolls",opponentId:s,team:o})};r(),await(0,e.LX)();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(o),r.doSimulateTroll&&async function(s){const{hero_data:o,opponent_fighter:r}=s,{player:l,opponent:i}=(0,T.P)(o,r.player),c=(0,t.ez)("Chance",l,i);await(0,e.LX)();const u=new a.u;u.updateAsync(c),u.setTooltip((0,n.n)(l,i)),$(".opponent .icon-area").before(u.getElement().addClass("sim-left"))}(o)}async function I(t){(0,O.L)("/league-battle.html")&&(await(0,e.Zp)(),function(e){(0,B.rV)(e);const{hero_fighter:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_fighter is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(t),function(e){const{hero_fighter:t}=e;(0,_.p6)(t)}(t))}var x=__webpack_require__(656),D=__webpack_require__(910);function H(e){e.sort(((e,t)=>{const n=n=>((e,t)=>e==t?null:e-t)(n(t),n(e));return n((e=>e.result))??n((e=>e.boosterCounts.mythic))??n((e=>e.boosterCounts.cordyceps))??n((e=>e.boosterCounts.chlorella))??n((e=>e.boosterCounts.jujubes))??n((e=>e.boosterCounts.ginseng))??0}))}function F(e,t){return`<div class="sim-booster-slot slot ${e}"><div class="sim-booster-icon sim-icon-${t}"></div></div>`}const R={ginseng:F("legendary","ginseng"),jujubes:F("legendary","jujubes"),chlorella:F("legendary","chlorella"),cordyceps:F("legendary","cordyceps"),headband:F("mythic","headband"),ame:F("mythic","ame")};function j(e,t){return y.map((n=>R["mythic"===n?t:n].repeat(e[n]))).join("")}function q(e){return e.forEach((e=>{e.results.forEach((e=>{H(e.results)}))})),function(){const t=[5,4,3,2,1].map((t=>{return n=t,(0,D.O7)((0,D.zF)(1,e.map((e=>function(e){const t=e.skillName,a=e.results.find((e=>e.level===n))?.results;return null==a?"":function(e){return["<table>",(0,D.O7)((0,D.$Q)(2,`Level ${n} ${t}`)),...e.map((e=>(0,D.O7)((0,D.zF)(1,[j(e.boosterCounts,"headband"),`<span class="sim-chance" style="color: ${(0,x.PB)(e.result)}">${(0,h.HC)(e.result)}</span>`])))),"</table>"].join("")}(a)}(e)))));var n}));return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}function W(e){H(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=t.map(((e,t)=>(0,D.O7)((0,D.zF)(1,[j(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${(0,x.sL)(e.result)}">${(0,h.nS)(e.result)}</span>`,j(n[t].boosterCounts,"ame"),`<span class="sim-points" style="color: ${(0,x.sL)(n[t].result)}">${(0,h.nS)(n[t].result)}</span>`]))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}function U(e){return e.forEach((e=>{e.results.forEach((e=>{H(e.results)}))})),function(){const t=[5,4,3,2,1].map((t=>{return n=t,(0,D.O7)((0,D.zF)(1,e.map((e=>function(e){const t=e.skillName,a=e.results.find((e=>e.level===n))?.results;return null==a?"":function(e){return["<table>",(0,D.O7)((0,D.$Q)(2,`Level ${n} ${t}`)),...e.map((e=>(0,D.O7)((0,D.zF)(1,[j(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${(0,x.sL)(e.result)}">${(0,h.nS)(e.result)}</span>`])))),"</table>"].join("")}(a)}(e)))));var n}));return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}var K=__webpack_require__(414),z=__webpack_require__(872);class G{element;content;constructor(e){this.element=$('<div class="sim-popup"></div>');const t=$('<div class="close-button xUncheck_mix_icn"></div>');t.on("click",(()=>{this.hide()})),this.element.append(t),"string"==typeof e?this.element.append($('<h1 class="caption"></h1>').text(e)):this.element.append(e);const n=$('<div class="content"></div>');this.content=n,this.element.append(n)}show(){this.element.appendTo("#contains_all")}hide(){this.element.detach()}toggle(){0===this.element.parent().length?this.show():this.hide()}setContent(e){"string"==typeof e?this.content.html(e):this.content.empty().append(e)}}async function N(o){if(!(0,O.L)("/leagues-pre-battle.html"))return;await(0,e.Zp)(),function(e){(0,B.rV)(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(o);const r=(0,s.i)();!function(e){const{hero_data:t}=e;(0,_.p6)(t.team)}(o),function(e){const{hero_data:t,opponent_fighter:n}=e,a=g(t,n.player),s=(0,C.R5)();s.leagues=a,(0,C.Lg)(s)}(o),async function(t){const{opponent_fighter:n,localStorageSetItem:a}=t,s=(0,O.P)(),o=n.player.team,r=()=>{a("battle_type","leagues"),a("leagues_id",s),(0,_.EI)({battleType:"leagues",opponentId:s,team:o})};r(),await(0,e.LX)();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(o),r.doSimulateLeague&&(async function(o){const{hero_data:r,opponent_fighter:l}=o,{player:i,opponent:c}=(0,T.P)(r,l.player),{calculateLeaguePointsTable:u}=(0,s.i)(),m=u?"Full":"Standard",d=(0,t.ez)(m,i,c);await(0,e.LX)();const p=new a.u;p.updateAsync(d),p.setTooltip((0,n.n)(i,c)),$(".opponent .icon-area").before(p.getElement().addClass("sim-left"));const _=new K.l;_.updateAsync(d),d.then((e=>{_.setTooltip((0,z.R)(e))})),$(".opponent .icon-area").before(_.getElement().addClass("sim-right"))}(o),r.addBoosterSimulator&&async function(t){const{hero_data:n,opponent_fighter:a}=t,s=n.team,o=a.player.team;await(0,e.LX)();const r=new G("Booster simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let i=!1;l.on("click",(()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await P(s,o);r.setContent(W(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),r.toggle()})),$(".battle_hero .icon-area").before(l)}(o),r.addSkillSimulator&&async function(t){const{hero_data:n,opponent_fighter:a}=t,s=n.team,o=a.player.team;await(0,e.LX)();const r=new G("Skill simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator");let i=!1;l.on("click",(()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await L(s,o);r.setContent(U(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),r.toggle()})),$(".battle_hero .icon-area").before(l)}(o))}async function X(o){if(!(0,O.L)("/pantheon-pre-battle.html"))return;await(0,e.Zp)(),function(e){(0,B.rV)(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(o);const r=(0,s.i)();!function(e){const{hero_data:t,opponent_fighter:n}=e,a=g(t,n.player),s=(0,C.R5)();s.pantheon=a,(0,C.Lg)(s)}(o),async function(t){const{opponent_fighter:n,localStorageSetItem:a}=t,s=(0,O.P)(),o=n.player.team,r=()=>{a("battle_type","pantheon"),a("pantheon_id",s),(0,_.EI)({battleType:"pantheon",opponentId:s,team:o})};r(),await(0,e.LX)();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(o),r.doSimulatePantheon&&(async function(s){const{hero_data:o,opponent_fighter:r}=s,{player:l,opponent:i}=(0,T.P)(o,r.player),c=(0,t.ez)("Chance",l,i);await(0,e.LX)();const u=new a.u;u.updateAsync(c),u.setTooltip((0,n.n)(l,i)),$(".opponent .icon-area").before(u.getElement().addClass("sim-left"))}(o),r.addBoosterSimulator&&async function(n){const{hero_data:a,opponent_fighter:s}=n,o=a.team,r=s.player.team;await(0,e.LX)();const l=new G("Booster simulator"),i=$('<div class="sim-result"><div class="sim-icon-button sim-icon-headband"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let c=!1;i.on("click",(()=>{c||(c=!0,l.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await async function(e,n){const a=(0,p.TJ)();if(null==a)throw new Error("Market data not found");const s=await b(e);if(null==s)throw new Error("Team data not found");return k((async o=>{const r=w(e,s,a,o),l=1+.25*o.mythic;return(0,t.iL)("FastChance",r,n,l)}))}(o,r);l.setContent(function(e){H(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=t.map(((e,t)=>(0,D.O7)((0,D.zF)(1,[j(e.boosterCounts,"headband"),`<span class="sim-chance" style="color: ${(0,x.PB)(e.result)}">${(0,h.HC)(e.result)}</span>`,j(n[t].boosterCounts,"headband"),`<span class="sim-chance" style="color: ${(0,x.PB)(n[t].result)}">${(0,h.HC)(n[t].result)}</span>`]))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(e))}catch(e){const t=e instanceof Error?e.message:e;l.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),l.toggle()})),$(".battle_hero .icon-area").before(i)}(o),r.addSkillSimulator&&async function(n){const{hero_data:a,opponent_fighter:s}=n,o=a.team,r=s.player.team;await(0,e.LX)();const l=new G("Skill simulator"),i=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator");let c=!1;i.on("click",(()=>{c||(c=!0,l.setContent("Now loading..."),queueMicrotask((async()=>{try{const e=await async function(e,n){const a=(0,p.TJ)();if(null==a)throw new Error("Market data not found");const s=await b(e);if(null==s)throw new Error("Team data not found");return S((async(o,r)=>{const l=v(w(e,s,a,o),r),i=1+.25*o.mythic;return(0,t.iL)("FastChance",l,n,i)}))}(o,r);l.setContent(q(e))}catch(e){const t=e instanceof Error?e.message:e;l.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))),l.toggle()})),$(".battle_hero .icon-area").before(i)}(o))}var J=__webpack_require__(473);async function Q(o){if(!(0,O.L)("/season-arena.html"))return;await(0,e.Zp)(),function(e){(0,B.rV)(e);const{hero_data:t,caracs_per_opponent:n,opponents:a}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("caracs_per_opponent is not found.");if(null==a)throw new Error("opponents is not found.")}(o);const{hero_data:r,caracs_per_opponent:l,opponents:i}=o;!function(){const e=i[0].player,t=l[e.id_fighter],n=(0,f.m8)(r.team,e.team),a=Math.round(100*t.damage/r.team.caracs.damage/n),s=(0,C.R5)();s.seasons=a/100,(0,C.Lg)(s)}(),async function(t){const{opponents:n,localStorageSetItem:a}=t,s=()=>{a("battle_type","seasons");const e=$(".selected_opponent").attr("data-opponent");if(null==e)return;const t=n.find((t=>t.player.id_fighter===e));if(null==t)return;const s=t.player.team,o=t.rewards.rewards.find((e=>"victory_points"===e.type))?.value;(0,_.EI)({battleType:"seasons",opponentId:e,team:s,mojo:+(o??0)})};s(),await(0,e.LX)();const o=document.getElementById("change_team");null!=o&&(o.addEventListener("click",s,!0),o.addEventListener("auxclick",s,!0))}(o),(0,s.i)().doSimulateSeason&&async function(){i.forEach((async s=>{const o=s.player,i=o.id_fighter,c={...r,...l[i]},u=(0,T.S)(c,o),m=(0,T.S)(o,c),d=(0,t.ez)("Chance",u,m),p=+s.rewards.rewards.find((e=>"victory_points"===e.type)).value;await(0,e.LX)();const _=new a.u;_.updateAsync(d),_.setTooltip((0,n.n)(u,m));const h=new J.$(p);h.updateAsync(d),$(`[data-opponent="${i}"] .icon-area`).before(_.getElement().addClass("sim-left")).before(h.getElement().addClass("sim-right"))}))}()}const V={MB2:{leagues:1.15,seasons:1.15},MB3:{trolls:1.25,pantheon:1.25},MB8:{leagues:1.15,seasons:1},MB9:{leagues:1,seasons:1.15}};function Z(e){const t=[];let n={};return e.forEach((e=>{const{item:a}=e;switch(a.rarity){case"common":case"rare":case"epic":t.push({addend:(0,o.aO)(a),lifetime:+e.lifetime});break;case"legendary":t.push({multiplier:(0,o.aO)(a),lifetime:+e.lifetime});break;case"mythic":const s=V[a.identifier];null!=s&&(n={...n,...s})}})),{normals:t,mythic:n}}async function Y(t){(0,O.L)("/shop.html")&&(await(0,e.Zp)(),function(e){(0,B.rV)(e);const{equipped_armor:t,equipped_booster:n}=e;if(null==t)throw new Error("equipped_armor is not found.");if(null==n)throw new Error("equipped_booster is not found.")}(t),function(e){const{equipped_booster:t}=e,n=Z(t.normal.concat(t.mythic));n.mythic={leagues:1,seasons:1,trolls:1,pantheon:1,...n.mythic},(0,C.uJ)(n)}(t),function(e){ee(e),te(e);const t=e.Hero,n=t.updates;"function"==typeof n&&(t.updates=function(...t){const a=n(...t);try{ee(e),te(e)}catch(e){}return a})}(t))}function ee(e){const{equipped_armor:t}=e,n=function(e,t){const n=e.infos.class,a=e.infos.harem_endurance,s=i[(n+2)%3],o=i[(n+1)%3],d=i[(n+0)%3],p=e=>e[s],_=e=>e[o]+e[d];return[...Array(5)].map(((n,s)=>{const o=function(e){const t=e.club?.upgrades_data;return c(null==t?{}:l.map((e=>t[e].level/200)))}(e),d=u(o,c(Array(3).fill(.06*s))),h=function(e){const t=e.infos,n=t.level,a=t.class,s=[5,7,9,5,7];return c([n*s[3-a],n*s[4-a],n*s[5-a]])}(e),f=function(e){return c(e.infos)}(e),g=u(h,f),b=u(g,t),y=new m(b).multiply(d).truncate().result(),w=u(t,y);let v=(4*p(g)+t.endurance+a)*(1+d.endurance);v+=4*p(w),v=Math.floor(v);let E=(_(g)/2+t.chance)*(1+d.chance);E+=_(w)/2,E=Math.round(E);const M=u(b,y);M.endurance=v,M.chance=E;const k=(P=M,(0,r.cM)(i,P));var P;return{damage:p(k),defense:.25*_(k),ego:k.endurance,chance:k.chance}}))}(e.Hero,function(e){return Object.values(e).map((e=>c(e.caracs))).reduce(((e,t)=>u(e,t)),c({}))}(t));(0,p.j4)(n)}function te(e){const{equipped_armor:t,Hero:n}=e,a=n.infos.class,s=Object.values(t).map((e=>e.resonance_bonuses?.class)).filter((e=>null!=e)).filter((e=>+e.identifier===a)).reduce(((e,t)=>(e[t.resonance]+=t.bonus,e)),{damage:0,ego:0});(0,p.pc)(new o.TF(s).divide(100).add(1).result())}async function ne(o){(0,O.L)("/teams.html")&&(await(0,e.Zp)(),function(e){(0,B.rV)(e);const{teams_data:t}=e;if(null==t)throw new Error("teams_data is not found.")}(o),(0,s.i)().doSimulateTeams&&async function(o){const{teams_data:r,localStorageGetItem:l}=o,i=(0,B.RF)(o);if(null==i)return;const c=(0,_.e$)()?.mojo,u=l("battle_type"),m=(0,B.UO)(u);if(null==m)return;const d=Object.fromEntries(Object.values(r).filter((e=>null!=e.id_team&&!e.locked)).map((e=>{const n=(0,f.fS)(e,i,m),a=(0,f.fS)(i,e),{calculateLeaguePointsTable:o}=(0,s.i)(),r="leagues"!==u?"Chance":o?"Full":"Standard",l=(0,t.ez)(r,n,a);return[e.id_team,{resultPromise:l,player:n,opponent:a}]})));await(0,e.LX)(),g();const p=new MutationObserver(g),h=document.querySelector(".teams-grid-container");function g(){const e=$(".selected-team").data("idTeam"),t=d[e];if(null==t)return;const{resultPromise:s,player:o,opponent:r}=t,l=$(".team-right-part-container .icon-area"),i=new a.u;if(i.updateAsync(s),i.setTooltip((0,n.n)(o,r)),l.before(i.getElement().addClass("sim-left")),"leagues"===u){const e=new K.l;e.updateAsync(s),s.then((t=>{e.setTooltip((0,z.R)(t))})),l.before(e.getElement().addClass("sim-right"))}if("seasons"===u&&null!=c){const e=new J.$(c);e.updateAsync(s),l.before(e.getElement().addClass("sim-right"))}}null!=h&&p.observe(h,{subtree:!0,attributes:!0,attributeFilter:["class"]})}(o),function(e){const{teams_data:t,localStorageGetItem:n}=e,a=Object.values(t).find((e=>e.selected_for_battle_type.includes("leagues")));if(null!=a&&null!=a.id_team&&null!=a.theme){const e=a;(0,_.p6)(e)}const s=document.getElementById("btn-select-team");s?.addEventListener("click",(()=>{if("leagues"===n("battle_type")){const e=document.querySelector(".selected-team").dataset.teamIndex,n=t[e];if(null!=n&&null!=n.id_team&&null!=n.theme){const e=n;(0,_.p6)(e)}}}),!0)}(o))}let ae=null,se=null;async function oe(){return se??=(async()=>{const{referrer:e}=document;if(["teams.html","leagues-pre-battle.html","league-battle.html"].some((t=>e.includes(t)))){const e=(0,_.UH)();if(null!=e)return e}try{const e=(await async function(){return ae??=(async()=>{const e=await fetch("teams.html"),t=await e.text();return{teams_data:JSON.parse(t.match(/var\s+teams_data\s*=\s*(\{.*?\});/)?.[1])}})(),ae}()).teams_data,t=Object.values(e).find((e=>e.selected_for_battle_type?.includes("leagues")));if(null!=t)return(0,_.p6)(t),t}catch(e){}return(0,_.UH)()})(),se}var re=__webpack_require__(2);let le;class ie{element;selectElement;callbacks=[];constructor(e,t,n){const a=$('<div class="form-control"><div class="select-group"></div></div>'),s=$('<label class="head-group"></label>').attr("for",e).text(t),o=n.map((e=>{const t=$("<option></option>").attr("value",e.value).text(e.label);return e.selected&&t.prop("selected",!0),t})),r=$('<select icon="down-arrow"></select>').attr("name",e).attr("id",e).append(o);r.on("change",(()=>{this.callbacks.forEach((e=>{e(String(r.val()))}))})),a.find(".select-group").append(s).append(r),this.element=a,this.selectElement=r,r.selectric()}onChange(e){this.callbacks.push(e)}getValue(){return String(this.selectElement.val())}getElement(){return this.element}}class ce extends G{fights;booster;output;playerTeam;opponents;currentScore;foughtCounts;cache=new Map;constructor(e,t,n,a){const s=$('<div class="sim-selectors form-wrapper"></div>'),o=new ie("sim-selector-fights","Fights",[{label:"All",value:"all"},{label:"Unfought",value:"unfought",selected:!0}]),r=new ie("sim-selector-booster","Booster",[{label:"All",value:"all",selected:!0},{label:"Boosted",value:"boosted"},{label:"Unboosted",value:"unboosted"}]),l=new ie("sim-selector-output","Output",[{label:"All",value:"all",selected:!0},{label:"Best",value:"best"}]),i=()=>{this.update()};o.onChange(i),r.onChange(i),l.onChange(i),super(s.append(o.getElement(),r.getElement(),l.getElement())),this.fights=o,this.booster=r,this.output=l,this.playerTeam=e,this.opponents=t,this.currentScore=n,this.foughtCounts=a}update(){this.setContent("Now loading..."),queueMicrotask((async()=>{const e=this.fights.getValue(),n=this.booster.getValue(),a=this.output.getValue(),s="unfought"===e;try{let o=this.opponents;s&&(o=o.filter((e=>e.numChallenges>0))),"boosted"===n&&(o=o.filter((e=>e.isBoosted))),"unboosted"===n&&(o=o.filter((e=>!e.isBoosted)));const r=await async function(e,n,a){const s=(0,p.TJ)();if(null==s)throw new Error("Market data not found");const o=await b(e);if(null==o)throw new Error("Team data not found");const r=M();return await Promise.all(r.flatMap((r=>{const l=w(e,o,s,r.counts),i=1+.15*r.counts.mythic;return n.map((async e=>{const n=`${e.id}-${r.key}`;let s=a.get(n);null==s&&(s={boosterKey:r.key,boosterCounts:r.counts,opponentId:e.id,challenges:e.numChallenges,result:(0,t.iL)("FastPoints",l,e.team,i)},a.set(n,s));const o=await s.result;return{...s,result:o}}))})))}(this.playerTeam,o,this.cache),l=(e,t,n)=>{let a=e.get(t);null==a&&(a=[],e.set(t,a)),a.push(n)};if("all"===a){const t=new Map;r.forEach((e=>{l(t,e.boosterKey,e)}));const a=[...t.values()].map((e=>{const t=e[0].boosterCounts,n=s?e.reduce(((e,t)=>e+t.result*t.challenges),0):3*e.reduce(((e,t)=>e+t.result),0),a=s?e.reduce(((e,t)=>e+t.challenges),0):3*e.length;return{boosterCounts:t,sum:n,challenges:a,average:n/a,result:n}}));"unfought"===e&&"all"===n?this.setContent(function(e,t,n){H(e);const a=e.filter((e=>e.boosterCounts.mythic<=0)),s=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=[...Array(Math.max(a.length,s.length))].map(((e,o)=>(0,D.O7)((0,D.zF)(1,[a[o],s[o]].flatMap((e=>{const a=(0,x.sL)(e.average),s=e.sum+t,o=s/(e.challenges+n),r=(0,x.sL)(o);return[j(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${a}">${(0,h.nS)(e.average)}</span>`,"*",`<span>${e.challenges.toFixed()}</span>`,"=",`<span style="color: ${a}">${e.sum.toFixed()}</span>`,"=>",`<span style="color: ${r}">${s.toFixed()}</span>`,`<span style="color: ${r}">(${(0,h.nS)(o)})</span>`]}))))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(a,this.currentScore,this.foughtCounts)):this.setContent(function(e){H(e);const t=e.filter((e=>e.boosterCounts.mythic<=0)),n=e.filter((e=>e.boosterCounts.mythic>0));return function(){const e=[...Array(Math.max(t.length,n.length))].map(((e,a)=>(0,D.O7)((0,D.zF)(1,[t[a],n[a]].flatMap((e=>{const t=(0,x.sL)(e.average);return[j(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${(0,h.nS)(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(a))}if("best"===a){const t=new Map;r.forEach((e=>{l(t,e.opponentId,e)}));const[a,o]=[[...t.values()].map((e=>e.filter((e=>0==e.boosterCounts.mythic)))),[...t.values()]].map((e=>{const t=new Map;e.forEach((e=>{const n=e.reduce(((e,t)=>Math.max(e,t.result)),0);e.filter((e=>e.result>=n)).forEach((e=>{l(t,e.boosterKey,e)}))}));const n=new Set,a=[];let o=[...t.values()];for(;0!==o.length;){const e=o.sort(((e,t)=>e.length-t.length)).pop();if(0===e.length)break;a.push(e),e.forEach((e=>{n.add(e.opponentId)})),o=o.map((e=>e.filter((e=>!n.has(e.opponentId)))))}return a.map((e=>{const t=e[0].boosterCounts,n=s?e.reduce(((e,t)=>e+t.result*t.challenges),0):3*e.reduce(((e,t)=>e+t.result),0),a=s?e.reduce(((e,t)=>e+t.challenges),0):3*e.length;return{boosterCounts:t,sum:n,challenges:a,average:n/a,result:a}}))}));"unfought"===e&&"all"===n?this.setContent(function(e,t,n,a){H(e),H(t);const s=0===a?NaN:n/a,o=0===a?"#FFF":(0,x.sL)(s),r=[e,t].map((e=>{const t=e.reduce(((e,t)=>e+t.sum),0),s=e.reduce(((e,t)=>e+t.challenges),0),o=t/s,r=(0,x.sL)(o),l=t+n,i=l/(s+a);return{sum:t,challenges:s,average:o,color:r,total:l,avgTotal:i,color3:(0,x.sL)(i)}}));return function(){const l=[...Array(Math.max(e.length,t.length))].map(((n,a)=>(0,D.O7)((0,D.zF)(1,[e[a],t[a]].flatMap((e=>{if(null==e)return Array(6).fill("");const t=(0,x.sL)(e.average);return[j(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${(0,h.nS)(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))))));return $('<table class="sim-booster-table"></table>').append((0,D.O7)((0,D.zF)(6,["No AME","All"])),l.join(""),(0,D.O7)((0,D.zF)(1,r.flatMap((e=>["Sum",`<span class="sim-points" style="color: ${e.color}">${(0,h.nS)(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${e.color}">${e.sum.toFixed()}</span>`])))),(0,D.O7)((0,D.zF)(1,r.flatMap((e=>["Current score",`<span style="color: ${o}">${Number.isNaN(s)?"?":(0,h.nS)(s)}</span>`,"*",`<span>${a}</span>`,"=",`<span style="color: ${o}">${n}</span>`])))),(0,D.O7)((0,D.zF)(1,r.flatMap((e=>["Total",`<span style="color: ${e.color3}">${(0,h.nS)(e.avgTotal)}</span>`,"*",`<span>${e.challenges+a}</span>`,"=",`<span style="color: ${e.color3}">${e.total.toFixed()}</span>`]))))).prop("outerHTML")}()}(a,o,this.currentScore,this.foughtCounts)):this.setContent(function(e,t){H(e),H(t);const n=[e,t].map((e=>{const t=e.reduce(((e,t)=>e+t.sum),0),n=e.reduce(((e,t)=>e+t.challenges),0),a=t/n;return{sum:t,challenges:n,average:a,color:(0,x.sL)(a)}}));return function(){const a=[...Array(Math.max(e.length,t.length))].map(((n,a)=>(0,D.O7)((0,D.zF)(1,[e[a],t[a]].flatMap((e=>{if(null==e)return Array(6).fill("");const t=(0,x.sL)(e.average);return[j(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${(0,h.nS)(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))))));return $('<table class="sim-booster-table"></table>').append((0,D.O7)((0,D.zF)(6,["No AME","All"])),a.join(""),(0,D.O7)((0,D.zF)(1,n.flatMap((e=>["Sum:",`<span class="sim-points" style="color: ${e.color}">${(0,h.nS)(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${e.color}">${e.sum.toFixed()}</span>`]))))).prop("outerHTML")}()}(a,o))}}catch(e){const t=e instanceof Error?e.message:e;this.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}}))}show(){this.update(),super.show()}}async function ue(n){if(!(0,O.L)("/tower-of-fame.html"))return;await(0,e.Zp)(),function(e){(0,B.rV)(e);const{opponents_list:t}=e;if(null==t)throw new Error("opponents_list is not found.")}(n);const{opponents_list:a,Hero:o}=n,r=function(e){const{Hero:t,opponents_list:n,server_now_ts:a}=e,s=t.infos.id,o=n.find((e=>+e.player.id_fighter===s));if(null==o)return;const r=o.boosters.filter((e=>+e.lifetime>a||+e.usages_remaining>0)),l=(0,C.mw)(),i=Z(r);return i.mythic={...l.mythic,leagues:1,...i.mythic},(0,C.uJ)(i),i}(n);!async function(n){const l=(0,s.i)();if(!l.doSimulateLeagueTable)return;const i=o.infos.id,c=a.find((e=>+e.player.id_fighter===i));if(null==c)return;const u=r?.mythic.leagues;if(null==u)return;const m=await oe();if(null==m)return;const d=a.filter((e=>+e.player.id_fighter!==i)),p=d.filter((e=>Object.values(e.match_history)[0].filter((e=>null!=e)).length<3)),_=(l.doSimulateFoughtOpponents?d:p).map((e=>(0,t.iL)("Points",m,e.player.team,u).then((t=>[e.player.id_fighter,t])))),f=await Promise.all(_),g=Object.fromEntries(f),b=()=>{a.forEach((e=>{e.power=g[e.player.id_fighter]?.avgPoints??0})),l.replaceHHLeaguesPlusPlus&&a.forEach((e=>{e.sim={...e.sim,forSim:{...e.sim?.forSim,playerTeam:m,opponentTeam:e.player.team,mythicBoosterMultiplier:u}}}))};b();const y=a.reduce(((e,t)=>{const n=Object.values(t.match_history)[0];if(!Array.isArray(n))return e;const a=n.filter((e=>null!=e)),s=a.reduce(((e,t)=>e+parseInt(t.match_points)),0),o=3-a.length;return e+s+t.power*o}),0),w=y/(a.length-1)/3,v=3*f.reduce(((e,t)=>e+t[1].avgPoints),0),E=v/f.length/3;await(0,e.LX)(),$('.league_table .head-column[column="match_history_sorting"] > span').attr("tooltip",`Score expected: <em>${(0,h.v8)(y,1)}</em><br>Average: <em>${(0,h.nS)(w)}</em>`);const M=$('.league_table .head-column[column="power"] > span');M.html(M.html().replace("Power","Sim")),M.attr("tooltip",`Sum: <em>${(0,h.v8)(v,1)}</em><br>Average: <em>${(0,h.nS)(E)}</em>`);const k=d.map((e=>({id:e.player.id_fighter,team:e.player.team,numChallenges:3-Object.values(e.match_history)[0].filter((e=>null!=e)).length,isBoosted:e.boosters.filter((e=>+e.lifetime>n.server_now_ts)).length>0}))),P=+c.player_league_points,S=k.reduce(((e,t)=>e+(3-t.numChallenges)),0),L=new ce(m,k,P,S),T=()=>{const e={};document.querySelectorAll(".data-row.body-row").forEach((t=>{const n=t.querySelector("[id-member]")?.getAttribute("id-member"),a=t.querySelector(".data-column[column=power]");null!=n&&null!=a&&(e[n]??=[],e[n].push(a))})),a.forEach((t=>{let n=$("<div></div>").addClass("sim-column");const a=t.player.id_fighter,s=g[a];if(null!=s){let e="";s.minPoints>=25&&(e='<div class="vCheck_mix_icn sim-mark"></div>'),n.html(`${e}${(0,h.v8)(s.avgPoints,2)}`).css("color",(0,x.sL)(s.avgPoints))}else if(+a===i&&l.addBoosterSimulator&&l.addBoosterSimulatorToLeagueTable){const e=$('<div class="sim-icon-button sim-icon-ame"></div>').attr("tooltip","Booster simulator");e.on("click",(()=>{L.toggle()})),n.append(e)}else n.text("-");$(e[a]).empty().append(n)}))};function C(){(0,re.D)().then((e=>{if(null==e)return;const t=n.opponent_fighter;null!=t?.sim&&(new e.League).display(t.sim)}))}T(),l.replaceHHLeaguesPlusPlus&&C();const O=M[0];null!=O&&new MutationObserver((()=>{b(),T(),l.replaceHHLeaguesPlusPlus&&C()})).observe(O,{childList:!0,subtree:!0});const B=document.querySelector(".league_table .data-list");null!=B&&new MutationObserver((()=>{b(),T()})).observe(B,{childList:!0})}(n),async function(){await(0,e.LX)();const t=document.getElementById("change_team");if(null!=t){const e=()=>{if((0,s.i)().replaceHHLeaguesPlusPlus){const e=le;if(null!=e)return void(0,_.EI)({battleType:"leagues",opponentId:"",team:e})}(0,_.EI)(null)};t.addEventListener("click",e,!0),t.addEventListener("auxclick",e,!0)}}()}!async function(t){await(0,e.Zp)();const{IMAGES_URL:n,SITE_ROOT:a}=window;"string"==typeof n&&(t=t.replaceAll("${IMAGES_URL}",n)),"string"==typeof a&&(t=t.replaceAll("${SITE_ROOT}",a)),$(document.head).append(`<style>${t}</style>`)}(".sim-result{width:max-content;height:0;position:relative;bottom:1.25rem;line-height:1.25rem;text-align:center;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000;z-index:1}.sim-result .sim-label{font-size:.75rem}.sim-result.sim-left{margin-right:60%}.sim-result.sim-right{margin-left:60%}.opponent .sim-result.sim-top{bottom:12rem}#season-arena .sim-result.sim-top{bottom:11.5rem;line-height:1rem}.sim-result.sim-pending{color:#999}.sim-mark{display:inline-block;width:1em;height:1em;margin:-.125em .25em .125em -1.25em;background-size:1em;vertical-align:bottom}table.sim-table{border-collapse:collapse;color:#fff;background-color:#000;font-size:.75rem;line-height:1rem}table.sim-table td{padding:.25rem;border:1px solid #999}table.sim-points-table{border-collapse:collapse;color:#fff;background-color:#000;font-size:.75rem;line-height:1.25rem;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000}table.sim-points-table td{padding:1px .25rem}.sim-points-table .sim-bar-container{width:5rem}.sim-points-table .sim-bar{height:1.25rem;margin-bottom:-1.25rem;background-color:#ccf9}.sim-column{text-align:center;text-wrap:nowrap}.sim-column .sim-mark{margin:.25em 0}.player_team_block{min-width:15rem}.sim-popup{position:absolute;left:0;right:0;top:5rem;z-index:8;margin:auto;width:min-content;height:min-content;color:#fff;background-color:#000;border:.75rem solid #000;border-radius:.5rem;text-align:left}.sim-popup .close-button{position:absolute;right:-.25rem;top:-.25rem;cursor:pointer}.sim-popup .caption{font-size:1rem;line-height:1.5rem;width:max-content;margin:0 3rem .75rem 0}.sim-popup .content{font-size:.75rem;line-height:1.5rem;width:max-content;max-height:27rem;overflow-y:auto}table.sim-booster-table{border-collapse:separate;font-size:.75rem;line-height:1.5rem;width:max-content}table.sim-booster-table td span.sim-chance{margin:0 .5rem}table.sim-booster-table .sim-booster-slot{width:1.5rem;height:1.5rem;border:1px solid #fff}table.sim-booster-table .sim-booster-icon{width:100%;height:100%;background-size:contain}.sim-icon-button{display:block;width:2.5rem;height:2.5rem;background-size:contain;cursor:pointer}.sim-icon-ginseng{background-image:url('${IMAGES_URL}/pictures/items/B1.png')}.sim-icon-jujubes{background-image:url('${IMAGES_URL}/pictures/items/B2.png')}.sim-icon-chlorella{background-image:url('${IMAGES_URL}/pictures/items/B3.png')}.sim-icon-cordyceps{background-image:url('${IMAGES_URL}/pictures/items/B4.png')}.sim-icon-ame{background-image:url('${IMAGES_URL}/pictures/items/MB2.png')}.sim-icon-headband{background-image:url('${IMAGES_URL}/pictures/items/MB3.png')}.sim-icon-girl-skills{background-image:url('${IMAGES_URL}/pictures/design/girl_skills/active_skills_icon.png')}.sim-column .sim-icon-button{margin:-1rem auto}.sim-selectors.form-wrapper{display:flex;margin:-.5rem 3rem 0 0;gap:.5rem;width:min-content}.sim-selectors.form-wrapper>.form-control{width:9rem}.sim-selectors.form-wrapper>.form-control>.select-group .selectric-items{height:auto}.sim-selectors.form-wrapper>.form-control>.select-group .selectric-items li:first-of-type{padding-left:5px}.sim-traits{margin:.5rem .5rem 0 .5rem}.sim-trait-icon{display:inline-block;width:1.75rem;height:1.75rem;background-size:contain;background-position:center}"),async function(){(0,s.T)(),async function(){if(!(0,O.L)("/tower-of-fame.html"))return;const e=await(0,re.D)();if(null==e)return;const o=(0,s.i)();if(!o.replaceHHLeaguesPlusPlus)return;let r,l,i,c=o.doSimulateLeagueTable;const u=e.League;e.League=class{original;constructor(...e){this.original=new u(...e)}extract(){return this.original.extract()}display(e){i=e;let{forSim:u}=e;if(null==u){c||(c=!0,(async()=>{r=await oe(),l=(0,C.R5)().leagues??1;const e=i?.forSim;null!=e&&!0===e.hasAssumptions&&(e.playerTeam=r,e.mythicBoosterMultiplier=l,this.display(i))})());const t=window.hero_data,n=window.opponent_fighter;if(null!=t&&null!=n){const a=r??t.team,s=n.player.team,o=l??1,i=null==a.id_team;u={playerTeam:a,opponentTeam:s,mythicBoosterMultiplier:o,hasAssumptions:i},e.forSim=u}}if(null==u)return this.original.display(e);{let e=u.playerTeam;const i=u.opponentTeam;if(le=i,null==u.result||u.hasAssumptions&&null!=e.id_team){e=r??e;const a=l??u.mythicBoosterMultiplier??1,{player:o,opponent:c}=(0,f.NU)(e,i,a);u.battleTable=(0,n.n)(o,c);const m=null==e.id_team;u.hasAssumptions=m;const{calculateLeaguePointsTable:d}=(0,s.i)(),p=d?"Full":"Standard";u.result=(0,t.ez)(p,o,c).then((e=>({...e,hasAssumptions:m})))}const c=u.result;$(".opponent .icon-area").parent().find(".sim-result").remove();const m=new a.u;m.updateAsync(c),m.setTooltip(u.battleTable),$(".opponent .icon-area").before(m.getElement().addClass("sim-left"));const d=new K.l;if(d.updateAsync(c),c.then((e=>{d.setTooltip((0,z.R)(e))})),$(".opponent .icon-area").before(d.getElement().addClass("sim-right")),null!=e.id_team){if(o.addBoosterSimulator){const t=new G("Booster simulator"),n=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-left").addClass("sim-top").attr("tooltip","Booster simulator");n.on("click",(async()=>{if(t.toggle(),null==u.boosterTable){t.setContent("Now loading..."),null==u.boosterResults&&(u.boosterResults=P(e,i));try{const e=await u.boosterResults;u.boosterTable=W(e)}catch(e){const t=e instanceof Error?e.message:e;u.boosterTable=`Error: ${t}<br>1. Go to the market page<br>2. Try again`}}t.setContent(u.boosterTable)})),$(".opponent .icon-area").before(n)}if(o.addSkillSimulator){const t=new G("Skill simulator"),n=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-right").addClass("sim-top").attr("tooltip","Skill simulator");n.on("click",(async()=>{if(t.toggle(),null==u.skillTable){t.setContent("Now loading..."),null==u.skillResults&&(u.skillResults=L(e,i));try{const e=await u.skillResults;u.skillTable=U(e)}catch(e){const t=e instanceof Error?e.message:e;u.skillTable=`Error: ${t}<br>1. Go to the market page<br>2. Try again`}}t.setContent(u.skillTable)})),$(".opponent .icon-area").before(n)}}}}}}(),[B.iQ,d.r,I,N,X,Q,Y,ne,ue,A].forEach((e=>{queueMicrotask((()=>{e(window)}))})),async function(){await(0,e.LX)();const t=()=>{$(".matchRating").length>0&&$(".sim-result").addClass("sim-top")};t();const n=new MutationObserver(t);document.querySelectorAll(".player_team_block.opponent, .season_arena_opponent_container").forEach((e=>{n.observe(e,{childList:!0,subtree:!0})}))}(),localStorage.removeItem("HHBattleSimulatorLastOpponentId"),localStorage.removeItem("HHBattleSimulatorLastOpponentTeam"),localStorage.removeItem("HHBattleSimulatorPlayerLeaguesTeam"),localStorage.removeItem("HHBattleSimulatorPlayerBoosterBonus")}()})()})();